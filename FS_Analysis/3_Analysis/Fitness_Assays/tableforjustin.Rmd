---
title: "FA_Analyze.rmd"
output:
  html_document:
    df_print: paged
---

***
### Begin Code Blocks:

Prepare the workspace: clean, set options, load packages, load and final formatting on inputs.
```{r, warning = FALSE, message=FALSE}
rm(list = ls()) # clear workspace
knitr::opts_chunk$set(tidy = TRUE, collapse = TRUE) # set global knitr options.
# load required packages --- go through these and remove unused ones!
require(ggplot2); # used for plotting
require(pwr); # used for power analysis
require(lme4); # used for mixed effects models
require(lmerTest); # used to interpret mixed effects models
require(sjPlot); # used to output tables
require(weights); # used for weighted t.test
require(plyr); # used for dataframe manipulation
require(gridExtra) # used for multipanel plotting
require(barnard)
require(GGally)
require(plotly)
require(dplyr)
require(tidyr)
require(ggthemes)
require(gtable)
require(cowplot)
require(MuMIn)
require(simr)
require(scales)
require(viridis)
require(reshape2)
require(grid)
require(gridExtra)
require(remotes)
require(devtools)
devtools::install_github("rogiersbart/RTOOLZ"); require(rtoolz)
options(scipen = 999) # turn off scientific notation
```
<br/><br/>

Initialize helper functions (see links for those found online)
```{r, warning = FALSE, message=FALSE}
# expand_residuals creates a modified histogram of residuals. ------------------
# Each entry in the model output is plotted a number of times equal to its reads.
expand_residuals <- function(model, reads){
  myfr <- NA
  for(i in 1:length(residuals(model))){
    times <- (((reads[i] - min(reads, na.rm = T))/(max(reads) - min(reads)))*1000) + 1 
    myfr <- c(myfr, rep(residuals(model)[i], times = times))
  }
  return(myfr)
}

# log transformation for modeling. ---------------------------------------------
log_transform <- function(myvar){
  myvar <- log(((myvar - min(myvar))/(max(myvar) - min(myvar))) + 1) 
  return(myvar)
}

# weighted.var.se --------------------------------------------------------------
# https://stats.stackexchange.com/questions/25895/computing-standard-error-in-weighted-mean-estimation
weighted.var.se <- function(x, w, na.rm=FALSE)
#  Computes the variance of a weighted mean following Cochran 1977 definition
{
  if (na.rm) { w <- w[i <- !is.na(x)]; x <- x[i] }
  n = length(w)
  xWbar = weighted.mean(x,w,na.rm=na.rm)
  wbar = mean(w)
  out = n/((n-1)*sum(w)^2)*(sum((w*x-wbar*xWbar)^2)-2*xWbar*sum((w-wbar)*(w*x-wbar*xWbar))+xWbar^2*sum((w-wbar)^2))
  return(out)
}

# get legend function found on stack exchange ----------------------------------[FIND LINK]
#   scrapes figure legend for later plotting in multipannel plot
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

# get_se calculates standard error of the mean ---------------------------------
get_se <- function(x){
  tmp <- sd(x, na.rm=TRUE) /  sqrt(length(x[!is.na(x)]))
  return(tmp)
}

# http://www.sthda.com/english/wiki/ggplot2-quick-correlation-matrix-heatmap-r-software-and-data-visualization
# Get lower triangle of the correlation matrix
  get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }
  
# get weighted variance --------------------------------------------------------
# modified from modi package
weighted.var <- function (x, w, na.rm = FALSE) 
{
  if (missing(w)) {
    w <- rep.int(1, length(x))
  }
  else if (length(w) != length(x)) {
    stop("x and w must have the same length")
  }
  # if (min(w) < 0) {
  #   stop("there are negative weights")
  # }
  
  if (is.integer(w)) {
    w <- as.numeric(w)
  }
  if (na.rm) {
    w <- w[obs.ind <- !is.na(x)]
    x <- x[obs.ind]
  }
  w <- w * length(w)/sum(w)
  return(sum(w * (x - weighted.mean(x, w))^2)/(sum(w) - 1))
}

```
<br/><br/>

Set color palette options to be used throughout
```{r}
# Color palettes with implementation information beneath:-----------------------
trichromramp_g_bl_rd <- c("#006600","#ff9999", "#ff6666", "#990000", "#9999ff", "#6666ff", "#000066")
dichrompalette_br_cy <- RColorBrewer::brewer.pal(n = 11, name = "BrBG")[c(11,10,9,8,3,2,1)]
dark2 <- RColorBrewer::brewer.pal(7, "Dark2") # not used currently. good swap for dichrompalette_br_cy and dichrompalette_re_bl when not trying to show ranks

initfitpalette <- trichromramp_g_bl_rd
seventreatspalette <- dichrompalette_br_cy
```
<br/><br/>

Add a field summarizing barcode 1 counts at time final in the ancestral fitness assay*
      *move this block to prev script when time permits.
```{r, warning = FALSE, message=FALSE}
load(file = "myd.Rdata")
myd$bc1cts_f_a <- apply(myd, 1, function(x) weighted.mean(as.numeric(x[c( "bc1cts_f_r1a", "bc1cts_f_r2a", "bc1cts_f_r3a", "bc1cts_f_r4a")]), 
                                                  as.numeric(x[c( "re_f_r1a","re_f_r2a","re_f_r3a","re_f_r4a")]), na.rm = T))
```
<br/><br/>


Determine data ommission criteria and implemen*
      * move this block to prev script when time permits.
```{r, warning = FALSE, message=FALSE}
my <- myd
# view the most sensitive measure -- those barcodes that are actually omit at generation 500 (not present at start of the fit  assay)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 1000000]), breaks = 100)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 1000]), breaks = 100)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 100]), breaks = 100)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 50]), breaks = 100) # lets omit below 15, this look like a natural break -- we will apply this value at 4 timepoints...

# first take a look at how many entries fall w/in each category
# sum(my$bc1cts_i_e <= 15) # entries with generation 500 fitness assay initial counts <= 15 [ANS: 1792 / 7104 (0.2522523)]
# sum(my$bc1cts_f_e <= 15) # "" generation 500 fitness assay final counts "" [ANS: 2605 / 7104 (0.3666948)]
# sum(my$bc1cts_i_a <= 15) # "" generation 0 fitness assay initial counts "" [ANS: 0 / 7104 (0.00)]
# sum(my$bc1cts_f_a <= 15) # "" generation 0 fitness assay final counts "" [ANS: 8 / 7104 (0.001126126)]

my$omit <- FALSE # initially set to false (was T for all < 2 counts originally)
ncounts <- 15
my$omit[my$bc1cts_i_e <= ncounts | my$bc1cts_f_e <= ncounts | my$bc1cts_i_a <= ncounts | my$bc1cts_f_a <= ncounts] <- T # see prev block comments, just assignment here. 
my$fit0[my$bc1cts_i_a <= ncounts | my$bc1cts_f_a <= ncounts] <- NA # NA fit data for the 8 entries that are missing complete data
my$re_fit_a[my$bc1cts_i_a <= ncounts | my$bc1cts_f_a <= ncounts] <- NA
my$fit500[my$omit == T] <- NA # na fit500 data for omits
my$dw[my$omit == T] <- NA # na dw data for omits
my$re_dw[my$omit == T] <- NA
my$re_fit_e[my$omit == T] <- NA
myd <- my
rm(ncounts)
```
<br/><br/>











Visualize Initial (ancestral) fitness in seven environments
```{r}
# BLOCK NOTES ------------------------------------------------------------------
# - initial fitness distribution looks hump-shaped 
# - initial fitness distribution shows positive shift in general -- indicates that the chosen ref happened to be lower in fit than most other bcs in our pop, this is no problem. 
# - Initial fitness distribution shifted as salt stress increases -- indicates increasing discrepency between pop and ref with higher salt concentration (good thing we use delta fitness).
# - Initial fitness distribution shows no shift in COPR (Need to plot salt then copr; uncomment myc line; to see this).
# - Initial fitness hump-shape falls apart in copr 120 which may be too stressfull to accurately assess fitness in. (we will see down the line). 
# 
# - PROBLEMS:
#   - The plot shows very different patterns when you plot salt first and when you plot copr first. may be worth looking at both (I describe above though). 
# ------------------------------------------------------------------------------

my <- myd
# Visualize -------------------------------------------------------------------
myx <- my$fit0 - weighted.mean(my$fit0, my$re_fit_a, na.rm = T) # mean fitness of pop (relative to ref) is 1.030397 before correction.
myr <- my$re_fit_a / mean(my$re_fit_a, na.rm = T) # make biggest weight 1 (ggplot does not auto-do this like the stats models do)
# myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "COPR0.4", "COPR0.8", "COPR1.2", "SALT0.4", "SALT0.8", "SALT1.2")) # plot cm, then copr, then salt data.
myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "SALT0.4", "SALT0.8", "SALT1.2","COPR0.4", "COPR0.8", "COPR1.2" )) # reverse plot order (salt, then copper)
my$myc <- myc
mybinwidth <- 0.0025
mytitle <- NULL
myylab <- "Count"
myxlab <- "Deviation from Mean Ancestral Fitness (Colored by Environment)"
mylegendlab <- "Fitness Assay Environment"
myfillapha <- 0.8
mypalette <- initfitpalette
mytextsize <- 8
myheight <- 7 
mywidth <- 7
mymeanline <-  1 - weighted.mean(my$fit0, my$re_fit_a, na.rm = T)

p <- ggplot(my, aes(x = myx,color = myc, fill = myc, weight = myr)) + 
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = 0.05) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = mypalette, guide = FALSE) + 
  scale_fill_manual(values = mypalette) +
  theme_classic() +
  theme(legend.position = c(0.8,0.6)) +
  labs(fill = mylegendlab) +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab) +
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt"))) +
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt"))) +
  theme(axis.text.y = element_text(size = mytextsize, angle = 0)) +
  theme(axis.text.x = element_text(size = mytextsize, angle = 0)) +
  theme(legend.title = element_text(size = mytextsize, face = "bold")) +
  theme(legend.text = element_text(size = mytextsize))
  # scale_x_continuous(breaks = seq(.75,1.25,by=0.05), # adjust x axis limit and labels if desired.
  #                    labels = c("0.75", "0.8", "0.85", "0.9", "0.95", "1.0","1.05", "1.1","1.15","1.2", "1.25"),
  #                    limits = c(.75, 1.25))+
  # scale_y_continuous(breaks = seq(0, 1000, by = 100), limits = c(0, 700)) # adjust y axis limits & breaks if desired.
p

# figure output ---------------------------------------------------------------
pdf(file = "000_ancfit_cbyenv.pdf", width = mywidth, height = myheight); p; dev.off() # one column wide, equal height

# -----------------------------------------------------------------------------
rm(my, p, mybinwidth, myc, myfillapha, myheight, mypalette, myr, mytextsize, mymeanline,
   mytitle, mywidth, myx, myxlab, myylab)
```
<br/><br/>

RUN A MODEL HERE THAT LOOKS AT FITNESS DIFFERENCES AMONG ANCESTORS (USE SAME SCHEME AS METHODS PAPER!!!)
```{r}


```
<br/><br/>



ASSESS: FITNESS CHANGE IN 500 GENERATIONS OF EVOLUTION ACROSS 7 TREATMENTS IN 4 ENVIRONMENTS AND 2 CHEMICAL STRESSORS* 
Create an appropriate data frame with 1 entry per bcpID (rather than 1 entry per rep*bcpID)
        * move to previous script when time allows.
```{r}
# create the frame, omitting most cols not necessary for these upcoming plots and tests.
my <- myd
my <- my[,c(1:7, 83:88, 112, 123, 126)] # reatain only interst columns #RELACE WITH COLUMN NAMES FOR SAFETY!!!!!
my1 <- my[my$mpar == 1,] # r1
my2 <- my[my$mpar == 2,]; colnames(my2) <- paste0(colnames(my2), "_2") # r2
my3 <- my[my$mpar == 3,]; colnames(my3) <- paste0(colnames(my3), "_3") # r3
my4 <- my[my$mpar == 4,]; colnames(my4) <- paste0(colnames(my4), "_4") # r4
my <- cbind(my1, my2$re_dw_2, my2$dw_2, my3$re_dw_3, my3$dw_3, my4$re_dw_4, my4$dw_4) # zip
colnames(my)[c((ncol(my)-5)):ncol(my)] <- c("re_dw_2", "dw_2", "re_dw_3", "dw_3", "re_dw_4", "dw_4") # name fix
mn_dw <- apply(my, 1, function(x) weighted.mean(as.numeric(x[c( "dw", "dw_2", "dw_3", "dw_4")]), 
                                                  as.numeric(x[c( "re_dw","re_dw_2","re_dw_3","re_dw_4")]), na.rm = T)) # calculate wtd.mean dw across reps
my$mn_dw <- mn_dw; my$mn_dw[is.nan(my$mn_dw)] <- NA # fix nans
my$omit <- F; my$omit[is.na(my$mn_dw)] <- T # update omit field
mn_re_dw <- apply(my, 1, function(x) mean(as.numeric(x[c( "re_dw", "re_dw_2", "re_dw_3", "re_dw_4")]), na.rm =T)) # calculate reads for mn_dw
my$mn_re_dw <- mn_re_dw # assign
mydwc <- my # name frame


# new new new -----------------------------------------------------------------v
# create the frame, omitting most cols not necessary for these upcoming plots and tests.
my <- myd
my <- my[,c(1:7, 83:88, 119, 111, 122, 126)] # reatain only interst columns
my1 <- my[my$mpar == 1,] # r1
my2 <- my[my$mpar == 2,]; colnames(my2) <- paste0(colnames(my2), "_2") # r2
my3 <- my[my$mpar == 3,]; colnames(my3) <- paste0(colnames(my3), "_3") # r3
my4 <- my[my$mpar == 4,]; colnames(my4) <- paste0(colnames(my4), "_4") # r4
my <- cbind(my1, my2$re_fit_e_2, my2$fit500_2, my3$re_fit_e_3, my3$fit500_3, my4$re_fit_e_4, my4$fit500_4) # zip
colnames(my)[c((ncol(my)-5)):ncol(my)] <- c("re_fit500_2", "fit500_2", "re_fit500_3", "fit500_3", "re_fit500_4", "fit500_4") # name fix
mn_fit500 <- apply(my, 1, function(x) weighted.mean(as.numeric(x[c( "fit500", "fit500_2", "fit500_3", "fit500_4")]), 
                                                  as.numeric(x[c( "re_fit_e","re_fit500_2","re_fit500_3","re_fit500_4")]), na.rm = T)) # calculate wtd.mean dw across reps
my$mn_fit500 <- mn_fit500; my$mn_fit500[is.nan(my$mn_fit500)] <- NA # fix nans
my$omit <- F; my$omit[is.na(my$mn_fit500)] <- T # update omit field
mn_re_fit500 <- apply(my, 1, function(x) mean(as.numeric(x[c("re_fit_e","re_fit500_2","re_fit500_3","re_fit500_4")]), na.rm =T)) # calculate reads for mn_dw
my$mn_re_fit500 <- mn_re_fit500 # assign
myfit500c <- my # name frame

# While we are at it lets make a wide version as well, this will be needed later.
my <- myfit500c
my0 <- my[my$mpasp == 0.0,]
my40 <- my[my$mpasp == 0.4,]
my80 <- my[my$mpasp == 0.8,]
my120 <- my[my$mpasp == 1.2,]
sum(my0$bcpID != my40$bcpID)
my <- cbind(my0, my40$fit0, my40$mn_fit500, my40$mn_re_fit500, my80$fit0, my80$mn_fit500, my80$mn_re_fit500, my120$fit0, my120$mn_fit500, my120$mn_re_fit500)
colnames(my)[c(14, 24:34)] <- c("mn_fit0_0", "mn_fit500_0", "mn_re_fit500_0","mn_fit0_40", "mn_fit500_40", "mn_re_fit500_40","mn_fit0_80",  "mn_fit500_80", "mn_re_fit500_80","mn_fit0_120",  "mn_fit500_120", "mn_re_fit500_120")
myfit500cw <- my

# -----------------------------------------------------------------------------^





# While we are at it lets make a wide version as well, this will be needed later.
my <- mydwc
my0 <- my[my$mpasp == 0.0,]
my40 <- my[my$mpasp == 0.4,]
my80 <- my[my$mpasp == 0.8,]
my120 <- my[my$mpasp == 1.2,]
sum(my0$bcpID != my40$bcpID)
my <- cbind(my0, my40$mn_dw, my40$mn_re_dw, my80$mn_dw, my80$mn_re_dw, my120$mn_dw, my120$mn_re_dw)
colnames(my)[c(23:30)] <- c("mn_dw_0", "mn_re_dw_0","mn_dw_40", "mn_re_dw_40", "mn_dw_80", "mn_re_dw_80", "mn_dw_120", "mn_re_dw_120")
mydwcw <- my

# ------------------
rm(my, my1, my2, my3, my4, mn_dw, mn_re_dw, my0, my40, my80, my120)
```
<br/><br/>



Power Analyses
```{r}
# get data and prep for power analysis
my <- myd
my$id <- paste0(my$bc1, my$epo, my$mpasp)

# power to detect treatment differences (LMER model) -----------------------------------------------
# Run model ------------------------------------------------
mymod <- lm(my$dw ~ my$id, weights = my$re_dw)
x <- summary(mymod)

# get effect size ------------------------------------------
# effect size = f2 = 1/(rmse*100)
myrmse <- sqrt(mean(residuals(mymod)^2))*100 # this is the rmse from the model*100 --> effect size of 1 corresonds to an ~2.54% fitness change 
myeffectsize <- 1/myrmse # effect size of 1 is a 2.54% fitnesss change, so for a fitness change of 1.00, expect effect size of 1/myrmse
mypowersize <- (pwr.f2.test(u = 1, v=64-1-1, f2 = myeffectsize, sig.level = 0.05))$power # powersize for plotting below
# cohen.ES(test="f2", "small"); cohen.ES(test="f2", "medium"); cohen.ES(test="f2", "large") # our effect size is LARGE according to cohen. (0.393938869...)
mypowersize <- (pwr.f2.test(u = 1, v=64-1-1, f2 = myeffectsize*0.393, sig.level = 0.05))$power # powersize for plotting below

# prepare plot data ----------------------------------------
mypower <- matrix(nrow=100, ncol = 5); colnames(mypower) <- c("u", "v", "power", "f2", "sig.level")
mypower <- as.data.frame(mypower)
mypower$u <- 1
mypower$v <- c(62, 62*0.9, 62*0.8, 62*0.7, 62*0.6, 62*0.5, 62*0.4, 62*0.3, 62*0.2, 62*0.1) # n - v - u = 64 - 1-1 = 62
mypower$power <- NA
mypower$f2 <- c(rep(myeffectsize*2,10), rep(myeffectsize*1.75,10), rep(myeffectsize*1.5,10),
                rep(myeffectsize*1.25,10), rep(myeffectsize*1,10), rep(myeffectsize*.75,10), 
                rep(myeffectsize*.5,10), rep(myeffectsize*.25,10),  rep(myeffectsize*.1,10),  rep(myeffectsize*.05,10))
mypower$sig.level <- 0.05
mypower$group <- c(rep(1,10), rep(2,10), rep(3,10), rep(4,10), rep(5,10), rep(6,10), rep(7,10), rep(8,10), rep(9,10), rep(10,10))
mypower$group <- as.factor(mypower$group)
for(i in 1:nrow(mypower)){
  pow <- pwr.f2.test(u=mypower$u[i],
                               v=mypower$v[i],
                               f2=mypower$f2[i],
                               sig.level = mypower$sig.level[i])
  mypower$power[i] <- pow$power
}

# Plotting -------------------------------------------------
# plotting setup -----------------------
myheight <- 7
mywidth <- 7

# plot effect size x power -------------
mypower$n <- mypower$v + 2
mypower$n <- factor(mypower$n, levels =c(62+2, (62*0.9)+2, (62*0.8)+2, (62*0.7)+2, (62*0.6)+2, (62*0.5)+2, (62*0.4)+2, (62*0.3)+2, (62*0.2)+2, (62*0.1)+2))
mypower$v <- factor(mypower$v, levels =c(62, 62*0.9, 62*0.8, 62*0.7, 62*0.6, 62*0.5, 62*0.4, 62*0.3, 62*0.2, 62*0.1))

p<-ggplot(mypower, aes(x=f2, y=power, group=n)) +
  geom_vline(xintercept = myeffectsize, linetype = "dashed", color = "darkgray")+
  geom_line(aes(color=n))+
  geom_point(aes(color=n))+
  geom_point(x = myeffectsize, y = mypowersize, pch = 1, size = 5, color = "darkgray")+
  theme_classic()+
  ggtitle("power to detect fitness differences between two treatments \n with n total barcodes")+
  labs(color = "n (total barcodes)")+
  scale_x_continuous(name = "Fitness Difference between Treatments", breaks = c(myeffectsize*0.05, myeffectsize*0.1, myeffectsize*0.25, 
                                                                                myeffectsize*0.5, myeffectsize*0.75, myeffectsize, 
                                                                                myeffectsize*1.25, myeffectsize*1.5, myeffectsize*1.75, myeffectsize*2), 
                     labels = c("0.05%","", "0.25%", "0.5%", "0.75%", "1.0%", "1.25%", "1.5%", "1.75%", "2.0%"))
p
pdf(file = paste("000_FitChangeTreatDif_PowerByRMSE_effectsizexpower.pdf"), width = mywidth, height = myheight); p; dev.off()

# plot n barcodes x power --------------
mypower$n <- as.numeric(levels(mypower$n))[mypower$n]
mypower$f2 <- factor(round(mypower$f2,2), levels = c(sort(unique(round(mypower$f2,2)), decreasing = T)))
p<-ggplot(mypower, aes(x=n, y=power, group=f2)) +
  geom_vline(xintercept = 64, linetype = "dashed", color = "darkgray")+
  geom_line(aes(color=f2))+
  geom_point(aes(color=f2))+
  geom_point(x = 64, y = mypowersize, pch = 1, size = 5, color = "darkgray")+
  theme_classic()+
  scale_x_continuous(name = "n (total barcodes)", breaks = c(8, 16, 24, 32, 40, 48, 56, 64), labels = c(8, 16, 24, 32, 40, 48, 56, 64))+
  scale_color_discrete(name = "Fitness Difference \n between Treatments", labels = rev(c("0.05%","0.1%", "0.25%", "0.5%", "0.75%", "1.0%", "1.25%", "1.5%", "1.75%", "2.0%")))+
  ggtitle("power to detect fitness differences between two treatments \n with n total barcodes")
p
pdf(file = paste("000_FitChangeTreatDif_PowerByRMSE_nxpower.pdf"), width = mywidth, height = myheight); p; dev.off()


# power to detect fitness increase / decrease (t-tests) --------------------------------------------
# d = m1 - m2 / q; m1 is mean group 1, m2 is mean group 2, q is common standard deviation in the two groups
# here m1 is change in fitness and m2 is 0. mean q is used and is the weighted mean of all
# population standard deviation of the four replicate sets in each row of the dataset.

# get data and conduct population sd calculation -----------
my <- mydwc
my$psd_r1 <- (my$dw-my$mn_dw)^2
my$psd_r2 <- (my$dw_2-my$mn_dw)^2
my$psd_r3 <- (my$dw_3-my$mn_dw)^2
my$psd_r4 <- (my$dw_4-my$mn_dw)^2
my$psd_m <- rowMeans(cbind(my$psd_r1, my$psd_r2, my$psd_r3, my$psd_r4), na.rm = T)
my$psd <- sqrt(my$psd_m)
psd <- weighted.mean(my$psd, my$mn_re_dw, na.rm = T)

# prepare plot data ----------------------------------------
mypower <- matrix(nrow=22*3, ncol = 5); colnames(mypower) <- c("fitchange", "psd", "n", "power", "sig.level")
mypower <- as.data.frame(mypower)
mypower$fitchange <- c(0.0025, 0.005, 0.01, 0.015, 0.02, 0.025, 0.03, 0.035, 0.04, 0.045, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.12, 0.14, 0.16, 0.18, 0.20, 0.22)
mypower$psd <- psd
mypower$n <- c(rep(2,22), rep(3,22), rep(4,22))
mypower$power <- NA
mypower$sig.level <- 0.05
mypower$group <- c(rep(1,22), rep(2,22), rep(3,22))
mypower$group <- as.factor(mypower$group)
for(i in 1:nrow(mypower)){
  pow <- pwr.t.test(d=mypower$fitchange[i] / mypower$psd[i],
                               n=mypower$n[i],
                               sig.level = mypower$sig.level[i])
  mypower$power[i] <- pow$power
}
pwr.t.test(d= 0.025 / psd, n=4, sig.level = 0.05)

# Plotting -------------------------------------------------
# plot effect size x power -------------
mypower$n <- factor(mypower$n, levels = c(4,3,2))
p<-ggplot(mypower, aes(x=fitchange, y=power, group=n)) +
  geom_vline(xintercept = 0.01, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.025, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "gray")+
  geom_line(aes(color=n))+
  geom_point(aes(color=n))+
  geom_point(x = 0.01, y = pwr.t.test(d = 0.01 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.025, y = pwr.t.test(d = 0.025 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.05, y = pwr.t.test(d = 0.05 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.1, y = pwr.t.test(d = 0.1 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  scale_x_continuous(name = "Fitness Change", breaks = c(0.01, 0.025, 0.05, 0.1, 0.15, 0.2), labels = c("1%", "2.5%", "5%", "10%", "15%", "20%"))+
  labs(color = "n (replicates \n per timepoint)")+
  theme_classic()+
  ggtitle("power to detect fitness change in 500 generations with n entries per timepoint")
p

pp<-ggplot(mypower, aes(x=fitchange, y=power, group=n)) +
  geom_vline(xintercept = 0.01, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.025, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "gray")+
  geom_line(aes(color=n))+
  geom_point(aes(color=n))+
  geom_point(x = 0.01, y = pwr.t.test(d = 0.01 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.025, y = pwr.t.test(d = 0.025 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.05, y = pwr.t.test(d = 0.05 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.1, y = pwr.t.test(d = 0.1 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  ggtitle(NULL)+ xlab(NULL)+ ylab(NULL)+
  theme_classic()+
  theme(legend.position = "none")+
  scale_x_continuous(limits = c(0, 0.05), breaks = c(0.01, 0.025, 0.05), labels = c("1%", "2.5%", "5%"))+
  theme(plot.background = element_rect(colour = "black"))
pp

ppp <- p + annotation_custom(ggplotGrob(pp), xmin = 0.125, xmax = .225, ymin = 0.025, ymax = 0.5)
ppp
pdf(file = paste("000_FitChangeIncDec_PowerByRMSE_effectsizexpower.pdf"), width = mywidth, height = myheight); ppp; dev.off()


# plot n replicates x power -------------
mypower$n <- as.numeric(levels(mypower$n))[mypower$n]
mypower$fitchange <- factor(mypower$fitchange, levels = c(sort(unique(mypower$fitchange), decreasing = T)))
p<-ggplot(mypower, aes(x=n, y=power, group=fitchange)) +
  geom_line(aes(color=fitchange))+
  geom_point(aes(color=fitchange))+
  scale_x_continuous(name = "n (replicates per timepoint)", breaks = c(2, 3, 4), labels = c(2, 3, 4))+
  theme_classic()+
  ggtitle("power to detect fitness change in 500 generations with n entries per timepoint")+
  scale_color_discrete(name = "Fitness Change", labels = rev(c("0.25%", "0.5%", "1%", "1.5%", "2%", "2.5%", "3%", "3.5%",
                                                               "4%", "45%", "5%", "6%", "7%", "8%", "9%", "10%", "12%", 
                                                               "14%", "16%", "18%", "20%", "22%")))
p
pdf(file = paste("000_FitChangeIncDec_PowerByRMSE_nxpower.pdf"), width = mywidth, height = myheight); p; dev.off()

rm(mymod, mypower, p, pow, pp, ppp, x, i, myeffectsize, myheight, mypowersize, myrmse, mywidth, psd)
```


FITNESS CORRELATION BETWEEN ENVIRONMENTS TEST
```{r}
mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$mn_re_dw_0_80 <- rowMeans(cbind(mydata$mn_re_dw_0, mydata$mn_re_dw_80), na.rm = T)
mydata$mn_re_dw_0_80[is.nan(mydata$mn_re_dw_0_80)] <- NA

mydata$mn_re_dw_0_40 <- rowMeans(cbind(mydata$mn_re_dw_0, mydata$mn_re_dw_40), na.rm = T)
mydata$mn_re_dw_0_40[is.nan(mydata$mn_re_dw_0_40)] <- NA

mydata$mn_re_dw_40_80 <- rowMeans(cbind(mydata$mn_re_dw_40, mydata$mn_re_dw_80), na.rm = T)
mydata$mn_re_dw_40_80[is.nan(mydata$mn_re_dw_40_80)] <- NA

# all data together
mytemp <- cor.test(mydata$mn_dw_0, mydata$mn_dw_80);mytemp # overall correlation between envs. 0 and 80 isn egative (-0.29)
mytempw <- wtd.cor(mydata$mn_dw_0, mydata$mn_dw_80, weight = mydata$mn_re_dw_0_80);mytempw # (-0.35)

# constant lines
myg <- c("EH0", "EH40", "EH80")
mytemp <- cor.test(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg]);mytemp # -0.39
mytempw <- wtd.cor(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg], weight = mydata$mn_re_dw_0_80[mydata$treat %in% myg]);mytempw # -0.48

# flux lines
myg <- c("EH0_40", "EH20_60", "EH0_80", "EH40_80")
mytemp <- cor.test(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg]);mytemp # -0.12
mytempw <- wtd.cor(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg], weight = mydata$mn_re_dw_0_80[mydata$treat %in% myg]);mytempw # -0.124

rm(myg, mytemp, mytempw)
```

MN VS VAR FITNESS (2 ENVIRONMENT) -- FITNESS CHANGE (DW) -- ARITHMETIC ONLY! --
```{r}

mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0, mydata$mn_dw_80), na.rm = F)
# mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
#                                                   w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps



mydata$var_dw_0_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), na.rm = F))
# mydata$var_dw_0_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
#                                                   w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


# viz -- all 0_80-----------------------
# weighted -------------------
mypalette <- dichrompalette_br_cy
mydata$mn_dw_0_80s <- scale(mydata$mn_dw_0_80, center = F); mydata$var_dw_0_80s <- scale(mydata$var_dw_0_80, center = F)
p <- ggplot(mydata, aes(x=mn_dw_0_80s, y=var_dw_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("(ARITHMETIC) Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3.5), color = "gray75", label = "1:1")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("0000_Arith_mean_vs_var.pdf"),height = 8.5, width = 11); grid::grid.draw(x); dev.off()


```

MN VS VAR FITNESS (2 ENVIRONMENT) -- FITNESS CHANGE (DW) -- ARITHMETIC & GEOMETRIC --
```{r}

mydata <- myfit500cw[myfit500cw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
mydata$mn_fit500_0_80uw <- rowMeans(cbind(mydata$mn_fit500_0, mydata$mn_fit500_80), na.rm = F)
# mydata$mn_fit500_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_fit500_0", "mn_fit500_80")]),
#                                                   w=as.numeric(x[c( "mn_re_fit500_0", "mn_re_fit500_80")]), na.rm = F))


#mydata$mn_fit500_0_80uwg <- apply(mydata, 1, function(x) psych::geometric.mean(x=as.numeric(x[c( "mn_fit500_0", "mn_fit500_80")]), na.rm = F)) # This function doesnt properly handle NAs..........I wrote a fix
mydata$mn_fit500_0_80uwg <- NA
for (i in 1:nrow(mydata)) {
  if(!is.na(mydata$mn_fit500_0)[i] & !is.na(mydata$mn_fit500_80)[i]){
      mydata$mn_fit500_0_80uwg[i] <- psych::geometric.mean(c(mydata$mn_fit500_0[i], mydata$mn_fit500_80[i]))
  } else {
       mydata$mn_fit500_0_80uwg[i] <- NA
  }
  
}
# cbind(mydata$mn_fit500_0_80uw, mydata$mn_fit500_0_80uwg ) # check that NA's are being handled properly. 


# mydata$mn_re_fit500_0_geomean <- scale(mydata$mn_re_fit500_0, center = F); mydata$mn_re_fit500_80_geomean <- scale(mydata$mn_re_fit500_80, center = F);
# mydata$mn_fit500_0_80g <- apply(mydata, 1, function(x) weighted.geomean(x=as.numeric(x[c( "mn_fit500_0", "mn_fit500_80")]),
#                                                   w=as.numeric(x[c( "mn_re_fit500_0_geomean", "mn_re_fit500_80_geomean")]), na.rm = F))


mydata$var_fit500_0_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_fit500_0", "mn_fit500_80")]), na.rm = F))
# mydata$var_fit500_0_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_fit500_0", "mn_fit500_80")]), 
#                                                   w=as.numeric(x[c( "mn_re_fit500_0", "mn_re_fit500_80")]), na.rm = F)) # calculate wtd.var dw across reps


# viz -- all 0_80-----------------------
mypalette <- dichrompalette_br_cy
mydata$mn_fit500_0_80s <- scale(mydata$mn_fit500_0_80uw, center = T); mydata$var_fit500_0_80s <- scale(mydata$var_fit500_0_80uw, center = T)
p <- ggplot(mydata, aes(x=mn_fit500_0_80s, y=var_fit500_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope =1, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("(ARITHMETIC) Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3), color = "gray75", label = "1:1")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)



mydata2 <- mydata
mypalette <- dichrompalette_br_cy
mydata2$mn_fit500_0_80gs <- scale(mydata2$mn_fit500_0_80uwg, center = T); mydata2$var_fit500_0_80s <- scale(mydata2$var_fit500_0_80uw, center = T)
p <- ggplot(mydata2, aes(x=mn_fit500_0_80gs, y=var_fit500_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope =1, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("(GEOMETRIC) Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p3 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p4 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3), color = "gray75", label = "1:1")
y <- grid.arrange(p4, p3, widths = c(1,2))
grid::grid.draw(y)

lay <- as.matrix(rbind(c(1,2,2),c(3,4,4)))
z <- grid.arrange(p2, p1, p4, p3, layout_matrix = lay)
pdf(file = paste("0000_Arith_v_geo_mean_var.pdf"),height = 8.5, width = 11); grid::grid.draw(z); dev.off()
rm(mydata2)
```


MN FITNESS (2 ENVIRONMENT) -- ARITHMETIC &&&&& GEOMETRIC 
```{r}

# viz -- all 0_80-----------------------
# unweighted -------------------
mypalette <- dichrompalette_br_cy
mymod <- glm(mydata$mn_fit500_0_80uwg ~ mydata$mn_fit500_0_80uw)
p <- ggplot(mydata) + 
  # geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_smooth(method='lm', aes(x=mydata$mn_fit500_0_80uw, y=mydata$mn_fit500_0_80uwg), formula= y ~ x,  inherit.aes = F,color = "black")+
  geom_point( aes(x=mn_fit500_0_80uw, y=mn_fit500_0_80uwg, color = Treatment, fill = Treatment), size = 2.5, alpha = 0.5) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  coord_equal()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("ARITHMETIC Mean Fitness: CM, 80% Stress")+
  ylab("GEOMETRIC Mean Fitness: CM, 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") +
  geom_text(aes(x=1,y=1.2), color = "black", label = paste0("y = ",round(mymod$coefficients[2], 3), "x + ", round(mymod$coefficients[1], 3)))
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("0000_Arith_v_geo_mean_glm.pdf"),height = 6, width = 14); grid::grid.draw(x); dev.off()


# unweighted
mypalette <- dichrompalette_br_cy
myx <- mydata$Treatment
myy <- mydata$mn_fit500_0_80uw
myc <- mydata$Treatment
mytitle <- ""
myxlab <- "Treatment"
myylab <- "Arithmetic Mean Fitness in 00, 80"
myoutline <-  "grey20"
myfill <-  "grey90"
myptalpha <- 1
mymeanptsize <- 1
myptsize <- 0.1
myrugalpha <- 0.7
mywtmeanptcol <- "black"

p1 <- ggplot(mydata, aes(x=myx, y=myy, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "l" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = myptalpha) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 1, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))+
  ylim(0.9, 1.25)
p1


mydata2 <- mydata
myy2 <- mydata2$mn_fit500_0_80uwg
myylab <- "Geometric Mean Fitness in CM, 80% Stress"

p2 <- ggplot(mydata2, aes(x=myx, y=myy2, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy2), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "l" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = myptalpha) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 1, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))+
  ylim(0.9, 1.25)
p2


mydata3 <- mydata
myy3 <-  mydata3$mn_fit500_0_80uw - mydata3$mn_fit500_0_80uwg
myylab <- "Arithmetic minus Geometric Mean Fitness in CM, 80% Stress"

p3 <- ggplot(mydata3, aes(x=myx, y=myy3, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy3), trim = T) +
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "l" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = myptalpha) +
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  scale_color_manual(values =mypalette) +
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))
p3
x <- grid.arrange(p1, p2, p3, layout_matrix = as.matrix(rbind(c(1), c(2), c(3))))

grid::grid.draw(x)
pdf(file = paste("0000_Arith_v_geo_mean_violins.pdf"),height = 9, width = 6); grid::grid.draw(x); dev.off()
rm(mydata2, mydata3)

```


MN VS VAR FITNESS (2 ENVIRONMENT) tables. -- REPLACE WITH UNWEIGHTED GEOMEAN ONLY!
```{r}


mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0, mydata$mn_dw_80), na.rm = F)
mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


mydata$mn_dw_0_40uw <- rowMeans(cbind(mydata$mn_dw_0, mydata$mn_dw_40), na.rm = F)
mydata$mn_dw_0_40 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0", "mn_dw_40")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_40")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$mn_dw_40_80uw <- rowMeans(cbind(mydata$mn_dw_40, mydata$mn_dw_80), na.rm = F)
mydata$mn_dw_40_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_40", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_40", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


mydata$var_dw_0_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), na.rm = F))
mydata$var_dw_0_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$var_dw_0_40uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_40")]), na.rm = F))
mydata$var_dw_0_40 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_40")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_40")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$var_dw_40_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_40", "mn_dw_80")]), na.rm = F))
mydata$var_dw_40_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_40", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_40", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


# create a summary table by treatment ----------------------
# weighted -------------------
x <- c(); u <- c()
y <- c(); v <- c()
z <- c(); w <- c()
for (i in c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) {
  mytemp <- mean(mydata$mn_dw_0_80[mydata$Treatment == i], na.rm = T)
  x <- c(x, mytemp)
  mytemp <- var(mydata$mn_dw_0_80[mydata$Treatment == i], na.rm = T)
  u <- c(u, mytemp)
  
  mytemp <- mean(mydata$mn_dw_0_40[mydata$Treatment == i], na.rm = T)
  y <- c(y, mytemp)
  mytemp <- var(mydata$mn_dw_0_40[mydata$Treatment == i], na.rm = T)
  v <- c(v, mytemp)
  
  mytemp <- mean(mydata$mn_dw_40_80[mydata$Treatment == i], na.rm = T)
  z <- c(z, mytemp)
  mytemp <- var(mydata$mn_dw_40_80[mydata$Treatment == i], na.rm = T)
  w <- c(w, mytemp)
}

xuyvzw <- cbind(as.matrix(x), as.matrix(u), as.matrix(y), as.matrix(v), as.matrix(z), as.matrix(w))
colnames(xuyvzw) <- c("mn 0,80", "var 0,80", "mn 0,40", "var 0,40", "mn 40,80", "var 40,80")
rownames(xuyvzw) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
# xuyvzw
write.csv(xuyvzw, file = "000_SALT_MN_VS_VAR_TARTREATSw_TABLE.csv")

# unweighted -----------------
x <- c(); u <- c()
y <- c(); v <- c()
z <- c(); w <- c()
for (i in c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) {
  mytemp <- mean(mydata$mn_dw_0_80uw[mydata$Treatment == i], na.rm = T)
  x <- c(x, mytemp)
  mytemp <- var(mydata$mn_dw_0_80uw[mydata$Treatment == i], na.rm = T)
  u <- c(u, mytemp)
  
  mytemp <- mean(mydata$mn_dw_0_40uw[mydata$Treatment == i], na.rm = T)
  y <- c(y, mytemp)
  mytemp <- var(mydata$mn_dw_0_40uw[mydata$Treatment == i], na.rm = T)
  v <- c(v, mytemp)
  
  mytemp <- mean(mydata$mn_dw_40_80uw[mydata$Treatment == i], na.rm = T)
  z <- c(z, mytemp)
  mytemp <- var(mydata$mn_dw_40_80uw[mydata$Treatment == i], na.rm = T)
  w <- c(w, mytemp)
}

xuyvzwuw <- cbind(as.matrix(x), as.matrix(u), as.matrix(y), as.matrix(v), as.matrix(z), as.matrix(w))
colnames(xuyvzwuw) <- c("mn 0,80", "var 0,80", "mn 0,40", "var 0,40", "mn 40,80", "var 40,80")
rownames(xuyvzwuw) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
# xuyvzwuw
write.csv(xuyvzwuw, file = "000_SALT_MN_VS_VAR_TARTREATSuw_TABLE.csv")
```


VECTOR FITNESS
```{r}
# for SALT  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1)

# all treats together in 0 and 80 ------------------------------------------------------------------
my$Fitness_in_CM <- my$mn_dw_0
my$Fitness_in_High_Stress <- my$mn_dw_80
mypalette <- dichrompalette_br_cy
p <- ggplot(my, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my$Fitness_in_CM, yend=my$Fitness_in_High_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in CM (No Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  geom_rug()
p1 <- p + facet_wrap(~Treatment, nrow = 2) + theme(axis.text.x = element_text(size = 6, angle = 45, vjust = 0.5)) + ylab("")
p2 <- p + theme(legend.position = "none")

x <- grid.arrange(p2, p1,
             widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_SALT_VectorFitness_00_80_ALLTREAT.pdf"),height = 8.5, width = 11); grid::grid.draw(x); dev.off()


# target treats in target envs ------------------------------------------------------------------
my$Fitness_in_CM <- my$mn_dw_0
my$Fitness_in_High_Stress <- my$mn_dw_80
mypalette <- dichrompalette_br_cy[c(1,5,7)]
p <- ggplot(my[my$Treatment %in% c("EH0", "EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my[my$Treatment %in% c("EH0", "EH0_80", "EH80"),]$Fitness_in_CM, 
                             yend=my[my$Treatment %in% c("EH0", "EH0_80", "EH80"),]$Fitness_in_High_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in CM (No Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  xlim( min(c(my$mn_dw_0, my$mn_dw_40), na.rm = T), max(c(my$mn_dw_0, my$mn_dw_40), na.rm = T))+
  ylim( min(c(my$mn_dw_40, my$mn_dw_80), na.rm = T), max(c(my$mn_dw_40, my$mn_dw_80), na.rm = T))+
  geom_rug()
p
p1 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none")

my$Fitness_in_CM <- my$mn_dw_0
my$Fitness_in_Low_Stress <- my$mn_dw_40
mypalette <- dichrompalette_br_cy[c(1,2,3)]
p <- ggplot(my[my$Treatment %in% c("EH0", "EH0_40", "EH40"),], aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my[my$Treatment %in% c("EH0", "EH0_40", "EH40"),]$Fitness_in_CM, 
                             yend=my[my$Treatment %in% c("EH0", "EH0_40", "EH40"),]$Fitness_in_Low_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in CM (No Stress)")+
  ylab("Fitness in 40% Stress")+
  coord_equal()+
  xlim( min(c(my$mn_dw_0, my$mn_dw_40), na.rm = T), max(c(my$mn_dw_0, my$mn_dw_40), na.rm = T))+
  ylim( min(c(my$mn_dw_40, my$mn_dw_80), na.rm = T), max(c(my$mn_dw_40, my$mn_dw_80), na.rm = T))+
  geom_rug()
p3 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p4 <- p + theme(legend.position = "none")

my$Fitness_in_Low_Stress <- my$mn_dw_40
my$Fitness_in_High_Stress <- my$mn_dw_80
mypalette <- dichrompalette_br_cy[c(3,6,7)]
p <- ggplot(my[my$Treatment %in% c("EH40", "EH40_80", "EH80"),], aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my[my$Treatment %in% c("EH40", "EH40_80", "EH80"),]$Fitness_in_Low_Stress, 
                             yend=my[my$Treatment %in% c("EH40", "EH40_80", "EH80"),]$Fitness_in_High_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in 40% Stress")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  xlim( min(c(my$mn_dw_0, my$mn_dw_40), na.rm = T), max(c(my$mn_dw_0, my$mn_dw_40), na.rm = T))+
  ylim( min(c(my$mn_dw_40, my$mn_dw_80), na.rm = T), max(c(my$mn_dw_40, my$mn_dw_80), na.rm = T))+
  geom_rug()
p5 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p6 <- p + theme(legend.position = "none")

x <- grid.arrange(p2, p1, p4, p3, p6, p5, widths = c(1,2))
grid::grid.draw(x)

pdf(file = paste("000_SALT_VectorFitness_TARTREATs.pdf"),height = 18, width = 9); grid::grid.draw(x); dev.off()
```






Kassen Plot -- geometric???? all treats 0, 80 -- shifted down!
```{r}
# get the data ---------------------------------------------
my <- myfit500cw[mydwcw$epo %in% c("SALT_A", "SALT_B"),] # ; my <- myfit500cw[mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

# calculate fitness for dimensions x and y, correcting for initial barcode fitness deviation -----
my$Fitness_in_envX <- my$mn_fit500_0 
my$Fitness_in_envY <- my$mn_fit500_80 
my$fit0dev_X <- my$mn_fit0_0 - 1 
my$fit0dev_Y <- my$mn_fit0_80 - 1
my$Fitness_in_envX <- my$Fitness_in_envX - my$fit0dev_X
my$Fitness_in_envY <- my$Fitness_in_envY - my$fit0dev_Y

# prep the data --------------------------------------------
my <- my[!is.na(my$Fitness_in_envX) & !is.na(my$Fitness_in_envY) & my$Treatment %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),] # remove NA entries
myp <- my # leave the "my" dataframe alone, and work on a plotting frame that will be used for just this plot
myp$cutoff <- NA; myp$cutoff_elip <- NA; myp$md <- NA 
# calculate the 2-d outlier cutoff for plotting points (alpha) and the 2-d outlier cutoff for plotting ellipses (alpha_elip) by treatment. 
for (i in  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) { 
  
  alpha <- 0.00
  alpha_elip <- 0.05
  myt <- myp[myp$Treatment == i,]
  md <- mahalanobis(x = myt[, c("Fitness_in_envX", "Fitness_in_envY")], 
                  center = colMeans(myt[, c("Fitness_in_envX", "Fitness_in_envY")]), 
                  cov = cov(myt[, c("Fitness_in_envX", "Fitness_in_envY")]))
  myp[myp$Treatment == i,]$md <- md
  
  cutoff <- (qchisq(p = 1 - alpha, df = ncol(myp[myp$Treatment == i,][, c("Fitness_in_envX", "Fitness_in_envY")])))
  cutoff_elip <- (qchisq(p = 1 - alpha_elip, df = ncol(myp[myp$Treatment == i,][, c("Fitness_in_envX", "Fitness_in_envY")])))

  myp[myp$Treatment == i,]$cutoff <- cutoff
  myp[myp$Treatment == i,]$cutoff_elip <- cutoff_elip

}

# view all points and ommited points for each category. 
plot(myp$Fitness_in_envY ~ myp$Fitness_in_envX)
points(myp[myp$md >= myp$cutoff,]$Fitness_in_envY ~ myp[myp$md >= myp$cutoff,]$Fitness_in_envX, col = "red")
points(myp[myp$md >= myp$cutoff_elip,]$Fitness_in_envY ~ myp[myp$md >= myp$cutoff_elip,]$Fitness_in_envX, col = "blue")

myp <- myp[myp$md < myp$cutoff,] # remove 2d outliers from the dataset based on alpha value

geomeans <- aggregate(cbind(myp$Fitness_in_envX, myp$Fitness_in_envY)~myp$Treatment,myp,psych::geometric.mean) # create dataframe for treatment geomtric mean fitness values.
colnames(geomeans) <-  c("Treatment","Fitness_in_envX", "Fitness_in_envY")

mypc_elip <- myp[myp$md < myp$cutoff_elip,] # create a dataframe for the elipses, removing points based on the alpha_elip value

# append some additional columns of interest (to be used in later plots!)
myp$cm1 <- myp$Fitness_in_envX
myp$st1 <- myp$Fitness_in_envY
myp$cm1_st1 <- (myp$Fitness_in_envX * myp$Fitness_in_envY)^(1/2)
myp$cm2_st1 <- (myp$Fitness_in_envX^2 * myp$Fitness_in_envY)^(1/3)
myp$cm4_st1 <- (myp$Fitness_in_envX^4 * myp$Fitness_in_envY)^(1/5)
myp$cm9_st1 <- (myp$Fitness_in_envX^9 * myp$Fitness_in_envY)^(1/10)
myp$cm1_st2 <- (myp$Fitness_in_envX * myp$Fitness_in_envY^2)^(1/3)
myp$cm1_st4 <- (myp$Fitness_in_envX * myp$Fitness_in_envY^4)^(1/5)
myp$cm1_st9 <- (myp$Fitness_in_envX * myp$Fitness_in_envY^9)^(1/10)

# create a matrix of the geometric fitness surface (used for plotting) -----
geomfit <- matrix(nrow= 500, ncol = 500)
x <- seq(from = min(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T),to = max(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T), length.out = 500)
y <- seq(from = min(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T),to = max(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T), length.out = 500)
colnames(geomfit) <- x
rownames(geomfit) <- y
for (i in 1:nrow(geomfit)) {
  for (j in 1:ncol(geomfit)) {
    geomfit[i,j] <- (as.numeric(colnames(geomfit)[j]) * as.numeric(rownames(geomfit)[i]))^(0.5)
  }
}
geomfithold <- geomfit
geomfit <- round(geomfit, digits = 4)
geomfit <- melt(geomfit)
colnames(geomfit) <- c("geomfitx", "geomfity", "geomfitfit")


# Create the Kassen Plot -----------------------------------
mypalette <- dichrompalette_br_cy
p1 <- ggplot()+
  geom_vline(xintercept=1, color = "darkgray")+
  geom_hline(yintercept = 1, color = "darkgray")+
  xlim( min(c(myp$Fitness_in_envX), na.rm = T) - 0.05, max(c(myp$Fitness_in_envX), na.rm = T) + 0.05)+
  ylim( min(c(myp$Fitness_in_envY), na.rm = T) - 0.05, max(c(myp$Fitness_in_envY), na.rm = T) + 0.05)+
  geom_line(data = geomfit[geomfit$geomfitfit == 1,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.05,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.1,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.15,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.2,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  annotate("text", x = c(0.95, 0.95, 0.95, 0.95, 1.05), y = c(1.025, 1.125, 1.24, 1.35, 1.35), label = c("w = 1", "w = 1.05", "w = 1.1", "w = 1.15", "w = 1.2"))+
  stat_ellipse(data = mypc_elip[mypc_elip$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, fill = Treatment, color = Treatment), alpha = 0.1, geom = "polygon", linetype = 2, show.legend = F)+
  geom_point(data = myp[myp$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, color = Treatment), size = 2.5, alpha = 0.35, show.legend = T) +
  geom_point(data = myp[myp$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, color = Treatment), shape = 1, size = 2.5, alpha = 0.7, show.legend = F)+
  geom_segment(mapping = aes(x=geomeans[1,2], y=geomeans[1,3], xend=geomeans[7,2], yend=geomeans[7,3]), linetype=1, size=1.5, inherit.aes=F)+
  geom_segment(mapping = aes(x=geomeans[3,2], y=geomeans[3,3], xend=geomeans[7,2], yend=geomeans[7,3]), linetype=1, size=1.5, inherit.aes=F)+
  geom_segment(mapping = aes(x=geomeans[1,2], y=geomeans[1,3], xend=geomeans[3,2], yend=geomeans[3,3]), linetype=1, size=1.5, inherit.aes=F)+
  geom_point(data=geomeans, aes(x=Fitness_in_envX, y=Fitness_in_envY, fill = geomeans$Treatment),color = "black", cex = 7.5, shape = 21)+
  theme_bw()+
  xlab("Fitness in CM (0% Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  geom_rug(data = myp[myp$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, color = Treatment))+
  scale_color_manual(values = mypalette)+
  scale_fill_manual(values = mypalette)
p1
getwd()
pdf(file = paste("000_SALT_KASSEN_0_80_wlines_alltreats.pdf"),height = 17, width = 11); grid::grid.draw(p1); dev.off()


p <- ggplot()+
  geom_density(data = myp, aes(x=cm1_st1, group = Treatment, color = Treatment), trim = T) + scale_color_manual(values = mypalette)
p
```










Create some violins for the 00, 80 dataset in the previous block (USE DATESET FROM BLOCK ABOVE!!!)
```{r}

mymin <- min(c(myp$cm1, myp$st1, myp$cm1_st1, myp$cm2_st1, myp$cm4_st1, myp$cm1_st2, myp$cm1_st4), na.rm = T)
mymax <- max(c(myp$cm1, myp$st1, myp$cm1_st1, myp$cm2_st1, myp$cm4_st1, myp$cm1_st2, myp$cm1_st4), na.rm = T)
mypalette <- dichrompalette_br_cy

# fitness in CM
p1 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("CM") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p1

# fitness in STRESS
p2 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("80% Stress") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p2

# fitness in CM:STRESS
p3 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1_st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1_st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("1xCM : 1xSTRESS") + ylim(c(mymin, mymax))
# p3

# fitness in 2CM:STRESS
p4 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm2_st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm2_st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("2xCM : 1xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p4

# fitness in 9CM:STRESS
p5 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm4_st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm4_st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("4xCM : 1xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p5


# fitness in CM:2STRESS
p7 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1_st2))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1_st2, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("1xCM : 2xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p7

# fitness in 1CM:9STRESS
p8 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1_st4))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1_st4, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("1xCM : 4xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p8


x <- grid.arrange(p1, p2, p3,p4,p5,p7,p8,
                  layout_matrix = rbind(c(1,1,1,NA,2,2,2),
                                        c(1,1,1,NA,2,2,2),
                                        c(1,1,1,NA,2,2,2),
                                        c(NA,NA,3,3,3,NA,NA),
                                        c(NA,NA,3,3,3,NA,NA),
                                        c(NA,NA,3,3,3,NA,NA),
                                        c(4,4,4,NA,7,7,7),
                                        c(4,4,4,NA,7,7,7),
                                        c(4,4,4,NA,7,7,7),
                                        c(5,5,5,NA,8,8,8),
                                        c(5,5,5,NA,8,8,8),
                                        c(5,5,5,NA,8,8,8)),
                  top = grid::textGrob("\n Yeast Fitness in CM and 80% STRESS (NaCl) \n", gp =grid::gpar(fontsize = 14, fontface = "bold")))
pdf(file = paste("000_SALT_GEOMFIT_VIOLINS_00_80.pdf"),height = 17, width = 11); grid::grid.draw(x); dev.off()
```



more explore!
```{R}
# calculate some summary statistics -------------------------------------
myp$maxfit <- apply(myp[,c("cm1", "st1")], 1, max, na.rm = T) # maximum fitness
myp$minfit <- apply(myp[,c("cm1", "st1")], 1, min, na.rm = T) # minimum fitness
myp$varfit <- apply(myp[,c("cm1", "st1")], 1, var, na.rm = T) # variance fitness
myp$meanfit <- apply(myp[,c("cm1", "st1")], 1, mean, na.rm = T) # arithmetic mean fitness
myp$gain <- apply(myp[,c("cm1", "st1")], 1, sum, na.rm = T); myp$gain <- myp$gain - 2 # total GAIN in fitness
myp$distance <- abs(myp$cm1 - 1) + abs(myp$st1 - 1) # toal DISTANCE moved from initial fitness
myp$difference <- myp$maxfit - myp$minfit # difference in fitnes across environments
myp$arithoverestimation <- myp$meanfit - myp$cm1_st1 # fitness overestimation by arithmetic method. 


# max fit vs min fit
ggplot()+
  geom_point(aes(x = minfit, y = maxfit, color = Treatment), data = myp)+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(minfit, maxfit), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()


# max fit vs geometric mean fitness
ggplot()+
  geom_point(aes(x = maxfit, y = cm1_st1, color = Treatment), data = myp)+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(maxfit, cm1_st1), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()

ggplot()+
  geom_point(aes(x = maxfit, y = cm9_st1, color = Treatment), data = myp)+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(maxfit, cm9_st1), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()

ggplot()+
  geom_point(aes(x = maxfit, y = cm1_st9, color = Treatment), data = myp)+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(maxfit, cm1_st9), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()






# distance vs geometric mean fitness
ggplot()+
  geom_point(aes(x = distance, y = cm1_st1, color = Treatment), data = myp)+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(distance, cm1_st1), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()

ggplot()+
  geom_point(aes(x = distance, y = cm9_st1, color = Treatment), data = myp)+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(distance, cm9_st1), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()

ggplot()+
  geom_point(aes(x = distance, y = cm1_st9, color = Treatment), data = myp)+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(distance, cm1_st9), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()







# gain vs geometric mean fitness
ggplot()+
  geom_point(aes(x = gain, y = cm1_st1, color = Treatment), data = myp)+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(gain, cm1_st1), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()

ggplot()+
  geom_point(aes(x = gain, y = cm9_st1, color = Treatment), data = myp)+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(gain, cm9_st1), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()

ggplot()+
  geom_point(aes(x = gain, y = cm1_st9, color = Treatment), data = myp)+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH0",], method = "lm", se = F, color = mypalette[1])+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH0_40",], method = "lm", se = F, color = mypalette[2])+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH40",], method = "lm", se = F, color = mypalette[3])+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH20_60",], method = "lm", se = F, color = mypalette[4])+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH0_80",], method = "lm", se = F, color = mypalette[5])+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH40_40",], method = "lm", se = F, color = mypalette[6])+
  geom_smooth(aes(gain, cm1_st9), data = myp[myp$Treatment == "EH80",], method = "lm", se = F, color = mypalette[7])+
  scale_color_manual(values = mypalette)+
  coord_equal()





# a look at arithmetic overestimation. 
ggplot()+
  geom_point(aes(y=arithoverestimation, x=cm1_st1, color = Treatment), data = myp)+
  scale_color_manual(values = mypalette); summary(lm(arithoverestimation ~ cm1_st1, data = myp)) # arithoverestimation

ggplot()+
  geom_point(aes(y=arithoverestimation, x=maxfit, color = Treatment), data = myp)+
  scale_color_manual(values = mypalette); summary(lm(arithoverestimation ~ maxfit, data = myp)) # arithoverestimation






















```




Kassen Plot -- geometric???? all treats 0, 40
```{r}
# get the data ---------------------------------------------
my <- myfit500cw[mydwcw$epo %in% c("SALT_A", "SALT_B"),] # ; my <- myfit500cw[mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

# calculate fitness for dimensions x and y, correcting for initial barcode fitness deviation -----
my$Fitness_in_envX <- my$mn_fit500_0 
my$Fitness_in_envY <- my$mn_fit500_40 
my$fit0dev_X <- my$mn_fit0_0 - 1 
my$fit0dev_Y <- my$mn_fit0_40 - 1
my$Fitness_in_envX <- my$Fitness_in_envX - my$fit0dev_X
my$Fitness_in_envY <- my$Fitness_in_envY - my$fit0dev_Y

# prep the data --------------------------------------------
my <- my[!is.na(my$Fitness_in_envX) & !is.na(my$Fitness_in_envY) & my$Treatment %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),] # remove NA entries
myp <- my # leave the "my" dataframe alone, and work on a plotting frame that will be used for just this plot
myp$cutoff <- NA; myp$cutoff_elip <- NA; myp$md <- NA 
# calculate the 2-d outlier cutoff for plotting points (alpha) and the 2-d outlier cutoff for plotting ellipses (alpha_elip) by treatment. 
for (i in  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) { 
  
  alpha <- 0.01
  alpha_elip <- 0.05
  myt <- myp[myp$Treatment == i,]
  md <- mahalanobis(x = myt[, c("Fitness_in_envX", "Fitness_in_envY")], 
                  center = colMeans(myt[, c("Fitness_in_envX", "Fitness_in_envY")]), 
                  cov = cov(myt[, c("Fitness_in_envX", "Fitness_in_envY")]))
  myp[myp$Treatment == i,]$md <- md
  
  cutoff <- (qchisq(p = 1 - alpha, df = ncol(myp[myp$Treatment == i,][, c("Fitness_in_envX", "Fitness_in_envY")])))
  cutoff_elip <- (qchisq(p = 1 - alpha_elip, df = ncol(myp[myp$Treatment == i,][, c("Fitness_in_envX", "Fitness_in_envY")])))

  myp[myp$Treatment == i,]$cutoff <- cutoff
  myp[myp$Treatment == i,]$cutoff_elip <- cutoff_elip

}

# view all points and ommited points for each category. 
plot(myp$Fitness_in_envY ~ myp$Fitness_in_envX)
points(myp[myp$md >= myp$cutoff,]$Fitness_in_envY ~ myp[myp$md >= myp$cutoff,]$Fitness_in_envX, col = "red")
points(myp[myp$md >= myp$cutoff_elip,]$Fitness_in_envY ~ myp[myp$md >= myp$cutoff_elip,]$Fitness_in_envX, col = "blue")

myp <- myp[myp$md < myp$cutoff,] # remove 2d outliers from the dataset based on alpha value

geomeans <- aggregate(cbind(myp$Fitness_in_envX, myp$Fitness_in_envY)~myp$Treatment,myp,psych::geometric.mean) # create dataframe for treatment geomtric mean fitness values.
colnames(geomeans) <-  c("Treatment","Fitness_in_envX", "Fitness_in_envY")

mypc_elip <- myp[myp$md < myp$cutoff_elip,] # create a dataframe for the elipses, removing points based on the alpha_elip value

# append some additional columns of interest (to be used in later plots!)
myp$cm1 <- myp$Fitness_in_envX
myp$st1 <- myp$Fitness_in_envY
myp$cm1_st1 <- (myp$Fitness_in_envX * myp$Fitness_in_envY)^(1/2)
myp$cm2_st1 <- (myp$Fitness_in_envX^2 * myp$Fitness_in_envY)^(1/3)
myp$cm4_st1 <- (myp$Fitness_in_envX^4 * myp$Fitness_in_envY)^(1/5)
myp$cm1_st2 <- (myp$Fitness_in_envX * myp$Fitness_in_envY^2)^(1/3)
myp$cm1_st4 <- (myp$Fitness_in_envX * myp$Fitness_in_envY^4)^(1/5)

# create a matrix of the geometric fitness surface (used for plotting) -----
geomfit <- matrix(nrow= 500, ncol = 500)
x <- seq(from = min(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T),to = max(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T), length.out = 500)
y <- seq(from = min(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T),to = max(c(myp$Fitness_in_envX, myp$Fitness_in_envY), na.rm = T), length.out = 500)
colnames(geomfit) <- x
rownames(geomfit) <- y
for (i in 1:nrow(geomfit)) {
  for (j in 1:ncol(geomfit)) {
    geomfit[i,j] <- (as.numeric(colnames(geomfit)[j]) * as.numeric(rownames(geomfit)[i]))^(0.5)
  }
}
geomfithold <- geomfit
geomfit <- round(geomfit, digits = 4)
geomfit <- melt(geomfit)
colnames(geomfit) <- c("geomfitx", "geomfity", "geomfitfit")


# Create the Kassen Plot -----------------------------------
mypalette <- dichrompalette_br_cy
p1 <- ggplot()+
  geom_vline(xintercept=1, color = "darkgray")+
  geom_hline(yintercept = 1, color = "darkgray")+
  xlim( min(c(myp$Fitness_in_envX), na.rm = T) - 0.025, max(c(myp$Fitness_in_envX), na.rm = T) + 0.025)+
  ylim( min(c(myp$Fitness_in_envY), na.rm = T) - 0.025, max(c(myp$Fitness_in_envY), na.rm = T) + 0.025)+
  geom_line(data = geomfit[geomfit$geomfitfit == 1,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.025,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.05,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.075,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  geom_line(data = geomfit[geomfit$geomfitfit == 1.1,], aes(x = geomfitx, y = geomfity), lty  = "dotted")+
  annotate("text", x = c(0.95, 0.95, 0.985, 1.03, 1.08), y = c(1.04, 1.08, 1.1, 1.1, 1.1), label = c("w = 1", "w = 1.025", "w = 1.05", "w = 1.075", "w = 1.1"))+
  stat_ellipse(data = mypc_elip[mypc_elip$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, fill = Treatment, color = Treatment), alpha = 0.1, geom = "polygon", linetype = 2, show.legend = F)+
  geom_point(data = myp[myp$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, color = Treatment), size = 2.5, alpha = 0.35, show.legend = T) +
  geom_point(data = myp[myp$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, color = Treatment), shape = 1, size = 2.5, alpha = 0.7, show.legend = F)+
  geom_segment(mapping = aes(x=geomeans[1,2], y=geomeans[1,3], xend=geomeans[7,2], yend=geomeans[7,3]), linetype=1, size=1.5, inherit.aes=F)+
  geom_segment(mapping = aes(x=geomeans[3,2], y=geomeans[3,3], xend=geomeans[7,2], yend=geomeans[7,3]), linetype=1, size=1.5, inherit.aes=F)+
  geom_segment(mapping = aes(x=geomeans[1,2], y=geomeans[1,3], xend=geomeans[3,2], yend=geomeans[3,3]), linetype=1, size=1.5, inherit.aes=F)+
  geom_point(data=geomeans, aes(x=Fitness_in_envX, y=Fitness_in_envY, fill = geomeans$Treatment),color = "black", cex = 7.5, shape = 21)+
  theme_bw()+
  xlab("Fitness in CM (0% Stress)")+
  ylab("Fitness in 40% Stress")+
  coord_equal()+
  geom_rug(data = myp[myp$treat %in%  c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"),], aes(x=Fitness_in_envX, y=Fitness_in_envY, color = Treatment))+
  scale_color_manual(values = mypalette)+
  scale_fill_manual(values = mypalette)
p1
getwd()
pdf(file = paste("000_SALT_KASSEN_0_40_wlines_alltreats.pdf"),height = 11, width = 17); grid::grid.draw(p1); dev.off()

p <- ggplot()+
  geom_density(data = myp, aes(x=cm1_st1, group = Treatment, color = Treatment), trim = T) + scale_color_manual(values = mypalette)
p
```



Create some violins for the 00, 40 dataset in the previous block (USE DATESET FROM BLOCK ABOVE!!!)
```{R}

mymin <- min(c(myp$cm1, myp$st1, myp$cm1_st1, myp$cm2_st1, myp$cm4_st1, myp$cm1_st2, myp$cm1_st4), na.rm = T)
mymax <- max(c(myp$cm1, myp$st1, myp$cm1_st1, myp$cm2_st1, myp$cm4_st1, myp$cm1_st2, myp$cm1_st4), na.rm = T)
mypalette <- dichrompalette_br_cy

# fitness in CM
p1 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("CM") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p1

# fitness in STRESS
p2 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("40% Stress") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p2

# fitness in CM:STRESS
p3 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1_st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1_st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("1xCM : 1xSTRESS") + ylim(c(mymin, mymax))
# p3

# fitness in 2CM:STRESS
p4 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm2_st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm2_st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("2xCM : 1xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p4

# fitness in 9CM:STRESS
p5 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm4_st1))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm4_st1, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("4xCM : 1xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p5


# fitness in CM:2STRESS
p7 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1_st2))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1_st2, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("1xCM : 2xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p7

# fitness in 1CM:9STRESS
p8 <- ggplot()+
  geom_violin(data = myp, aes(x=Treatment, y = cm1_st4))+
  geom_jitter(data = myp, aes(x = Treatment, y = cm1_st4, color = Treatment), width = 0.1, height = 0)+
  coord_flip() + theme_minimal() + scale_color_manual(values = mypalette) + ylab("Fitness") + ggtitle("1xCM : 4xSTRESS") + ylim(c(mymin, mymax)) + theme(legend.position = "none")
# p8


x <- grid.arrange(p1, p2, p3,p4,p5,p7,p8,
                  layout_matrix = rbind(c(1,1,1,NA,2,2,2),
                                        c(1,1,1,NA,2,2,2),
                                        c(1,1,1,NA,2,2,2),
                                        c(NA,NA,3,3,3,NA,NA),
                                        c(NA,NA,3,3,3,NA,NA),
                                        c(NA,NA,3,3,3,NA,NA),
                                        c(4,4,4,NA,7,7,7),
                                        c(4,4,4,NA,7,7,7),
                                        c(4,4,4,NA,7,7,7),
                                        c(5,5,5,NA,8,8,8),
                                        c(5,5,5,NA,8,8,8),
                                        c(5,5,5,NA,8,8,8)),
                  top = grid::textGrob("\n Yeast Fitness in CM and 40% STRESS (NaCl) \n", gp =grid::gpar(fontsize = 14, fontface = "bold")))
pdf(file = paste("000_SALT_GEOMFIT_VIOLINS_00_40.pdf"),height = 17, width = 11); grid::grid.draw(x); dev.off()

```











# SALT data...
# Set universal guides for SALT plotting
```{r}
my <- mydwc[!is.na(mydwc$dw),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]

mylowlim <- round(min(my$dw, na.rm = T)*1.10, 2)
myhighlim <- round(max(my$dw, na.rm = T)*1.10, 2)
mytitle <- NULL
myylab <- "Fitness change"
myxlab <- "Treatment"
myoutline <-  "grey20"
myfill <-  "grey90"
myptalpha <- 0.5
myrugalpha <- 0.7
mypalette <- dichrompalette_br_cy
mytextsize <- 8
myheight <- 3.5
mywidth <- 7
mymeanptsize <- 1
mywtmeanpttype <- 1
mywtmeanptcol <- "black"

# ------------------
rm(my)
```
<br/><br/>

# Calculate covariates for SALT (MOVE THIS BLOCK TO THE PREP FRAME EVENTUALLY)
```{r}
my <- myd

# calculate median counts for each bc. 
my$mncount0i <- NA
my$mncount0f <- NA
for(i in 1:nrow(my)){
  my$mncount0i[i] <- weighted.mean(my[i,c("bc1cts_r1i_a", "bc1cts_r2i_a", "bc1cts_r3i_a", "bc1cts_r4i_a", "bc1cts_r5i_a")],
                                    my[i,c("re_r1i_a", "re_r2i_a", "re_r3i_a", "re_r4i_a", "re_r5i_a")], na.rm = T)
  my$mncount0f[i] <- weighted.mean(my[i,c("bc1cts_f_r1a", "bc1cts_f_r2a", "bc1cts_f_r3a", "bc1cts_f_r4a")],
                                    my[i,c("re_f_r1a", "re_f_r2a", "re_f_r3a", "re_f_r4a")], na.rm = T)
}
my$medcount <- apply(cbind(my$mncount0i, my$mncount0f, my$bc1cts_i_e, my$bc1cts_f_e),
                  1, median, na.rm = T)

# calcualte median proportion
my$prop_i_0r1 <- my$bc1cts_r1i_a / (my$bc1cts_r1i_a + my$bc2cts_r1i_a)
my$prop_i_0r2 <- my$bc1cts_r2i_a / (my$bc1cts_r2i_a + my$bc2cts_r2i_a)
my$prop_i_0r3 <- my$bc1cts_r3i_a / (my$bc1cts_r3i_a + my$bc2cts_r3i_a)
my$prop_i_0r4 <- my$bc1cts_r4i_a / (my$bc1cts_r4i_a + my$bc2cts_r4i_a)
my$prop_i_0r5 <- my$bc1cts_r5i_a / (my$bc1cts_r5i_a + my$bc2cts_r5i_a)

my$prop_f_0r1 <- my$bc1cts_f_r1a / (my$bc1cts_f_r1a + my$bc2cts_f_r1a)
my$prop_f_0r2 <- my$bc1cts_f_r2a / (my$bc1cts_f_r2a + my$bc2cts_f_r2a)
my$prop_f_0r3 <- my$bc1cts_f_r3a / (my$bc1cts_f_r3a + my$bc2cts_f_r3a)
my$prop_f_0r4 <- my$bc1cts_f_r4a / (my$bc1cts_f_r4a + my$bc2cts_f_r4a)

my$prop_i_500r1 <- my$bc1cts_r1i_e / (my$bc1cts_r1i_e + my$bc2cts_r1i_e)
my$prop_i_500r2 <- my$bc1cts_r2i_e / (my$bc1cts_r2i_e + my$bc2cts_r2i_e)
my$prop_i_500r3 <- my$bc1cts_r3i_e / (my$bc1cts_r3i_e + my$bc2cts_r3i_e)
my$prop_i_500r4 <- my$bc1cts_r4i_e / (my$bc1cts_r4i_e + my$bc2cts_r4i_e)
my$prop_i_500r5 <- my$bc1cts_r5i_e / (my$bc1cts_r5i_e + my$bc2cts_r5i_e)

my$prop_f_500 <- my$bc1cts_f_e / (my$bc1cts_f_e + my$bc2cts_f_e)

my$mnprop0i <- NA
my$mnprop0f <- NA
for(i in 1:nrow(my)){
  my$mnprop0i[i] <- weighted.mean(my[i,c("prop_i_0r1", "prop_i_0r2", "prop_i_0r3", "prop_i_0r4", "prop_i_0r5")],
                                    my[i,c("re_r1i_a", "re_r2i_a", "re_r3i_a", "re_r4i_a", "re_r5i_a")], na.rm = T)
  my$mnprop0f[i] <- weighted.mean(my[i,c("prop_f_0r1", "prop_f_0r2", "prop_f_0r3", "prop_f_0r4")],
                                    my[i,c("re_f_r1a", "re_f_r2a", "re_f_r3a", "re_f_r4a")], na.rm = T)
  my$mnprop500i[i] <- weighted.mean(my[i,c("prop_i_500r1", "prop_i_500r2", "prop_i_500r3", "prop_i_500r4", "prop_i_500r5")],
                                    my[i,c("re_r5i_e", "re_r2i_e", "re_r3i_e", "re_r4i_e", "re_r5i_e")], na.rm = T)
}
my$medprop <- apply(cbind(my$mnprop0i, my$mnprop0f, my$mnprop500i, my$prop_f_500),
                  1, median, na.rm = T)
my2 <- my



# create the frame, omitting most cols not necessary for these upcoming plots and tests.
my <- my2
my <- my[,c(1:7, 83:88, 112, 123, 126:148)] # reatain only interst columns
my1 <- my[my$mpar == 1,] # r1
my2 <- my[my$mpar == 2,]; colnames(my2) <- paste0(colnames(my2), "_2") # r2
my3 <- my[my$mpar == 3,]; colnames(my3) <- paste0(colnames(my3), "_3") # r3
my4 <- my[my$mpar == 4,]; colnames(my4) <- paste0(colnames(my4), "_4") # r4
my <- cbind(my1, my2$re_dw_2, my2$dw_2, my3$re_dw_3, my3$dw_3, my4$re_dw_4, my4$dw_4) # zip
colnames(my)[c((ncol(my)-5)):ncol(my)] <- c("re_dw_2", "dw_2", "re_dw_3", "dw_3", "re_dw_4", "dw_4") # name fix
mn_dw <- apply(my, 1, function(x) weighted.mean(as.numeric(x[c( "dw", "dw_2", "dw_3", "dw_4")]), 
                                                  as.numeric(x[c( "re_dw","re_dw_2","re_dw_3","re_dw_4")]), na.rm = T)) # calculate wtd.mean dw across reps
my$mn_dw <- mn_dw; my$mn_dw[is.nan(my$mn_dw)] <- NA # fix nans
my$omit <- F; my$omit[is.na(my$mn_dw)] <- T # update omit field
mn_re_dw <- apply(my, 1, function(x) mean(as.numeric(x[c( "re_dw", "re_dw_2", "re_dw_3", "re_dw_4")]), na.rm =T)) # calculate reads for mn_dw
my$mn_re_dw <- mn_re_dw # assign
my$mn_re_dw[is.nan(my$mn_re_dw)] <- NA
my$se_dw <- apply(my[,c("dw", "dw_2", "dw_3", "dw_4")], 1, sjstats::se)
mydwc_se <- my # name frame


mymod <- lm(I(scale(mydwc_se$se_dw)) ~ I(scale(mydwc_se$mn_dw)) + I(scale(mydwc_se$medcount)) +  I(scale(mydwc_se$medprop)) + mydwc_se$treat, weights = mydwc_se$mn_re_dw); summary(mymod); anova(mymod)


rm(my, i)
```

# SALT evolved in CM -- STATISTICAL TEST
```{r}
# Test - SALT DATA IN CM --------------------------------------------------------
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```

# SALT Evolved in CM -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp
# figure output ---------------------------------------------------------------
pdf(file = "000_SALTinCM.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc)
```
<br/><br/>



# SALT evolved in CM+80% NaCl -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "SALT" & my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>

# SALT evolved in CM+80% NaCl -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "SALT" & my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_SALTinSALT80.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
```
<br/><br/>












# COPR next....
# lets set some universal guides for COPR plotting
```{r}
my <- mydwc[!is.na(mydwc$dw),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]

mylowlim <- round(min(my$dw, na.rm = T)*1.10, 2)
myhighlim <- round(max(my$dw, na.rm = T)*1.10, 2)
mytitle <- NULL
myylab <- "Fitness change"
myxlab <- "Treatment"
myoutline <-  "grey20"
myfill <-  "grey90"
myptalpha <- 0.5
myrugalpha <- 0.7
mypalette <- dichrompalette_br_cy
mytextsize <- 8
myheight <- 3.5
mywidth <- 7
mymeanptsize <- 1
mywtmeanpttype <- 1
mywtmeanptcol <- "black"

# ------------------
rm(my)
```
<br/><br/>


# COPR Evolved in CM -- STATISTICAL TEST
```{r}
# Test - COPR DATA IN CM --------------------------------------------------------
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>


# COPR Evolved in CM -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = .6, ymax = 1)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.6, ymax = 1)
pppp
# figure output ---------------------------------------------------------------
pdf(file = "000_COPRinCM.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc)
```
<br/><br/>


# COPR evolved in CM+80% COPR -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "COPR" & my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>


# COPR evolved in CM+80% COPR -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "COPR" & my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = .6, ymax = 1)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.6, ymax = 1)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_COPRinCOPR80.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
```
<br/><br/>







It is important to look at these data a few different ways, lets zoom in on the rug plot from the treatment effect violin plots above...
PLOT(S): SALT dw rank by barcode in 0.0, 0.4, 0.8, 1.2
```{r}
# # Set controls for all plots ---------------------------------------------------
# mywidth <- 7
# myheight <- 7
# 
# # SALT in CM -------------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 0.0 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),] # subset
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # fix treat levels
# my <- my[!is.na(my$mn_dw),] # rm NAs
# my <- my[order(my$mn_dw),] # sort so the plot looks good
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity") # plot
# p # view plot
# pdf(file = "000_rank_SALTinCM.pdf", width = mywidth, height = myheight); p; dev.off() # output plot
# 
# 
# 
# # SALT in SALT 040 -------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 0.4 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# my <- my[!is.na(my$mn_dw),]
# my <- my[order(my$mn_dw),]
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity")
# p
# pdf(file = "000_rank_SALTinSALT040.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# 
# 
# # SALT in SALT 080 -------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 0.8 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# my <- my[!is.na(my$mn_dw),]
# my <- my[order(my$mn_dw),]
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity")
# p
# pdf(file = "000_rank_SALTinSALT080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# 
# 
# # SALT in SALT 120 -------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 1.2 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# my <- my[!is.na(my$mn_dw),]
# my <- my[order(my$mn_dw),]
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity")
# p
# pdf(file = "000_rank_SALTinSALT120.pdf", width = mywidth, height = myheight); p; dev.off()
```
<br/><br/>



PLOT(S): COPR dw rank by barcode in 0.0, 0.4, 0.8, 1.2
```{r}
# # Set controls for all plots ---------------------------------------------------
# mywidth <- 7
# myheight <- 7
# 
# # COPR in CM -------------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 0.0 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),] # subset
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # fix treat levels
# my <- my[!is.na(my$mn_dw),] # rm NAs
# my <- my[order(my$mn_dw),] # sort so the plot looks good
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity") # plot
# p # view plot
# pdf(file = "000_rank_COPRinCM.pdf", width = mywidth, height = myheight); p; dev.off() # output plot
# 
# 
# 
# # COPR in COPR 040 -------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 0.4 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# my <- my[!is.na(my$mn_dw),]
# my <- my[order(my$mn_dw),]
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity")
# p
# pdf(file = "000_rank_COPRinCOPR040.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# 
# 
# # COPR in COPR 080 -------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 0.8 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# my <- my[!is.na(my$mn_dw),]
# my <- my[order(my$mn_dw),]
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity")
# p
# pdf(file = "000_rank_COPRinCOPR080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# 
# 
# # COPR in COPR 120 -------------------------------------------------------------
# my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 1.2 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# my <- my[!is.na(my$mn_dw),]
# my <- my[order(my$mn_dw),]
# p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
#   geom_bar (stat="identity")
# p
# pdf(file = "000_rank_COPRinCOPR120.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # ----------------------------
# rm(myheight, mywidth, my, p)
```
<br/><br/>



This is still a lot to take in at one time, maybe looking at some targeted sets will help with interpretation....
SALT data first...
PLOT(S): pairs plots for targetted sets of 3 (and one set with all treats together for context!) 
```{R}
# # Set controls for all plots ---------------------------------------------------
# mywidth <- 8
# myheight <- mywidth
# 
# # ALL ------------------------------------------------------
# my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "ALL")
# pdf(file = "000_pairs_SALT_ALL_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # specialist vs. generalists: low stress end ---------------
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH0_40"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_40")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: low stress end")
# pdf(file = "000_pairs_SALT_EH0_EH40_EH0-40_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # specialist vs. generalists: full spectrum ----------------
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH80", "EH0_80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: full spectrum")
# pdf(file = "000_pairs_SALT_EH0_EH80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH40", "EH80", "EH40_80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_40", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: high stress end")
# pdf(file = "000_pairs_SALT_EH40_EH80_EH40-80_in_040_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialists with different means compared")
# pdf(file = "000_pairs_SALT_EH0_EH40_EH80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH0_40", "EH20_60", "EH40_80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "generalists with same flux degree, different means compared")
# pdf(file = "000_pairs_SALT_EH0-40_EH20-60_EH40-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH0_80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared minimum with variable degree of flux up")
# pdf(file = "000_pairs_SALT_EH0_EH0-40_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH80", "EH40_80", "EH0_80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared maximum with variable degree of flux down")
# pdf(file = "000_pairs_SALT_EH80_EH40-80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH40", "EH20_60", "EH0_80"),]
# my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared mean with variable degree of flux around mean")
# pdf(file = "000_pairs_SALT_EH40_EH20_60_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # rm -------------------------
# rm(myheight, mywidth, my, p)
```
<br/><br/>



COPR data next...
PLOT(S): pairs plots for targetted sets of 3 (and one set with all treats together for context!) 
```{R}
# # Set controls for all plots ---------------------------------------------------
# mywidth <- 8
# myheight <- mywidth
# 
# # ALL ------------------------------------------------------
# my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "ALL")
# pdf(file = "000_pairs_COPR_ALL_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # specialist vs. generalists: low stress end ---------------
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH0_40"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_40")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: low stress end")
# pdf(file = "000_pairs_COPR_EH0_EH40_EH0-40_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # specialist vs. generalists: full spectrum ----------------
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH80", "EH0_80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: full spectrum")
# pdf(file = "000_pairs_COPR_EH0_EH80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH40", "EH80", "EH40_80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_40", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: high stress end")
# pdf(file = "000_pairs_COPR_EH40_EH80_EH40-80_in_040_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialists with different means compared")
# pdf(file = "000_pairs_COPR_EH0_EH40_EH80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH0_40", "EH20_60", "EH40_80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "generalists with same flux degree, different means compared")
# pdf(file = "000_pairs_COPR_EH0-40_EH20-60_EH40-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH0_80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared minimum with variable degree of flux up")
# pdf(file = "000_pairs_COPR_EH0_EH0-40_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH80", "EH40_80", "EH0_80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared maximum with variable degree of flux down")
# pdf(file = "000_pairs_COPR_EH80_EH40-80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# my <- mydwcw[mydwcw$treat %in% c("EH40", "EH20_60", "EH0_80"),]
# my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
# my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
# p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared mean with variable degree of flux around mean")
# pdf(file = "000_pairs_COPR_EH40_EH20_60_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()
# 
# # rm -------------------------
# rm(myheight, mywidth, my, p)
```
<br/><br/>




ASSESS: FITNESS INCREASE & DECREASE IN 500 GENERATIONS OF EVOLUTION ACROSS 7 TREATMENTS IN 4 ENVIRONMENTS AND 2 CHEMICAL STRESSORS 
Test for fitness increase/decrease for SALT evolved lines in 0.0, 0.4, 0.8, and 1.2 SALT envs. - generate results frames
```{r}
# BLOCK NOTES ------------------------------------------------------------------
#  - Fitness increase data: analyze by groups externally & use in later blocks
#  - Fitness decrease data: analyze by groups externally & use in later blocks
#  - nleft data: use in later blocks
#  - env specific data frames: use in later blocks
# ------------------------------------------------------------------------------

mysig <- 0.05

# SALT RESULTS OUTPUT TABLES ---------------------------------------------------

mySALTin <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant increase
mySALTdec <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant decrease
mySALTno <- matrix(nrow = 7, ncol = 4) # number of barcodes non-extinct
mySALTtot <- matrix(nrow = 7, ncol = 4) # number of barcodes included in the treatment
rownames(mySALTin) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mySALTdec) <- rownames(mySALTin)
rownames(mySALTno) <- rownames(mySALTin)
rownames(mySALTtot) <- rownames(mySALTin)
colnames(mySALTin) <- c(0.0, 0.4, 0.8, 1.2)
colnames(mySALTdec) <- colnames(mySALTin)
colnames(mySALTno) <- colnames(mySALTin)
colnames(mySALTtot) <- colnames(mySALTin)



# SALT in CM -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.0,]
# x <- table(my$treat)/4; mySALTtot[,c(1:4)] <- x[c(1, 5, 7, 2, 4, 3, 6)]
my <- my[!is.na(my$dw),]

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
x <- summary(mymod)
x <- as.data.frame(x$coefficients)
p.adjust(x[,4], method = "fdr")
x$bcpid <- rownames(x)
x$bcpid<-gsub("my", "", x$bcpid)
x$bcpid<-gsub("[:$:]", "", x$bcpid)
rownames(x)<-x$bcpid; colnames(x)[4] <- "FDR"
write.csv(x, file = "copr_000_FDR.csv")
tab_model(mymod, digits = 5, digits.p = 100, show.stat = T, wrap.labels = 100, file = "copr_000_rawp.html") # table does not have corrected p-values.


# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_000 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,1] <- nrow(tmp)



 # SALT in 40 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),]
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 0.4 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_040.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_040 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,2] <- nrow(tmp)



# SALT in 80 -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 0.8 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_080.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_080 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,3] <- nrow(tmp)



# SALT in 120 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 1.2 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_120.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_120 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,4] <- nrow(tmp)


# ----------------------------
mySALTnleft <- mySALTno; rm(mySALTno)  # give a clearer name. 
mySALText <- mySALTtot - mySALTnleft; rm(mySALTnleft) # now subtract from tot to get n extinct in each treat
mySALTunc <- mySALTtot - (mySALTdec + mySALTin + mySALText)

# ----------------------------
# rm(inc_SALT_000, inc_SALT_040, inc_SALT_080, inc_SALT_120) # uncomment if you want to retain these results. 
rm(my, mymod, myres, tmp, i, mysig)
```
<br/><br/>



Test for fitness increase/decrease for COPR evolved lines in 0.0, 0.4, 0.8, and 1.2 COPR envs. - generate results frames
```{r}
# BLOCK NOTES ------------------------------------------------------------------
#  - Fitness increase data: analyze by groups externally & use in later blocks
#  - Fitness decrease data: analyze by groups externally & use in later blocks
#  - nleft data: use in later blocks
#  - env specific data frames: use in later blocks
# ------------------------------------------------------------------------------

mysig <- 0.05

# COPR RESULTS OUTPUT TABLES ---------------------------------------------------

myCOPRin <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant increase
myCOPRdec <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant decrease
myCOPRno <- matrix(nrow = 7, ncol = 4) # number of barcodes non-extinct
myCOPRtot <- matrix(nrow = 7, ncol = 4) # number of barcodes included in the treatment
rownames(myCOPRin) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(myCOPRdec) <- rownames(myCOPRin)
rownames(myCOPRno) <- rownames(myCOPRin)
rownames(myCOPRtot) <- rownames(myCOPRin)
colnames(myCOPRin) <- c(0.0, 0.4, 0.8, 1.2)
colnames(myCOPRdec) <- colnames(myCOPRin)
colnames(myCOPRno) <- colnames(myCOPRin)
colnames(myCOPRtot) <- colnames(myCOPRin)



# COPR in CM -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.0,]
x <- table(my$treat)/4
x["EH0"] <- 16; x["EH40"] <- 16;  x["EH80"] <- 15
myCOPRtot[,c(1:4)] <- x[c(1, 5, 7, 2, 4, 3, 6)]
my <- my[!is.na(my$dw),]

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_000.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_000 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,1] <- nrow(tmp)



 # COPR in 40 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),]
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.4 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_040.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_040 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,2] <- nrow(tmp)



# COPR in 80 -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.8 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_080.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_080 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,3] <- nrow(tmp)



# COPR in 120 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 1.2 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_120.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_120 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,4] <- nrow(tmp)


# ----------------------------
myCOPRnleft <- myCOPRno; rm(myCOPRno)  # give a clearer name. 
myCOPRext <- myCOPRtot - myCOPRnleft; rm(myCOPRnleft) # now subtract from tot to get n extinct in each treat
myCOPRunc <- myCOPRtot - (myCOPRdec + myCOPRin + myCOPRext)

# ----------------------------
# rm(inc_COPR_000, inc_COPR_040, inc_COPR_080, inc_COPR_120) # uncomment if you want to retain these results. 
rm(my, mymod, myres, tmp, i, mysig)
```
<br/><br/>


Create a dataframe that will utilize all of the increase / decrease p-values 
```{R}
my <- mydwcw
my$in0 <- NA
my$in40 <- NA
my$in80 <- NA
my$in120 <- NA
my$dec0 <- NA
my$dec40 <- NA
my$dec80 <- NA
my$dec120 <- NA

for (i in 1:nrow(my)) {
  # SALT data first
  if(my[i, "epo"] %in% c("SALT_A", "SALT_B")){
    # store values
    # increase by env
    x <- inc_SALT_000$p1s_h[inc_SALT_000$bcid == my[i, "bcpID"]]
    y <- inc_SALT_040$p1s_h[inc_SALT_040$bcid == my[i, "bcpID"]]
    z <- inc_SALT_080$p1s_h[inc_SALT_080$bcid == my[i, "bcpID"]]
    a <- inc_SALT_120$p1s_h[inc_SALT_120$bcid == my[i, "bcpID"]]
    
    # decrease by env
    b <- inc_SALT_000$p1s_l[inc_SALT_000$bcid == my[i, "bcpID"]]
    c <- inc_SALT_040$p1s_l[inc_SALT_040$bcid == my[i, "bcpID"]]
    d <- inc_SALT_080$p1s_l[inc_SALT_080$bcid == my[i, "bcpID"]]
    e <- inc_SALT_120$p1s_l[inc_SALT_120$bcid == my[i, "bcpID"]]    
    
    #assignment
    # increase by env
    if(length(x) > 0){my[i, "in0"] <- x}
    if(length(y) > 0){my[i, "in40"] <- y}
    if(length(z) > 0){my[i, "in80"] <- z}
    if(length(a) > 0){my[i, "in120"] <- a}
    
    # decrease by env
    if(length(b) > 0){my[i, "dec0"] <- b}
    if(length(c) > 0){my[i, "dec40"] <- c}
    if(length(d) > 0){my[i, "dec80"] <- d}
    if(length(e) > 0){my[i, "dec120"] <- e}
  }
  
  # repeat for COPR data
  if(my[i, "epo"] %in% c("COPR_A", "COPR_B")){
    x <- inc_COPR_000$p1s_h[inc_COPR_000$bcid == my[i, "bcpID"]]
    y <- inc_COPR_040$p1s_h[inc_COPR_040$bcid == my[i, "bcpID"]]
    z <- inc_COPR_080$p1s_h[inc_COPR_080$bcid == my[i, "bcpID"]]
    a <- inc_COPR_120$p1s_h[inc_COPR_120$bcid == my[i, "bcpID"]]
    
    b <- inc_COPR_000$p1s_l[inc_COPR_000$bcid == my[i, "bcpID"]]
    c <- inc_COPR_040$p1s_l[inc_COPR_040$bcid == my[i, "bcpID"]]
    d <- inc_COPR_080$p1s_l[inc_COPR_080$bcid == my[i, "bcpID"]]
    e <- inc_COPR_120$p1s_l[inc_COPR_120$bcid == my[i, "bcpID"]]    
    
    
    if(length(x) > 0){my[i, "in0"] <- x}
    if(length(y) > 0){my[i, "in40"] <- y}
    if(length(z) > 0){my[i, "in80"] <- z}
    if(length(a) > 0){my[i, "in120"] <- a}
    
    if(length(b) > 0){my[i, "dec0"] <- b}
    if(length(c) > 0){my[i, "dec40"] <- c}
    if(length(d) > 0){my[i, "dec80"] <- d}
    if(length(e) > 0){my[i, "dec120"] <- e}
  }
}
mydwcw <- my
```
<br/><br/>

Code blocks below in order: Inc calc & table, Inc fig, Dec calc & table, Dec fig. COPR blocks follow SALT blocks. 

SALT ---------------------------------------------------------------------------
Create summary tables:

ALL -- all treatments in 00 and 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$in0 <= 0.05 & my$in80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$in0 <= 0.05 & my$in80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$in0 > 0.05 & my$in80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$in0 > 0.05 & my$in80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("in_both", "in_0", "in_80", "in_neither", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_SALT_at_00s80s_inc_raw.csv")
write.csv(mymat2, file = "table4_SALT_at_00s80s_inc_divtot.csv")
write.csv(mymat3, file = "table4_SALT_at_00s80s_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in0 <= 0.05 & my$in80 <= 0.05] <- "Both"
my$Environment[my$in0 <= 0.05 & my$in80 > 0.05] <- "No Stress Only"
my$Environment[my$in0 > 0.05 & my$in80 <= 0.05] <- "High Stress Only"
my$Environment[my$in0 > 0.05 & my$in80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Stress Only", "No Stress Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
mypal <- c(rgb(212/255, 175/255, 55/255, 1), rgb(139/255, 0/255, 0/255, 0.85), rgb(235/255, 150/255, 5/255, 0.85), "gray")
pdf(file = "000_stackedbar_SALT_alltreat_00_80_inc.pdf", width = mywidth, height = myheight)
p <- ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_manual(values = mypal, drop = F)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
p
rm(p)
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$dec0 <= 0.05 & my$dec80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$dec0 <= 0.05 & my$dec80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$dec0 > 0.05 & my$dec80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$dec0 > 0.05 & my$dec80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("dec_both", "dec_0", "dec_80", "dec_none", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_SALT_at_00s80s_dec_raw.csv")
write.csv(mymat2, file = "table4_SALT_at_00s80s_dec_divtot.csv")
write.csv(mymat3, file = "table4_SALT_at_00s80s_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec0 <= 0.05 & my$dec80 <= 0.05] <- "Both"
my$Environment[my$dec0 <= 0.05 & my$dec80 > 0.05] <- "No Stress Only"
my$Environment[my$dec0 > 0.05 & my$dec80 <= 0.05] <- "High Stress Only"
my$Environment[my$dec0 > 0.05 & my$dec80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Stress Only", "No Stress Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
mypal <- c(rgb(127/255, 255/255, 212/255, 1), rgb(2/255, 16/255, 146/255, 0.65), rgb(112/255, 130/255, 56/255, 0.85), "gray")
pdf(file = "000_stackedbar_SALT_alltreat_00_80_dec.pdf", width = mywidth, height = myheight)
p <- ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_manual(values = mypal, drop = F)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
p
rm(p)
```
<br/><br/>



ALL -- All treatments in 00, 40, 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_SALT_at_004080_inc_raw.csv")
write.csv(mymat2, file = "table6_SALT_at_004080_inc_divtot.csv")
write.csv(mymat3, file = "table6_SALT_at_004080_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "000"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "100"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "010"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "001"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "110"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "101"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "011"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_SALT_at_004080_dec_raw.csv")
write.csv(mymat2, file = "table6_SALT_at_004080_dec_divtot.csv")
write.csv(mymat3, file = "table6_SALT_at_004080_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "000"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "100"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "010"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "001"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "110"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "101"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "011"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- All treatments in all four environments
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80) | is.na(my$in120),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80) & !is.na(my$in120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_SALT_at_allenv_inc_raw.csv")
write.csv(mymat2, file = "table5_SALT_at_allenv_inc_divtot.csv")
write.csv(mymat3, file = "table5_SALT_at_allenv_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_120_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80) | is.na(my$dec120),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80) & !is.na(my$dec120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_SALT_at_allenv_dec_raw.csv")
write.csv(mymat2, file = "table5_SALT_at_allenv_dec_divtot.csv")
write.csv(mymat3, file = "table5_SALT_at_allenv_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_120_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>






COPR ---------------------------------------------------------------------------
Create summary tables:
ALL -- all treatments in 00 and 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$in0 <= 0.05 & my$in80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$in0 <= 0.05 & my$in80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$in0 > 0.05 & my$in80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$in0 > 0.05 & my$in80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("in_both", "in_0", "in_80", "in_neither", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_COPR_at_00s80s_inc_raw.csv")
write.csv(mymat2, file = "table4_COPR_at_00s80s_inc_divtot.csv")
write.csv(mymat3, file = "table4_COPR_at_00s80s_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in0 <= 0.05 & my$in80 <= 0.05] <- "Both"
my$Environment[my$in0 <= 0.05 & my$in80 > 0.05] <- "Low Only"
my$Environment[my$in0 > 0.05 & my$in80 <= 0.05] <- "High Only"
my$Environment[my$in0 > 0.05 & my$in80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_80_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$dec0 <= 0.05 & my$dec80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$dec0 <= 0.05 & my$dec80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$dec0 > 0.05 & my$dec80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$dec0 > 0.05 & my$dec80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("dec_both", "dec_0", "dec_80", "dec_none", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_COPR_at_00s80s_dec_raw.csv")
write.csv(mymat2, file = "table4_COPR_at_00s80s_dec_divtot.csv")
write.csv(mymat3, file = "table4_COPR_at_00s80s_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec0 <= 0.05 & my$dec80 <= 0.05] <- "Both"
my$Environment[my$dec0 <= 0.05 & my$dec80 > 0.05] <- "Low Only"
my$Environment[my$dec0 > 0.05 & my$dec80 <= 0.05] <- "High Only"
my$Environment[my$dec0 > 0.05 & my$dec80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_80_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- All treatments in 00, 40, 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_COPR_at_004080_inc_raw.csv")
write.csv(mymat2, file = "table6_COPR_at_004080_inc_divtot.csv")
write.csv(mymat3, file = "table6_COPR_at_004080_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "000"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "100"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "010"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "001"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "110"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "101"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "011"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_COPR_at_004080_dec_raw.csv")
write.csv(mymat2, file = "table6_COPR_at_004080_dec_divtot.csv")
write.csv(mymat3, file = "table6_COPR_at_004080_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "000"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "100"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "010"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "001"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "110"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "101"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "011"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- All treatments in all four environments
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80) | is.na(my$in120),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80) & !is.na(my$in120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_COPR_at_allenv_inc_raw.csv")
write.csv(mymat2, file = "table5_COPR_at_allenv_inc_divtot.csv")
write.csv(mymat3, file = "table5_COPR_at_allenv_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_120_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80) | is.na(my$dec120),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80) & !is.na(my$dec120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_COPR_at_allenv_dec_raw.csv")
write.csv(mymat2, file = "table5_COPR_at_allenv_dec_divtot.csv")
write.csv(mymat3, file = "table5_COPR_at_allenv_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_120_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>























































# Take a look at extinction across environments without any stats tests.*, **
      * We will look at this in more depth in the longitudinal data (either as extinciton or fixation)
      ** slight variation in n bcs extinct in the different environments comes from the fact that some bcs (that already have v.low counts) are extirpated during the fit assay in some environments but not in others. 
```{R}
# # SALT first -------------------------------------------------------------------
# my <- mySALText
# myres <- matrix(nrow = 7, ncol = 3); rownames(myres) <- rownames(my) # create res dataframe 
# colnames(myres) <- c("mean", "se", "mean.prop")
# myres[,1] <- apply(my, 1, mean) # calculate treat means
# myres[,2] <- apply(my, 1, sjstats::se) # calculate treatment ses
# myres[,3] <- myres[,1] / mySALTtot[,1] # report treatment means as proportions as well
# SALT_ext_res_summary <- myres # store in informative frame.
# 
# # COPR -------------------------------------------------------------------------
# my <- mySALText
# myres <- matrix(nrow = 7, ncol = 3); rownames(myres) <- rownames(my)
# colnames(myres) <- c("mean", "se", "mean.prop")
# myres[,1] <- apply(my, 1, mean)
# myres[,2] <- apply(my, 1, sjstats::se)
# myres[,3] <- myres[,1] / mySALTtot[,1]
# SALT_ext_res_summary <- myres
```
<br/><br/>