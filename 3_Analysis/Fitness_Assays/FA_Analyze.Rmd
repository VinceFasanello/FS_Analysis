---
title: "FA_Analyze.rmd"
output:
  html_document:
    df_print: paged
---

***
### Begin Code Blocks:

Prepare the workspace: clean, set options, load packages, load and final formatting on inputs.
```{r, warning = FALSE, message=FALSE}
rm(list = ls()) # clear workspace
knitr::opts_chunk$set(tidy = TRUE, collapse = TRUE) # set global knitr options.
# load required packages
require(ggplot2); # used for plotting
require(pwr); # used for power analysis
require(lme4); # used for mixed effects models
require(lmerTest); # used to interpret mixed effects models
require(sjPlot); # used to output tables
require(weights); # used for weighted t.test
require(plyr); # used for dataframe manipulation
require(gridExtra) # used for multipanel plotting
require(barnard)
require(GGally)
require(plotly)
require(dplyr)
require(tidyr)
require(ggthemes)
require(gtable)
require(cowplot)
require(MuMIn)
require(simr)
require(gtable)
require(scales)
require(viridis)
require(reshape2)
require(grid)
require(gridExtra)
require(remotes)
require(devtools)
devtools::install_github("rogiersbart/RTOOLZ")
require(rtoolz)
options(scipen = 999) # turn off scientific notation
```
<br/><br/>



Add a field summarizing barcode 1 counts at time final in the ancestral fitness assay*
      *move this block to prev script when time permits.
```{r, warning = FALSE, message=FALSE}
load(file = "myd.Rdata")
myd$bc1cts_f_a <- apply(myd, 1, function(x) weighted.mean(as.numeric(x[c( "bc1cts_f_r1a", "bc1cts_f_r2a", "bc1cts_f_r3a", "bc1cts_f_r4a")]), 
                                                  as.numeric(x[c( "re_f_r1a","re_f_r2a","re_f_r3a","re_f_r4a")]), na.rm = T))
```
<br/><br/>



Determine data ommission criteria and implement.
```{r, warning = FALSE, message=FALSE}
my <- myd
# view the most sensitive measure -- those barcodes that are actually omit at generation 500 (not present at start of the fit  assay)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 1000000]), breaks = 100)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 1000]), breaks = 100)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 100]), breaks = 100)
# hist((my$bc1cts_i_e[my$bc1cts_i_e <= 50]), breaks = 100) # lets omit below 15, this look like a natural break -- we will apply this value at 4 timepoints...

# first take a look at how many entries fall w/in each category
# sum(my$bc1cts_i_e <= 15) # entries with generation 500 fitness assay initial counts <= 15 [ANS: 1792 / 7104 (0.2522523)]
# sum(my$bc1cts_f_e <= 15) # "" generation 500 fitness assay final counts "" [ANS: 2605 / 7104 (0.3666948)]
# sum(my$bc1cts_i_a <= 15) # "" generation 0 fitness assay initial counts "" [ANS: 0 / 7104 (0.00)]
# sum(my$bc1cts_f_a <= 15) # "" generation 0 fitness assay final counts "" [ANS: 8 / 7104 (0.001126126)]

my$omit <- FALSE # initially set to false (was T for all < 2 counts originally)
my$omit[my$bc1cts_i_e <= 15 | my$bc1cts_f_e <= 15 | my$bc1cts_i_a <= 15 | my$bc1cts_f_a <= 15] <- T # see prev block comments, just assignment here. 

my$fit0[my$bc1cts_i_a <= 15 | my$bc1cts_f_a <= 15] <- NA # NA fit data for the 8 entries that are missing complete data
my$re_fit_a[my$bc1cts_i_a <= 15 | my$bc1cts_f_a <= 15] <- NA
my$fit500[my$omit == T] <- NA # na fit500 data for omits
my$dw[my$omit == T] <- NA # na dw data for omits
my$re_dw[my$omit == T] <- NA
my$re_fit_e[my$omit == T] <- NA

myd <- my
```
<br/><br/>



Initialize helper functions (see links for those found online)
```{r, warning = FALSE, message=FALSE}
# expand_residuals creates a modified histogram of residuals. ------------------
# Each entry in the model output is plotted a number of times equal to its reads.
expand_residuals <- function(model, reads){
  myfr <- NA
  for(i in 1:length(residuals(model))){
    times <- (((reads[i] - min(reads, na.rm = T))/(max(reads) - min(reads)))*1000) + 1 
    myfr <- c(myfr, rep(residuals(model)[i], times = times))
  }
  return(myfr)
}



# log transformation for modeling. ---------------------------------------------
log_transform <- function(myvar){
  myvar <- log(((myvar - min(myvar))/(max(myvar) - min(myvar))) + 1) 
  return(myvar)
}



# weighted.var.se --------------------------------------------------------------
# https://stats.stackexchange.com/questions/25895/computing-standard-error-in-weighted-mean-estimation
weighted.var.se <- function(x, w, na.rm=FALSE)
#  Computes the variance of a weighted mean following Cochran 1977 definition
{
  if (na.rm) { w <- w[i <- !is.na(x)]; x <- x[i] }
  n = length(w)
  xWbar = weighted.mean(x,w,na.rm=na.rm)
  wbar = mean(w)
  out = n/((n-1)*sum(w)^2)*(sum((w*x-wbar*xWbar)^2)-2*xWbar*sum((w-wbar)*(w*x-wbar*xWbar))+xWbar^2*sum((w-wbar)^2))
  return(out)
}



# get legend function found on stack exchange ----------------------------------[FIND LINK]
#   scrapes figure legend for later plotting in multipannel plot
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}



# get_se calculates standard error of the mean ---------------------------------
get_se <- function(x){
  tmp <- sd(x, na.rm=TRUE) /  sqrt(length(x[!is.na(x)]))
  return(tmp)
}

# http://www.sthda.com/english/wiki/ggplot2-quick-correlation-matrix-heatmap-r-software-and-data-visualization
# Get lower triangle of the correlation matrix
  get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }
```
<br/><br/>



Set color palette options to be used throughout
```{r}
# Color palettes with implementation information beneath:-----------------------
trichromramp_g_bl_rd <- c("#006600", "#9999ff", "#6666ff", "#000066","#ff9999", "#ff6666", "#990000")
# used in:
#     1. all plots that compare by env in a single panel

dichrompalette_br_cy <- RColorBrewer::brewer.pal(n = 11, name = "BrBG")[c(11,10,9,8,3,2,1)]
# used in:
#     1. All plots that compare by treat.

dark2 <- RColorBrewer::brewer.pal(7, "Dark2") # not used currently. good swap for dichrompalette_br_cy and dichrompalette_re_bl when not trying to show ranks
dichrompalette_re_bl <- RColorBrewer::brewer.pal(n = 11, name = "RdYlBu")[c(11,10,8,6,4,3,2)] # not used currently. good swap for dichrompalette_br_cy, dark2
heat_YlOrRd <-  RColorBrewer::brewer.pal(n = 9, name = "YlOrRd")[c(3:9)] # not currently used
```
<br/><br/>



Visualize Initial (ancestral) fitness in seven environments
```{r}
# BLOCK NOTES ------------------------------------------------------------------
# - initial fitness distribution looks hump-shaped 
# - initial fitness distribution shows positive shift in general -- indicates that the chosen ref happened to be lower in fit than most other bcs in our pop, this is no problem. 
# - Initial fitness distribution shifted as salt stress increases -- indicates increasing discrepency between pop and ref with higher salt concentration (good thing we use delta fitness).
# - Initial fitness distribution shows no shift in COPR (Need to plot salt then copr; uncomment myc line; to see this).
# - Initial fitness hump-shape falls apart in copr 120 which may be too stressfull to accurately assess fitness in. (we will see down the line). 
# 
# - PROBLEMS:
#   - The plot shows very different patterns when you plot salt first and when you plot copr first. may be worth looking at both (I describe above though). 
# ------------------------------------------------------------------------------

my <- myd
# Visualize -------------------------------------------------------------------
myx <- my$fit0
myr <- my$re_fit_a / mean(my$re_fit_a, na.rm = T)
myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "COPR0.4", "COPR0.8", "COPR1.2", "SALT0.4", "SALT0.8", "SALT1.2"))
#myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "SALT0.4", "SALT0.8", "SALT1.2","COPR0.4", "COPR0.8", "COPR1.2" ))
mybinwidth <- 0.0025
mytitle <- NULL
myylab <- "Count"
myxlab <- "Ancestral Fitness (in Seven Environments)"
myhighlight <- "black"
myfillapha <- 0.8
mypalette <- trichromramp_g_bl_rd
mytextsize <- 8
myheight <- 7 
mywidth <- 7

p <- ggplot(my, aes(x=myx,color = myc, fill = myc, weight = myr)) + 
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = 0.05)+
  #xlim(c(-0.06, 0.06)) +
  geom_vline(xintercept = 1.0, linetype = "dashed", color = myhighlight) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= c(0.8,0.6)) +
  labs(fill = "Fitness Assay Environment") +
  ggtitle(mytitle)+ ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))+
  scale_x_continuous(breaks = seq(.75,1.25,by=0.05),
                     labels = c("0.75", "0.8", "0.85", "0.9", "0.95", "1.0","1.05", "1.1","1.15","1.2", "1.25"),
                     limits = c(.75, 1.25))+
  scale_y_continuous(breaks = seq(0, 1000, by = 100), limits = c(0, 700))
p

# figure output ---------------------------------------------------------------
pdf(file = "000_ancfit_cbyenv.pdf", width = mywidth, height = myheight); p; dev.off() # one column wide, equal height


# -----------------------------------------------------------------------------
rm(my, p, mybinwidth, myc, myfillapha, myheight, myhighlight, mypalette, myr, mytextsize,
   mytitle, mywidth, myx, myxlab, myylab)
```
<br/><br/>



Test for an effect of treatment on initial fitness (shouldnt be one, treatments have not yet been applied!)
```{r}
# BLOCK NOTES ------------------------------------------------------------------
# - all treatment differences within models are nonsignifiant; else COPR120 which has significant differnces among treatments
# - treatment nonsignificant in all models
# 
# - PROBLEMS:
#   - Large eigenvalue warning in all models -- ask CB
# ------------------------------------------------------------------------------

# prep an appropriate dataframe for these tests --------------------------------
#     - The appropriate data frame contains one entry (row) for each fit0 replicate in each environment 
my <- myd[myd$epo %in% c("COPR_A", "SALT_A") & myd$mpar == 1,]
myt1 <- my[,c("epo", "mpasp", "bc1", "treat", "re_fit_r1a", "fit0r1")]; colnames(myt1) <- c("epo", "mpasp", "bc1","treat", "re_fit_a", "fit0")
myt2 <- my[,c("epo", "mpasp", "bc1", "treat", "re_fit_r2a", "fit0r2")]; colnames(myt2) <- c("epo", "mpasp", "bc1","treat", "re_fit_a", "fit0")
myt3 <- my[,c("epo", "mpasp", "bc1", "treat", "re_fit_r3a", "fit0r3")]; colnames(myt3) <- c("epo", "mpasp", "bc1","treat", "re_fit_a", "fit0")
myt4 <- my[,c("epo", "mpasp", "bc1", "treat", "re_fit_r4a", "fit0r4")]; colnames(myt4) <- c("epo", "mpasp", "bc1","treat", "re_fit_a", "fit0")
myt <- rbind(myt1, myt2, myt3, myt4)
myt$treat <- factor(myt$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # Relevel the treatments appropriately. 


# in CM ------------------------------------------------------------------------
my <- myt[myt$epo == "SALT_A" & myt$mpasp == 0.0,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# in SALT40 ------------------------------------------------------------------------
my <- myt[myt$epo == "SALT_A" & myt$mpasp == 0.4,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# in SALT80 ------------------------------------------------------------------------
my <- myt[myt$epo == "SALT_A" & myt$mpasp == 0.8,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# in SALT120 ------------------------------------------------------------------------
my <- myt[myt$epo == "SALT_A" & myt$mpasp == 1.2,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# in COPR40 ------------------------------------------------------------------------
my <- myt[myt$epo == "COPR_A" & myt$mpasp == 0.4,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# in COPR80 ------------------------------------------------------------------------
my <- myt[myt$epo == "COPR_A" & myt$mpasp == 0.8,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# in COPR120 ------------------------------------------------------------------------
my <- myt[myt$epo == "COPR_A" & myt$mpasp == 1.2,]
mymod <- lmer(my$fit0 ~ my$treat + (1|my$bc1), weights = my$re_fit_a, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)))
anova(mymod)

# ----------------------------
rm(my, mymod, myt, myt1, myt2, myt3, myt4, weights)
```
<br/><br/>



As an additional check, assess the relationship between change in fitness,dw, and weight (reads)
```{r}
# BLOCK NOTES ------------------------------------------------------------------
#  - data distribution is approximately hump shaped with mean near 0 (no change in fitness). Higher weights are likely to have fitness values closer to hump mean. This makes sense -- higher weight means more counts recovered at all timepoints means more confidence in fitness calculation, means less likely to pick up spurious increases / decreases in fitness caused by stocahsticity in sampling.
#  - COPR 1.2 and, to a lesser extent, COPR 0.8 have differnent releationships than the other variables. SALT does not share the trend
#  - for self use only, not for inclusion in any publication. will be hard to explain fully and needlessly confusing to the reader.  
# ------------------------------------------------------------------------------

my <- myd[myd$omit == F,]

# look at everything together --------------------------------------------------
myx <- my$dw
myy <- my$re_dw
myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "COPR0.4", "COPR0.8", "COPR1.2", "SALT0.4", "SALT0.8", "SALT1.2"))
mys <- my$treat
myylab <- "Weight (reads)"
myxlab <- "dw"
myhighlight <- "black"
myptalpha <- 0.35
mypalette <- trichromramp_g_bl_rd
mytextsize <- 8
myheight <- 7
mywidth <- 7
mystroke <- 1.5

#mymod <- lmer(myy ~ myx + (myx||paste0(my$mpamt, my$mpasp))); summary(mymod)
p <- ggplot(my, aes(x=myx, y=myy, color = myc))+
  geom_point(aes(color=myc, pch = mys), alpha = myptalpha, stroke = mystroke)+
  # geom_line(aes(y=predict(mymod), group = myc, color = myc), size = 1, alpha = myptalpha)+
  scale_shape_manual(values=1:nlevels(mys))+
  geom_rug(alpha = myptalpha)+
  scale_color_manual(values = mypalette)+
  theme_classic() +
  labs(color = "Treatment") +
  ylab(myylab)+ xlab(myxlab) +
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p
# figure output ----
pdf(file = "000_FitAndWeight_All.pdf", width = mywidth, height = myheight); p; dev.off() # one column wide, equal height


# look at SALT  ----------------------------------------------------------------
my <- myd[myd$epo %in% c("SALT_A", "SALT_B") & myd$omit == F,]
myx <- my$dw
myy <- my$re_dw
myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "SALT0.4", "SALT0.8", "SALT1.2"))
mys <- my$treat
mypalette <- trichromramp_g_bl_rd[c(1,5,6,7)]
myptalpha <- 0.7

#mymod <- lmer(myy ~ myx + (myx||paste0(my$mpamt, my$mpasp))); summary(mymod)
p <- ggplot(my, aes(x=myx, y=myy, color = myc))+
  geom_point(aes(color=myc, pch = mys), alpha = myptalpha, stroke = mystroke)+
  # geom_line(aes(y=predict(mymod), group = myc, color = myc), size = 1, alpha = myptalpha)+
  scale_shape_manual(values=1:nlevels(mys))+
  geom_rug(alpha = myptalpha)+
  scale_color_manual(values = mypalette)+
  theme_classic() +
  labs(color = "Treatment") +
  ylab(myylab)+ xlab(myxlab) +
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p
# figure output ----
pdf(file = "000_FitAndWeight_SALT.pdf", width = mywidth, height = myheight); p; dev.off() # one column wide, equal height



# look at COPR  ----------------------------------------------------------------
my <- myd[myd$epo %in% c("COPR_A", "COPR_B") & myd$omit == F,]
myx <- my$dw
myy <- my$re_dw
myc <- paste0(my$mpamt, my$mpasp); myc <- factor(myc, levels = c("CM0", "COPR0.4", "COPR0.8", "COPR1.2"))
mys <- my$treat
mypalette <- trichromramp_g_bl_rd[c(1,2,3,4)]
myptalpha <- 0.7

#mymod <- lmer(myy ~ myx + (myx||paste0(my$mpamt, my$mpasp))); summary(mymod)
p <- ggplot(my, aes(x=myx, y=myy, color = myc))+
  geom_point(aes(color=myc, pch = mys), alpha = myptalpha, stroke = mystroke)+
  # geom_line(aes(y=predict(mymod), group = myc, color = myc), size = 1, alpha = myptalpha)+
  scale_shape_manual(values=1:nlevels(mys))+
  geom_rug(alpha = myptalpha)+
  scale_color_manual(values = mypalette)+
  theme_classic() +
  labs(color = "Treatment") +
  ylab(myylab)+ xlab(myxlab) +
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p
# figure output ----
pdf(file = "000_FitAndWeight_COPR.pdf", width = mywidth, height = myheight); p; dev.off() # one column wide, equal height


# ------------------------------------------------------------------------------
rm(my, p, myc, myheight, myhighlight, mypalette, myptalpha, mys, mystroke,
   mytextsize, mywidth, myx, myxlab, myy, myylab)
```
<br/><br/>



Plot: SALT (row 1), COPR (row 2), ancestral, evolved, and change in fitness; color by environment
```{r}
my <- myd

# set universal vars -----------------------------------------------------------
mybinwidth <- 0.01
myylab <- "Count"
myxlab <- "fitness"
myhighlight <- "black"
myfillapha <- 0.85
myrugalpha <- 0.2
mypalette_r1 <- trichromramp_g_bl_rd[c(1,5,6,7)]
mypalette_r2 <- trichromramp_g_bl_rd[c(1,2,3,4)]
mytextsize <- 8
myheight <- 8
mywidth <- 8.5
myxlim1 <- c(.6, 1.6); myymax1 <- 800
myxlim2 <- myxlim1; myymax2 <- 300
myxlim3 <- c(-.5, .5); myymax3 <- myymax2
myxlim4 <- c(.6, 1.8); myymax4 <- 1250
myxlim5 <- myxlim4; myymax5 <- 400
myxlim6 <- c(-.3, .9); myymax6 <- myymax5



# Row 1: SALT lines ------------------------------------------------------------
# fit0 -----------------------------------------------------
p <- ggplot(my[my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit0, color = paste0(mpasp), fill = paste0(mpasp), weight = re_fit_a / mean(re_fit_a, na.rm = T))) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim1) +
  ylim(c(NA,myymax1)) +
  scale_color_manual(values =mypalette_r1, guide = FALSE) +
  scale_fill_manual(values =mypalette_r1) +
  theme_classic() +
  theme(legend.position= c(0.8,0.5)) +
  labs(fill = "Assay Environment") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
legend <- get_legend(p)
p <- p + theme(legend.position="none")
psanc <- p

# fit500 ---------------------------------------------------
p <- ggplot(my[my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit500, color = paste0(mpamt, mpasp), fill = paste0(mpasp), weight = re_fit_e / mean(re_fit_e, na.rm = T))) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim2) +
  ylim(c(NA,myymax2)) +
  scale_color_manual(values =mypalette_r1, guide = FALSE) +
  scale_fill_manual(values =mypalette_r1) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Assay Environment") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
psevo <- p

# dw -------------------------------------------------------
p <- ggplot(my[my$epo %in% c("SALT_A", "SALT_B"),], aes(x=dw, color = paste0(mpamt, mpasp), fill = paste0(mpasp), weight = re_dw / mean(re_dw, na.rm = T))) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim3) +
  ylim(c(NA,myymax3)) +
  scale_color_manual(values =mypalette_r1, guide = FALSE) +
  scale_fill_manual(values =mypalette_r1) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Assay Environment") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
psdel <- p



# Row 2: COPR lines ------------------------------------------------------------
# fit0 -----------------------------------------------------
p <- ggplot(my[my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit0, color = paste0(mpamt, mpasp), fill = paste0(mpasp), weight = re_fit_a / mean(re_fit_a, na.rm = T))) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim4) +
  ylim(c(NA,myymax4)) +
  scale_color_manual(values =mypalette_r2, guide = FALSE) +
  scale_fill_manual(values =mypalette_r2) +
  theme_classic() +
  theme(legend.position= c(0.8,0.5)) +
  labs(fill = "Assay Environment") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
legend2 <- get_legend(p)
p <- p + theme(legend.position="none")
pcanc <- p

# fit500 ---------------------------------------------------
p <- ggplot(my[my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit500, color = paste0(mpamt, mpasp),fill = paste0(mpasp), weight = re_fit_e / mean(re_fit_e, na.rm = T))) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim5) +
  ylim(c(NA,myymax5)) +
  scale_color_manual(values =mypalette_r2, guide = FALSE) +
  scale_fill_manual(values =mypalette_r2) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Assay Environment") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
pcevo <- p

# dw -------------------------------------------------------
p <- ggplot(my[my$epo %in% c("COPR_A", "COPR_B"),], aes(x=dw, color = paste0(mpamt, mpasp), fill = paste0(mpasp), weight = re_dw / mean(re_dw, na.rm = T))) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim6) +
  ylim(c(NA,myymax6)) +
  scale_color_manual(values =mypalette_r2, guide = FALSE) +
  scale_fill_manual(values =mypalette_r2) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Assay Environment") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
pcdel <- p



# Plot using grid and output ---------------------------------------------------
pdf(file = "000_fit_cbyenv_full.pdf", width = mywidth, height = myheight)
grid.arrange( grid::textGrob("SALT", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("COPR", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              psanc, psevo, psdel,
              pcanc, pcevo, pcdel,
              legend, 
              grid::textGrob("", gp =grid::gpar(fontsize = 8)),
              grid::textGrob("Generation-0", gp =grid::gpar(fontsize = 12, fontface = "bold")),
              grid::textGrob("Generation-500", gp =grid::gpar(fontsize = 12, fontface = "bold")),
              grid::textGrob("Delta", gp =grid::gpar(fontsize = 12, fontface = "bold")),
              legend2,
  layout_matrix = rbind(c(10, 10,11,11,10, 10,12,12,10,  10,13,13,10,  10, 10),
                        c(1,  3,3,3,3,     4,4,4,4,      5,5,5,5,      9, 10),
                        c(1,  3,3,3,3,     4,4,4,4,      5,5,5,5,      10, 10),
                        c(2,  6,6,6,6,     7,7,7,7,      8,8,8,8,      14, 10),
                        c(2,  6,6,6,6,     7,7,7,7,      8,8,8,8,      10, 10)),
  top = grid::textGrob("\n Yeast Fitness in SALT and COPR", gp =grid::gpar(fontsize = 14, fontface = "bold")))
dev.off() # one column wide, equal height

# -----------------------------------------------------------------------------
rm(my, p, mybinwidth, myfillapha, myheight, myhighlight, mytextsize, mywidth, myxlab, myylab,
   legend, pcanc, pcdel, pcevo, psanc, psdel, psevo, mypalette_r1, mypalette_r2, myrugalpha,
   myxlim1, myxlim2, myxlim3, myxlim4, myxlim5, myxlim6, myymax1, myymax2, myymax3, myymax4,
   myymax5, myymax6, legend2)
```
<br/><br/>



Plot: SALT ancestral, evolved, and change in fitness in CM,salt40, salt80, salt120; color by treatment
```{R}
my <- myd
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

# set universal vars -----------------------------------------------------------
mybinwidth <- 0.01
myylab <- "Count"
myxlab <- "fitness"
myhighlight <- "black"
myfillapha <- 0.95
myrugalpha <- 0.2
mypalette <- dichrompalette_br_cy
mytextsize <- 8
myheight <- 11
mywidth <- 8.5
myxlim_c1_c2 <- c(0.6, 1.6)
myxlim_c3 <- c(-0.5, 0.5)
myymax11 <- 400
myymax12_13 <- 100
myymax21 <- 350
myymax22_23 <- 80
myymax31 <- 250
myymax32_33 <- 40
myymax41 <- 250
myymax42_43 <- 50

# salt anc -----------------------------
# salt anc in 0
p <- ggplot(my[my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax11)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= c(0.7,0.7), legend.key.size = unit(.20, "cm")) +
  labs(fill = "Treatment") +
  ylab(myylab)+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
legend <- get_legend(p)
p <- p + theme(legend.position="none")
p_salt_anc_0 <- p

# salt anc in 40
p <- ggplot(my[my$mpasp == 0.4 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax21)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab(myylab)+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_anc_40 <- p

# salt anc in 80
p <- ggplot(my[my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax31)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab(myylab)+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_anc_80 <- p

# salt anc in 120
p <- ggplot(my[my$mpasp == 1.2 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax41)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_anc_120 <- p

# salt evo -----------------------------
# salt evo in 0
p <- ggplot(my[my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax12_13)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_evo_0 <- p

# salt evo in 40
p <- ggplot(my[my$mpasp == 0.4 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax22_23)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_evo_40 <- p

# salt evo in 80
p <- ggplot(my[my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax32_33)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_evo_80 <- p

# salt evo in 120
p <- ggplot(my[my$mpasp == 1.2 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax42_43)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_evo_120 <- p

# salt delta -----------------------------
# salt delta in 0
p <- ggplot(my[my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax12_13)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_del_0 <- p

# salt evo in 40
p <- ggplot(my[my$mpasp == 0.4 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax22_23)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_del_40 <- p

# salt evo in 80
p <- ggplot(my[my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax32_33)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_del_80 <- p

# salt evo in 120
p <- ggplot(my[my$mpasp == 1.2 & my$epo %in% c("SALT_A", "SALT_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax42_43)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_salt_del_120 <- p

# Plot using grid and output ---------------------------------------------------
pdf(file = "000_SALT_fit_byenv_cbytreat_full.pdf", width = mywidth, height = myheight)
grid.arrange( grid::textGrob("CM, No Stress", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("CM + Salt 40", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("CM + Salt 80", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("CM + Salt 120", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              p_salt_anc_0,p_salt_anc_40,p_salt_anc_80,p_salt_anc_120,
              p_salt_evo_0,p_salt_evo_40,p_salt_evo_80,p_salt_evo_120,
              p_salt_del_0,p_salt_del_40,p_salt_del_80,p_salt_del_120,
             legend, 
             grid::textGrob("", gp =grid::gpar(fontsize = 8)),
             grid::textGrob("Generation-0", gp =grid::gpar(fontsize = 12, fontface = "bold")),
             grid::textGrob("Generation-500", gp =grid::gpar(fontsize = 12, fontface = "bold")),
             grid::textGrob("Delta", gp =grid::gpar(fontsize = 12, fontface = "bold")),
  layout_matrix = rbind(c(18, 18,19,19,18, 18,20,20,18,  18,21,21,18,  18, 18),
                        c(1,  5,5,5,5,     9,9,9,9,      13,13,13,13,  17, 18),
                        c(1,  5,5,5,5,     9,9,9,9,      13,13,13,13,  18, 18),
                        c(2,  6,6,6,6,     10,10,10,10,  14,14,14,14,  18, 18),
                        c(2,  6,6,6,6,     10,10,10,10,  14,14,14,14,  18, 18),
                        c(3,  7,7,7,7,     11,11,11,11,  15,15,15,15,  18, 18),
                        c(3,  7,7,7,7,     11,11,11,11,  15,15,15,15,  18, 18),
                        c(4,  8,8,8,8,     12,12,12,12,  16,16,16,16,  18, 18),
                        c(4,  8,8,8,8,     12,12,12,12,  16,16,16,16,  18, 18)),
  top = grid::textGrob("\n Yeast Fitness (SALT) in Complete Media and Salt Stress Environments", gp =grid::gpar(fontsize = 14, fontface = "bold")))
dev.off() # one column wide, equal height

# ----------------------------
rm(legend, my, p, p_salt_anc_0,  p_salt_anc_40,  p_salt_anc_80,  p_salt_anc_120,
    p_salt_evo_0,  p_salt_evo_40,  p_salt_evo_80,  p_salt_evo_120,
    p_salt_del_0,  p_salt_del_40,  p_salt_del_80,  p_salt_del_120, mybinwidth,
   myfillapha, myheight, myhighlight, mypalette, myrugalpha, mytextsize, mywidth,
   myxlab, myxlim_c1_c2, myxlim_c3, myylab, myymax11, myymax12_13, myymax21, myymax22_23,
   myymax31, myymax32_33, myymax41, myymax42_43, legend2)
```
<br/><br/>



Plot: COPR ancestral, evolved, and change in fitness in CM, copr40, copr80, copr120; color by treatment
```{R}
my <- myd
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

# set universal vars -----------------------------------------------------------
mybinwidth <- 0.01
myylab <- "Count"
myxlab <- "fitness"
myhighlight <- "black"
myfillapha <- 0.95
myrugalpha <- 0.2
mypalette <- dichrompalette_br_cy
mytextsize <- 8
myheight <- 11
mywidth <- 8.5
myxlim_c1_c2 <- c(0.6, 1.8)
myxlim_c3 <- c(-0.5, 0.9)
myymax11 <- 400
myymax12_13 <- 60
myymax21 <- 400
myymax22_23 <- 60
myymax31 <- 400
myymax32_33 <- 20
myymax41 <- 120
myymax42_43 <- 15

# copr anc -----------------------------
# copr anc in 0
p <- ggplot(my[my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax11)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= c(0.7,0.7), legend.key.size = unit(.20, "cm")) +
  labs(fill = "Treatment") +
  ylab(myylab)+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
legend <- get_legend(p)
p <- p + theme(legend.position="none")
p_copr_anc_0 <- p

# copr anc in 40
p <- ggplot(my[my$mpasp == 0.4 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax21)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab(myylab)+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_anc_40 <- p

# copr anc in 80
p <- ggplot(my[my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax31)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab(myylab)+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_anc_80 <- p

# copr anc in 120
p <- ggplot(my[my$mpasp == 1.2 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit0, color = treat, fill = treat), weight = re_fit_a / mean(re_fit_a, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax41)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab(myylab)+ xlab(myxlab)+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_anc_120 <- p

# copr evo -----------------------------
# copr evo in 0
p <- ggplot(my[my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax12_13)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_evo_0 <- p

# copr evo in 40
p <- ggplot(my[my$mpasp == 0.4 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax22_23)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_evo_40 <- p

# copr evo in 80
p <- ggplot(my[my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax32_33)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_evo_80 <- p

# copr evo in 120
p <- ggplot(my[my$mpasp == 1.2 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=fit500, color = treat, fill = treat), weight = re_fit_e / mean(re_fit_e, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c1_c2) +
  ylim(c(NA,myymax42_43)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_evo_120 <- p

# copr delta -----------------------------
# copr delta in 0
p <- ggplot(my[my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax12_13)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_del_0 <- p

# copr evo in 40
p <- ggplot(my[my$mpasp == 0.4 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax22_23)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_del_40 <- p

# copr evo in 80
p <- ggplot(my[my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax32_33)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_del_80 <- p

# copr evo in 120
p <- ggplot(my[my$mpasp == 1.2 & my$epo %in% c("COPR_A", "COPR_B"),], aes(x=dw, color = treat, fill = treat), weight = re_dw / mean(re_dw, na.rm = T)) +
  geom_histogram(alpha = myfillapha, position = "stack", binwidth = mybinwidth, lwd = 0, lty = 0) +
  geom_rug(alpha = myrugalpha)+
  xlim(myxlim_c3) +
  ylim(c(NA,myymax42_43)) +
  scale_color_manual(values =mypalette, guide = FALSE) + 
  scale_fill_manual(values =mypalette) +
  theme_classic() +
  theme(legend.position= "none") +
  labs(fill = "Significance") +
  ylab("")+ xlab("")+
  theme(axis.title.y = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = mytextsize, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = mytextsize, angle = 0))+
  theme(axis.text.x = element_text(size = mytextsize, angle = 0))+
  theme(legend.title = element_text(size = mytextsize, face = "bold"))+
  theme(legend.text = element_text(size = mytextsize))
p_copr_del_120 <- p

# Plot using grid and output ---------------------------------------------------
pdf(file = "000_COPR_fit_byenv_cbytreat_full.pdf", width = mywidth, height = myheight)
grid.arrange( grid::textGrob("CM, No Stress", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("CM + Copr 40", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("CM + Copr 80", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              grid::textGrob("CM + Copr 120", gp =grid::gpar(fontsize = 8, fontface = "bold"), rot = 90),
              p_copr_anc_0,p_copr_anc_40,p_copr_anc_80,p_copr_anc_120,
              p_copr_evo_0,p_copr_evo_40,p_copr_evo_80,p_copr_evo_120,
              p_copr_del_0,p_copr_del_40,p_copr_del_80,p_copr_del_120,
             legend, 
             grid::textGrob("", gp =grid::gpar(fontsize = 8)),
             grid::textGrob("Generation-0", gp =grid::gpar(fontsize = 12, fontface = "bold")),
             grid::textGrob("Generation-500", gp =grid::gpar(fontsize = 12, fontface = "bold")),
             grid::textGrob("Delta", gp =grid::gpar(fontsize = 12, fontface = "bold")),
  layout_matrix = rbind(c(18, 18,19,19,18, 18,20,20,18,  18,21,21,18,  18, 18),
                        c(1,  5,5,5,5,     9,9,9,9,      13,13,13,13,  17, 18),
                        c(1,  5,5,5,5,     9,9,9,9,      13,13,13,13,  18, 18),
                        c(2,  6,6,6,6,     10,10,10,10,  14,14,14,14,  18, 18),
                        c(2,  6,6,6,6,     10,10,10,10,  14,14,14,14,  18, 18),
                        c(3,  7,7,7,7,     11,11,11,11,  15,15,15,15,  18, 18),
                        c(3,  7,7,7,7,     11,11,11,11,  15,15,15,15,  18, 18),
                        c(4,  8,8,8,8,     12,12,12,12,  16,16,16,16,  18, 18),
                        c(4,  8,8,8,8,     12,12,12,12,  16,16,16,16,  18, 18)),
  top = grid::textGrob("\n Yeast Fitness (COPR) in Complete Media and Copr Stress Environments", gp =grid::gpar(fontsize = 14, fontface = "bold")))
dev.off() # one column wide, equal height

# ----------------------------
rm(legend, my, p, p_copr_anc_0,  p_copr_anc_40,  p_copr_anc_80,  p_copr_anc_120,
    p_copr_evo_0,  p_copr_evo_40,  p_copr_evo_80,  p_copr_evo_120,
    p_copr_del_0,  p_copr_del_40,  p_copr_del_80,  p_copr_del_120, mybinwidth,
   myfillapha, myheight, myhighlight, mypalette, myrugalpha, mytextsize, mywidth,
   myxlab, myxlim_c1_c2, myxlim_c3, myylab, myymax11, myymax12_13, myymax21, myymax22_23,
   myymax31, myymax32_33, myymax41, myymax42_43)
```
<br/><br/>



ASSESS: FITNESS CHANGE IN 500 GENERATIONS OF EVOLUTION ACROSS 7 TREATMENTS IN 4 ENVIRONMENTS AND 2 CHEMICAL STRESSORS 
Create an appropriate data frame with 1 entry per bcpID (rather than 1 entry per rep*bcpID)
```{r}
# create the frame, omitting most cols not necessary for these upcoming plots and tests.
my <- myd
my <- my[,c(1:7, 83:88, 112, 123, 126)] # reatain only interst columns
my1 <- my[my$mpar == 1,] # r1
my2 <- my[my$mpar == 2,]; colnames(my2) <- paste0(colnames(my2), "_2") # r2
my3 <- my[my$mpar == 3,]; colnames(my3) <- paste0(colnames(my3), "_3") # r3
my4 <- my[my$mpar == 4,]; colnames(my4) <- paste0(colnames(my4), "_4") # r4
my <- cbind(my1, my2$re_dw_2, my2$dw_2, my3$re_dw_3, my3$dw_3, my4$re_dw_4, my4$dw_4) # zip
colnames(my)[c((ncol(my)-5)):ncol(my)] <- c("re_dw_2", "dw_2", "re_dw_3", "dw_3", "re_dw_4", "dw_4") # name fix
mn_dw <- apply(my, 1, function(x) weighted.mean(as.numeric(x[c( "dw", "dw_2", "dw_3", "dw_4")]), 
                                                  as.numeric(x[c( "re_dw","re_dw_2","re_dw_3","re_dw_4")]), na.rm = T)) # calculate wtd.mean dw across reps
my$mn_dw <- mn_dw; my$mn_dw[is.nan(my$mn_dw)] <- NA # fix nans
my$omit <- F; my$omit[is.na(my$mn_dw)] <- T # update omit field
mn_re_dw <- apply(my, 1, function(x) mean(as.numeric(x[c( "re_dw", "re_dw_2", "re_dw_3", "re_dw_4")]), na.rm =T)) # calculate reads for mn_dw
my$mn_re_dw <- mn_re_dw # assign
mydwc <- my # name frame

# While we are at it lets make a wide version as well, this will be needed later.
my <- mydwc
my0 <- my[my$mpasp == 0.0,]
my40 <- my[my$mpasp == 0.4,]
my80 <- my[my$mpasp == 0.8,]
my120 <- my[my$mpasp == 1.2,]
sum(my0$bcpID != my40$bcpID)
my <- cbind(my0, my40$mn_dw, my40$mn_re_dw, my80$mn_dw, my80$mn_re_dw, my120$mn_dw, my120$mn_re_dw)
colnames(my)[c(23:30)] <- c("mn_dw_0", "mn_re_dw_0","mn_dw_40", "mn_re_dw_40", "mn_dw_80", "mn_re_dw_80", "mn_dw_120", "mn_re_dw_120")
mydwcw <- my

# also need to make a 1-well per row version of the mydwc dataframe
my <- mydwc
myg <- NA
my$colid <- paste0(my$epo, my$mpasp, my$well)
for (i in unique(my$colid)) {
  myt <- my[my$colid == i,]
  myt1 <- myt[1, c("epo","mpamt","mpasp","bc1","bc2","treat","min","max","colid","mn_dw","mn_re_dw")]
  myt2 <- myt[2, c("epo","mpamt","mpasp","bc1","bc2","treat","min","max","colid","mn_dw","mn_re_dw")]
  colnames(myt2) <- paste0(colnames(myt2), "_bc2")
  myt <- cbind(myt1, myt2[,c("mn_dw_bc2", "mn_re_dw_bc2")])
  myg <- rbind(myg, myt)
}

myg$ps <- NA
myg$ps[is.na(myg$mn_dw) & is.na(myg$mn_dw_bc2)] <- "XX"
myg$ps[myg$mn_dw > 0 & is.na(myg$mn_dw_bc2)] <- "IX"
myg$ps[is.na(myg$mn_dw) & myg$mn_dw_bc2 > 0] <- "IX"
myg$ps[myg$mn_dw < 0 & is.na(myg$mn_dw_bc2)] <- "DX"
myg$ps[is.na(myg$mn_dw) & myg$mn_dw_bc2 < 0] <- "DX"
myg$ps[myg$mn_dw > 0 & myg$mn_dw_bc2 > 0] <- "II"
myg$ps[myg$mn_dw > 0 & myg$mn_dw_bc2 < 0] <- "ID"
myg$ps[myg$mn_dw < 0 & myg$mn_dw_bc2 > 0] <- "ID"
myg$ps[myg$mn_dw < 0 & myg$mn_dw_bc2 < 0] <- "DD"
myg$ps <- factor(myg$ps, levels = c("II", "ID", "DD", "IX", "DX", "XX"))

welldata <- myg[2:nrow(myg),]
welldata <- welldata[welldata$bc1 != "d1C5" & welldata$bc1 != "d1C9",]

# ------------------
rm(my, my1, my2, my3, my4, mn_dw, mn_re_dw, my0, my40, my80, my120, myg, myt1, myt, myt2, i)
```
<br/><br/>



# visualize w/in well differences
```{r}
# for SALT condensed ---------------------------------------------------------------------
my <- welldata[welldata$epo %in% c("SALT_A", "SALT_B"),]
my$id <- paste0(my$epo, my$bc1)
my0 <- my[my$mpasp == 0.0,]
my40 <- my[my$mpasp == 0.4,]; colnames(my40)[10:13] <- paste0(colnames(my40)[10:13], "_40")
my80 <- my[my$mpasp == 0.8,]; colnames(my80)[10:13] <- paste0(colnames(my80)[10:13], "_80")
my120 <- my[my$mpasp == 1.2,]; colnames(my120)[10:13] <- paste0(colnames(my120)[10:13], "_120")
sum(my0$id != my40$id)

my <- cbind(my0,my40[,10:13], my80[,10:13], my120[,10:13])
my$diff_0 <- my$mn_dw - my$mn_dw_bc2
my$diff_80 <- my$mn_dw_80 - my$mn_dw_bc2_80

for (i in 1:nrow(my)) {
  if(!is.na(my$diff_0[i])&!is.na(my$diff_80[i])){
    if(my$diff_0[i] < 0 & my$diff_80[i] < 0){
      my$diff_0[i] <- abs(my$diff_0[i])
      my$diff_80[i] <- abs(my$diff_80[i])
    }
    if(my$diff_0[i] > 0 & my$diff_80[i] < 0){
    my$diff_0[i] <- -1*my$diff_0[i]
    my$diff_80[i] <- -1*my$diff_80[i]
    }
  }
}
my$diff_0 <- scale(my$diff_0, center = F)
my$diff_80 <- scale(my$diff_80, center = F)

p <- ggplot(my, aes(x=diff_0, y=diff_80, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=0, y=0, xend=2.5, yend=2.5), linetype="dashed", size=0.5, inherit.aes=F)+
  geom_segment(mapping = aes(x=0, y=0, xend=-2.5, yend=2.5), linetype="solid", size=0.5, inherit.aes=F)+
  geom_point(size = 5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 5)+
  coord_equal()+
  geom_rug()+ 
  geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$diff_0^2 + my$diff_80^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$diff_0 > 0  & dendata$diff_80 > 0)] <- "Same Sign"
dendata$group[which((dendata$diff_0 < 0 & dendata$diff_80 > 0) | (dendata$diff_0 > 0 & dendata$diff_80 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_SALT_WellDifferences_00_80.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()


# for COPR condensed ---------------------------------------------------------------------
my <- welldata[welldata$epo %in% c("COPR_A", "COPR_B"),]
my$id <- paste0(my$epo, my$bc1)
my0 <- my[my$mpasp == 0.0,]
my40 <- my[my$mpasp == 0.4,]; colnames(my40)[10:13] <- paste0(colnames(my40)[10:13], "_40")
my80 <- my[my$mpasp == 0.8,]; colnames(my80)[10:13] <- paste0(colnames(my80)[10:13], "_80")
my120 <- my[my$mpasp == 1.2,]; colnames(my120)[10:13] <- paste0(colnames(my120)[10:13], "_120")
sum(my0$id != my40$id)

my <- cbind(my0,my40[,10:13], my80[,10:13], my120[,10:13])
my$diff_0 <- my$mn_dw - my$mn_dw_bc2
my$diff_80 <- my$mn_dw_80 - my$mn_dw_bc2_80

for (i in 1:nrow(my)) {
  if(!is.na(my$diff_0[i])&!is.na(my$diff_80[i])){
    if(my$diff_0[i] < 0 & my$diff_80[i] < 0){
      my$diff_0[i] <- abs(my$diff_0[i])
      my$diff_80[i] <- abs(my$diff_80[i])
    }
    if(my$diff_0[i] > 0 & my$diff_80[i] < 0){
    my$diff_0[i] <- -1*my$diff_0[i]
    my$diff_80[i] <- -1*my$diff_80[i]
    }
  }
}
my$diff_0 <- scale(my$diff_0, center = F)
my$diff_80 <- scale(my$diff_80, center = F)

p <- ggplot(my, aes(x=diff_0, y=diff_80, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=0, y=0, xend=2.5, yend=2.5), linetype="dashed", size=0.5, inherit.aes=F)+
  geom_segment(mapping = aes(x=0, y=0, xend=-2.5, yend=2.5), linetype="solid", size=0.5, inherit.aes=F)+
  geom_point(size = 5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 5)+
  coord_equal()+
  geom_rug()+ 
  geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$diff_0^2 + my$diff_80^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$diff_0 > 0  & dendata$diff_80 > 0)] <- "Same Sign"
dendata$group[which((dendata$diff_0 < 0 & dendata$diff_80 > 0) | (dendata$diff_0 > 0 & dendata$diff_80 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_COPR_WellDifferences_00_80.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()
rm(dendata, my, my0, my120, my40, my80, p, p1, q, q1, x, i)
```


# visualize fitness in two environments (00 and 80)
```{r}
# for SALT  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

my$id <- paste0(my$epo, my$bc1)
x <- my$mn_dw_0
my$mn_dw_0 <- scale(my$mn_dw_0, center = F)
my$mn_dw_80 <- scale(my$mn_dw_80, center = F)

p <- ggplot(my, aes(x=mn_dw_0, y=mn_dw_80, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$mn_dw_0^2 + my$mn_dw_80^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$mn_dw_0 > 0  & dendata$mn_dw_80 > 0)] <- "Same Sign"
dendata$group[which((dendata$mn_dw_0 < 0 & dendata$mn_dw_80 > 0) | (dendata$mn_dw_0 > 0 & dendata$mn_dw_80 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_SALT_BCDifferences_00_80.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()


# for COPR  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
my$id <- paste0(my$epo, my$bc1)

my$mn_dw_0 <- scale(my$mn_dw_0, center = F)
my$mn_dw_80 <- scale(my$mn_dw_80, center = F)

p <- ggplot(my, aes(x=mn_dw_0, y=mn_dw_80, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$mn_dw_0^2 + my$mn_dw_80^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$mn_dw_0 > 0  & dendata$mn_dw_80 > 0)] <- "Same Sign"
dendata$group[which((dendata$mn_dw_0 < 0 & dendata$mn_dw_80 > 0) | (dendata$mn_dw_0 > 0 & dendata$mn_dw_80 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_COPR_BCDifferences_00_80.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()
rm(dendata, my, p, p1, q, q1, x)
```

# visualize fitness in two environments (00 and 80) NO DENSITY
```{r}
# for SALT  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

my$id <- paste0(my$epo, my$bc1)
x <- my$mn_dw_0
my$Fitness_in_CM <- scale(my$mn_dw_0, center = F)
my$Fitness_in_High_Stress <- scale(my$mn_dw_80, center = F)

mypalette <- dichrompalette_br_cy
p <- ggplot(my, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

p1 <- p + facet_wrap(~Treatment, nrow = 2)
p2 <- p + theme(legend.position = "none")


x <- grid.arrange(p2, p1,
             widths = c(1,2))
grid::grid.draw(x)
# 


pdf(file = paste("000_SALT_BCDifferences_00_80_clean.pdf"),height = 6, width = 18); grid::grid.draw(x); dev.off()


rm(dendata, my, p, p1, q, q1, x)
```


# visualize fitness in two environments (00 and 40)
```{r}
# for SALT  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$id <- paste0(my$epo, my$bc1)
x <- my$mn_dw_0
my$mn_dw_0 <- scale(my$mn_dw_0, center = F)
my$mn_dw_40 <- scale(my$mn_dw_40, center = F)

p <- ggplot(my, aes(x=mn_dw_0, y=mn_dw_40, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$mn_dw_0^2 + my$mn_dw_40^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$mn_dw_0 > 0  & dendata$mn_dw_40 > 0)] <- "Same Sign"
dendata$group[which((dendata$mn_dw_0 < 0 & dendata$mn_dw_40 > 0) | (dendata$mn_dw_0 > 0 & dendata$mn_dw_40 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_SALT_BCDifferences_00_40.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()


# for COPR  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
my$id <- paste0(my$epo, my$bc1)

my$mn_dw_0 <- scale(my$mn_dw_0, center = F)
my$mn_dw_40 <- scale(my$mn_dw_40, center = F)

p <- ggplot(my, aes(x=mn_dw_0, y=mn_dw_40, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$mn_dw_0^2 + my$mn_dw_40^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$mn_dw_0 > 0  & dendata$mn_dw_40 > 0)] <- "Same Sign"
dendata$group[which((dendata$mn_dw_0 < 0 & dendata$mn_dw_40 > 0) | (dendata$mn_dw_0 > 0 & dendata$mn_dw_40 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_COPR_BCDifferences_00_40.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()
rm(dendata, my, p, p1, q, q1, x)
```

# visualize fitness in two environments (40 and 80)
```{r}
# for SALT  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$id <- paste0(my$epo, my$bc1)
x <- my$mn_dw_40
my$mn_dw_40 <- scale(my$mn_dw_40, center = F)
my$mn_dw_80 <- scale(my$mn_dw_80, center = F)

p <- ggplot(my, aes(x=mn_dw_40, y=mn_dw_80, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$mn_dw_40^2 + my$mn_dw_80^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$mn_dw_40 > 0  & dendata$mn_dw_80 > 0)] <- "Same Sign"
dendata$group[which((dendata$mn_dw_40 < 0 & dendata$mn_dw_80 > 0) | (dendata$mn_dw_40 > 0 & dendata$mn_dw_80 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_SALT_BCDifferences_40_80.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()


# for COPR  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
my$id <- paste0(my$epo, my$bc1)

my$mn_dw_40 <- scale(my$mn_dw_40, center = F)
my$mn_dw_80 <- scale(my$mn_dw_80, center = F)

p <- ggplot(my, aes(x=mn_dw_40, y=mn_dw_80, color=treat, fill = treat)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_segment(mapping = aes(x=-2, y=-2, xend=2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_segment(mapping = aes(x=2, y=-2, xend=-2, yend=2), linetype="dashed", size=0.5, inherit.aes=F, alpha = 0.25)+
  geom_point(size = 2.5, alpha = 0.5) + 
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  coord_equal()+
  geom_rug()
  # geom_density_2d(aes(colour = treat, alpha = ..piece..))

my$disto <- sqrt(my$mn_dw_40^2 + my$mn_dw_80^2) 

dendata <- my
dendata$group <- NA
dendata$group[which(dendata$mn_dw_40 > 0  & dendata$mn_dw_80 > 0)] <- "Same Sign"
dendata$group[which((dendata$mn_dw_40 < 0 & dendata$mn_dw_80 > 0) | (dendata$mn_dw_40 > 0 & dendata$mn_dw_80 < 0))] <- "Opposite Sign"


q <- ggplot(dendata, aes(x= disto,color= treat, linetype = group)) +
  geom_density(alpha = 0.1, trim = F)


p1 <- p + facet_wrap(~treat, nrow = 1)
q1 <- q + facet_wrap(~treat, nrow = 1)
p1 <- ggplotGrob(p1)
q1 <- ggplotGrob(q1)
# 
x <-rbind(p1, q1, size = "first")
x$widths <- grid::unit.pmax(p1$widths, q1$widths)
grid::grid.newpage()
grid::grid.draw(x)

pdf(file = paste("000_COPR_BCDifferences_40_80.pdf"),height = 11, width = 17); grid::grid.draw(x); dev.off()
rm(dendata, my, p, p1, q, q1, x)
```




# Look at within well VS between well fitness differences!
```{r}
my <- mydwcw
my <- my[!(my$bcID %in% c("d1C5", "d2C5", "d1C9", "d2C9", "d1C4", "d2C4", "d1D8", "d2D8", "d1E8", "d2E8")),]

my$wd0 <- NA
my$wd40 <- NA
my$wd80 <- NA
my$wd120 <- NA

for (i in 1:nrow(my)) {
  my$wd0[i] <- abs(my$mn_dw_0[i] - my$mn_dw_0[my$bc2 == my$bc1[i] & my$epo == my$epo[i]])
  my$wd40[i] <- abs(my$mn_dw_40[i] - my$mn_dw_40[my$bc2 == my$bc1[i] & my$epo == my$epo[i]])
  my$wd80[i] <- abs(my$mn_dw_80[i] - my$mn_dw_80[my$bc2 == my$bc1[i] & my$epo == my$epo[i]])
  my$wd120[i] <- abs(my$mn_dw_120[i] - my$mn_dw_120[my$bc2 == my$bc1[i] & my$epo == my$epo[i]])
}
# sum(is.na(my$mn_dw_0))
# sum(is.na(my$wd0))

my$td0_mn <- NA; my$td0_se <- NA
my$td40_mn <- NA; my$td40_se <- NA
my$td80_mn <- NA; my$td80_se <- NA
my$td120_mn <- NA; my$td120_se <- NA
for (i in 1:nrow(my)) {
  pids <- c(paste0(substring(my$epo[i], 1,4), "_A"), paste0(substring(my$epo[i], 1,4), "_B"))
  tmp_data <- my[my$epo %in% pids & my$treat == my$treat[i],]
  ind <- as.character(my$bcpID[i])
  
  tmp_diffs0 <- abs(tmp_data$mn_dw_0[tmp_data$bcpID == ind] - tmp_data$mn_dw_0[tmp_data$bcpID != ind])
  my$td0_mn[i] <- mean(tmp_diffs0, na.rm = T)
  my$td0_se[i] <- sjstats::se(tmp_diffs0, na.rm = T)
  
  tmp_diffs40 <- abs(tmp_data$mn_dw_40[tmp_data$bcpID == ind] - tmp_data$mn_dw_40[tmp_data$bcpID != ind])
  my$td40_mn[i] <- mean(tmp_diffs40, na.rm = T)
  my$td40_se[i] <- sjstats::se(tmp_diffs40, na.rm = T)
    
  tmp_diffs80 <-  abs(tmp_data$mn_dw_80[tmp_data$bcpID == ind] - tmp_data$mn_dw_80[tmp_data$bcpID != ind])
  my$td80_mn[i] <- mean(tmp_diffs80, na.rm = T)
  my$td80_se[i] <- sjstats::se(tmp_diffs80, na.rm = T)
   
  tmp_diffs120 <-  abs(tmp_data$mn_dw_120[tmp_data$bcpID == ind] - tmp_data$mn_dw_120[tmp_data$bcpID != ind])
  my$td120_mn[i] <- mean(tmp_diffs120, na.rm = T)
  my$td120_se[i] <- sjstats::se(tmp_diffs120, na.rm = T)
}
mydwcw <- my
# now have well difference and treatment difference for each row. 
# When analying need to only count one copy of the well differece data (not for bc1 v bc2 AND bc2 v bc2), but should keep all of the treatment difference data!
# This gives us one entry per well for our distribution of within well difference in fit and one entry per bcid for our distribution of treatment difference in fit.

rm(my, tmp_data, i, ind, pids, tmp_diffs0, tmp_diffs120, tmp_diffs40, tmp_diffs80)
```

```{r}
mytrim <- F
mywidth <- 7
myheight <- 7

envs <- c(0,40,80,120) #0,40,80,120
for (env in envs) {
  mywdn <- paste0("wd", env)
  tdn_mn <-paste0("td", env, "_mn")
  
  SaltOutByTreat <- paste0("000_WvT_ByTreat_SALT_", env, ".pdf")
  SaltOutIgTreat <- paste0("000_WvT_IgTreat_SALT_", env, ".pdf")
  SaltOutCvF <- paste0("000_WvT_CvF_SALT_", env, ".pdf")
  
  CoprOutByTreat <- paste0("000_WvT_ByTreat_COPR_", env, ".pdf")
  CoprOutIgTreat <- paste0("000_WvT_IgTreat_COPR_", env, ".pdf")
  CoprOutCvF <- paste0("000_WvT_CvF_COPR_", env, ".pdf")
  
  # all treats by chemical, sep by treat ---------------------------------------------
  my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
  my$wdn <- my[, mywdn]; my$tdn_mn <- my[, tdn_mn]
  myt <- my[,c("wdn","tdn_mn", "treat")]
  sum(myt$wdn[(nrow(myt)/2+1):nrow(myt)] != myt$wdn[1:(nrow(myt)/2)], na.rm = T)
  myt$wdn[(nrow(myt)/2+1):nrow(myt)] <- NA
  myt <- reshape::melt(myt)
  p <- ggplot(myt, aes(x=value, color = treat, lty = variable))+
    geom_density(alpha = 0.1, trim = mytrim)+
    xlim(min(myt$value, na.rm = T), max(myt$value, na.rm = T))+
    theme_tufte(base_family="Helvetica")+xlab("Difference in deltaFitness")
  pdf(file = paste(SaltOutByTreat), width = mywidth, height = myheight); print(p); dev.off()
  
  
  
  my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
  my$wdn <- my[, mywdn]; my$tdn_mn <- my[, tdn_mn]
  myt <- my[,c("wdn","tdn_mn", "treat")]
  sum(myt$wdn[(nrow(myt)/2+1):nrow(myt)] != myt$wdn[1:(nrow(myt)/2)], na.rm = T)
  myt$wdn[(nrow(myt)/2+1):nrow(myt)] <- NA
  myt <- reshape::melt(myt)
  p <- ggplot(myt, aes(x=value, color = treat, lty = variable))+
    geom_density(alpha = 0.1, trim = mytrim)+
    xlim(min(myt$value, na.rm = T), max(myt$value, na.rm = T))+
    theme_tufte(base_family="Helvetica")+xlab("Difference in deltaFitness")
  pdf(file = paste(CoprOutByTreat), width = mywidth, height = myheight); print(p); dev.off()
  
  
  # by chemical, ignore treats -------------------------------------------------------
  my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
  my$wdn <- my[, mywdn]; my$tdn_mn <- my[, tdn_mn]
  myt <- my[,c("wdn","tdn_mn", "treat")]
  sum(myt$wdn[(nrow(myt)/2+1):nrow(myt)] != myt$wdn[1:(nrow(myt)/2)], na.rm = T)
  myt$wdn[(nrow(myt)/2+1):nrow(myt)] <- NA
  myt <- reshape::melt(myt)
  p <- ggplot(myt, aes(x=value, lty = variable))+
    geom_density(alpha = 0.1, trim = mytrim)+
    xlim(min(myt$value, na.rm = T), max(myt$value, na.rm = T))+
    theme_tufte(base_family="Helvetica")+xlab("Difference in deltaFitness")
  pdf(file = paste(SaltOutIgTreat), width = mywidth, height = myheight); print(p); dev.off()
  
  my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
  my$wdn <- my[, mywdn]; my$tdn_mn <- my[, tdn_mn]
  myt <- my[,c("wdn","tdn_mn", "treat")]
  sum(myt$wdn[(nrow(myt)/2+1):nrow(myt)] != myt$wdn[1:(nrow(myt)/2)], na.rm = T)
  myt$wdn[(nrow(myt)/2+1):nrow(myt)] <- NA
  myt <- reshape::melt(myt)
  p <- ggplot(myt, aes(x=value, lty = variable))+
    geom_density(alpha = 0.1, trim = mytrim)+
    xlim(min(myt$value, na.rm = T), max(myt$value, na.rm = T))+
    theme_tufte(base_family="Helvetica")+xlab("Difference in deltaFitness")
  pdf(file = paste(CoprOutIgTreat), width = mywidth, height = myheight); print(p); dev.off()
  
  
  # by chemical, treats by const vs flux ----------------------------------------------
  my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
  my$group <- NA
  my$group[my$treat %in% c("EH0", "EH40", "EH80")] <- "constant" 
  my$group[my$treat %in% c("EH0_40", "EH20_60", "EH0_80", "EH40_80")] <- "flux" 
  my$wdn <- my[, mywdn]; my$tdn_mn <- my[, tdn_mn]
  myt <- my[,c("wdn","tdn_mn", "treat", "group")]
  sum(myt$wdn[(nrow(myt)/2+1):nrow(myt)] != myt$wdn[1:(nrow(myt)/2)], na.rm = T)
  myt$wdn[(nrow(myt)/2+1):nrow(myt)] <- NA
  myt <- reshape::melt(myt)
  p <- ggplot(myt, aes(x=value,color = group, lty = variable))+
    geom_density(alpha = 0.1, trim = mytrim)+
    xlim(min(myt$value, na.rm = T), max(myt$value, na.rm = T))+
    theme_tufte(base_family="Helvetica")+xlab("Difference in deltaFitness")
  pdf(file = paste(SaltOutCvF), width = mywidth, height = myheight); print(p); dev.off()
  
  
  my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
  my$group <- NA
  my$group[my$treat %in% c("EH0", "EH40", "EH80")] <- "constant" 
  my$group[my$treat %in% c("EH0_40", "EH20_60", "EH0_80", "EH40_80")] <- "flux" 
  my$wdn <- my[, mywdn]; my$tdn_mn <- my[, tdn_mn]
  myt <- my[,c("wdn","tdn_mn", "treat", "group")]
  sum(myt$wdn[(nrow(myt)/2+1):nrow(myt)] != myt$wdn[1:(nrow(myt)/2)], na.rm = T)
  myt$wdn[(nrow(myt)/2+1):nrow(myt)] <- NA
  myt <- reshape::melt(myt)
  p <- ggplot(myt, aes(x=value,color = group, lty = variable))+
    geom_density(alpha = 0.1, trim = mytrim)+
    xlim(min(myt$value, na.rm = T), max(myt$value, na.rm = T))+
    theme_tufte(base_family="Helvetica")+xlab("Difference in deltaFitness")
  pdf(file = paste(CoprOutCvF), width = mywidth, height = myheight); print(p); dev.off()
  
}
rm(my, myt, p, CoprOutByTreat, CoprOutCvF, CoprOutIgTreat, env, envs, myheight, mytrim, mywdn, mywidth, SaltOutByTreat, SaltOutCvF, SaltOutIgTreat, tdn_mn)
```






# look at extinction pre-fit assay -- patterns are a little weaker here than if the post fit assay data are used. 
NOTE: THIS BLOCK TO BE REMOVED.
```{r}
# # create the frame, omitting most cols not necessary for these upcoming plots and tests.
# my <- myd[myd$mpar == 1 & myd$epo %in% c("SALT_A", "SALT_B") & myd$mpasp == 0.0,]
# my <- my[,c("treat", "bc1cts_i_e")]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# summary(my$treat[my$bc1cts_i_e <= 15])
# # summary(my$treat[my$bc1cts_i_e <= 100])
# # summary(my$treat[my$bc1cts_i_e <= 250])
# # summary(my$treat[my$bc1cts_i_e <= 5000000000])
# 
# 
# 
# my <- myd[myd$mpar == 1 & myd$epo %in% c("COPR_A", "COPR_B") & myd$mpasp == 0.0,]
# my$omit <- FALSE
# my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
# my <- my[my$omit == FALSE,]
# my <- my[,c("treat", "bc1cts_i_e")]
# my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
# summary(my$treat[my$bc1cts_i_e <= 15])
# # summary(my$treat[my$bc1cts_i_e <= 100])
# # summary(my$treat[my$bc1cts_i_e <= 250])
# # summary(my$treat[my$bc1cts_i_e <= 500])
# 
# # ------------------
# rm(my)
```



Power Analyses
```{r}
# get data and prep for power analysis
my <- myd
my$id <- paste0(my$bc1, my$epo, my$mpasp)

# power to detect treatment differences (LMER model) -----------------------------------------------
# Run model ------------------------------------------------
mymod <- lm(my$dw ~ my$id, weights = my$re_dw)
x <- summary(mymod)

# get effect size ------------------------------------------
# effect size = f2 = 1/(rmse*100)
myrmse <- sqrt(mean(residuals(mymod)^2))*100 # this is the rmse from the model*100 --> effect size of 1 corresonds to an ~2.54% fitness change 
myeffectsize <- 1/myrmse # effect size of 1 is a 2.54% fitnesss change, so for a fitness change of 1.00, expect effect size of 1/myrmse
mypowersize <- (pwr.f2.test(u = 1, v=64-1-1, f2 = myeffectsize, sig.level = 0.05))$power # powersize for plotting below
# cohen.ES(test="f2", "small"); cohen.ES(test="f2", "medium"); cohen.ES(test="f2", "large") # our effect size is LARGE according to cohen. (0.393938869...)
mypowersize <- (pwr.f2.test(u = 1, v=64-1-1, f2 = myeffectsize*0.393, sig.level = 0.05))$power # powersize for plotting below

# prepare plot data ----------------------------------------
mypower <- matrix(nrow=100, ncol = 5); colnames(mypower) <- c("u", "v", "power", "f2", "sig.level")
mypower <- as.data.frame(mypower)
mypower$u <- 1
mypower$v <- c(62, 62*0.9, 62*0.8, 62*0.7, 62*0.6, 62*0.5, 62*0.4, 62*0.3, 62*0.2, 62*0.1) # n - v - u = 64 - 1-1 = 62
mypower$power <- NA
mypower$f2 <- c(rep(myeffectsize*2,10), rep(myeffectsize*1.75,10), rep(myeffectsize*1.5,10),
                rep(myeffectsize*1.25,10), rep(myeffectsize*1,10), rep(myeffectsize*.75,10), 
                rep(myeffectsize*.5,10), rep(myeffectsize*.25,10),  rep(myeffectsize*.1,10),  rep(myeffectsize*.05,10))
mypower$sig.level <- 0.05
mypower$group <- c(rep(1,10), rep(2,10), rep(3,10), rep(4,10), rep(5,10), rep(6,10), rep(7,10), rep(8,10), rep(9,10), rep(10,10))
mypower$group <- as.factor(mypower$group)
for(i in 1:nrow(mypower)){
  pow <- pwr.f2.test(u=mypower$u[i],
                               v=mypower$v[i],
                               f2=mypower$f2[i],
                               sig.level = mypower$sig.level[i])
  mypower$power[i] <- pow$power
}

# Plotting -------------------------------------------------
# plotting setup -----------------------
myheight <- 7
mywidth <- 7

# plot effect size x power -------------
mypower$n <- mypower$v + 2
mypower$n <- factor(mypower$n, levels =c(62+2, (62*0.9)+2, (62*0.8)+2, (62*0.7)+2, (62*0.6)+2, (62*0.5)+2, (62*0.4)+2, (62*0.3)+2, (62*0.2)+2, (62*0.1)+2))
mypower$v <- factor(mypower$v, levels =c(62, 62*0.9, 62*0.8, 62*0.7, 62*0.6, 62*0.5, 62*0.4, 62*0.3, 62*0.2, 62*0.1))

p<-ggplot(mypower, aes(x=f2, y=power, group=n)) +
  geom_vline(xintercept = myeffectsize, linetype = "dashed", color = "darkgray")+
  geom_line(aes(color=n))+
  geom_point(aes(color=n))+
  geom_point(x = myeffectsize, y = mypowersize, pch = 1, size = 5, color = "darkgray")+
  theme_classic()+
  ggtitle("power to detect fitness differences between two treatments \n with n total barcodes")+
  labs(color = "n (total barcodes)")+
  scale_x_continuous(name = "Fitness Difference between Treatments", breaks = c(myeffectsize*0.05, myeffectsize*0.1, myeffectsize*0.25, 
                                                                                myeffectsize*0.5, myeffectsize*0.75, myeffectsize, 
                                                                                myeffectsize*1.25, myeffectsize*1.5, myeffectsize*1.75, myeffectsize*2), 
                     labels = c("0.05%","", "0.25%", "0.5%", "0.75%", "1.0%", "1.25%", "1.5%", "1.75%", "2.0%"))
p
pdf(file = paste("000_FitChangeTreatDif_PowerByRMSE_effectsizexpower.pdf"), width = mywidth, height = myheight); p; dev.off()

# plot n barcodes x power --------------
mypower$n <- as.numeric(levels(mypower$n))[mypower$n]
mypower$f2 <- factor(round(mypower$f2,2), levels = c(sort(unique(round(mypower$f2,2)), decreasing = T)))
p<-ggplot(mypower, aes(x=n, y=power, group=f2)) +
  geom_vline(xintercept = 64, linetype = "dashed", color = "darkgray")+
  geom_line(aes(color=f2))+
  geom_point(aes(color=f2))+
  geom_point(x = 64, y = mypowersize, pch = 1, size = 5, color = "darkgray")+
  theme_classic()+
  scale_x_continuous(name = "n (total barcodes)", breaks = c(8, 16, 24, 32, 40, 48, 56, 64), labels = c(8, 16, 24, 32, 40, 48, 56, 64))+
  scale_color_discrete(name = "Fitness Difference \n between Treatments", labels = rev(c("0.05%","0.1%", "0.25%", "0.5%", "0.75%", "1.0%", "1.25%", "1.5%", "1.75%", "2.0%")))+
  ggtitle("power to detect fitness differences between two treatments \n with n total barcodes")
p
pdf(file = paste("000_FitChangeTreatDif_PowerByRMSE_nxpower.pdf"), width = mywidth, height = myheight); p; dev.off()


# power to detect fitness increase / decrease (t-tests) --------------------------------------------
# d = m1 - m2 / q; m1 is mean group 1, m2 is mean group 2, q is common standard deviation in the two groups
# here m1 is change in fitness and m2 is 0. mean q is used and is the weighted mean of all
# population standard deviation of the four replicate sets in each row of the dataset.

# get data and conduct population sd calculation -----------
my <- mydwc
my$psd_r1 <- (my$dw-my$mn_dw)^2
my$psd_r2 <- (my$dw_2-my$mn_dw)^2
my$psd_r3 <- (my$dw_3-my$mn_dw)^2
my$psd_r4 <- (my$dw_4-my$mn_dw)^2
my$psd_m <- rowMeans(cbind(my$psd_r1, my$psd_r2, my$psd_r3, my$psd_r4), na.rm = T)
my$psd <- sqrt(my$psd_m)
psd <- weighted.mean(my$psd, my$mn_re_dw, na.rm = T)

# prepare plot data ----------------------------------------
mypower <- matrix(nrow=22*3, ncol = 5); colnames(mypower) <- c("fitchange", "psd", "n", "power", "sig.level")
mypower <- as.data.frame(mypower)
mypower$fitchange <- c(0.0025, 0.005, 0.01, 0.015, 0.02, 0.025, 0.03, 0.035, 0.04, 0.045, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.12, 0.14, 0.16, 0.18, 0.20, 0.22)
mypower$psd <- psd
mypower$n <- c(rep(2,22), rep(3,22), rep(4,22))
mypower$power <- NA
mypower$sig.level <- 0.05
mypower$group <- c(rep(1,22), rep(2,22), rep(3,22))
mypower$group <- as.factor(mypower$group)
for(i in 1:nrow(mypower)){
  pow <- pwr.t.test(d=mypower$fitchange[i] / mypower$psd[i],
                               n=mypower$n[i],
                               sig.level = mypower$sig.level[i])
  mypower$power[i] <- pow$power
}
pwr.t.test(d= 0.025 / psd, n=4, sig.level = 0.05)

# Plotting -------------------------------------------------
# plot effect size x power -------------
mypower$n <- factor(mypower$n, levels = c(4,3,2))
p<-ggplot(mypower, aes(x=fitchange, y=power, group=n)) +
  geom_vline(xintercept = 0.01, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.025, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "gray")+
  geom_line(aes(color=n))+
  geom_point(aes(color=n))+
  geom_point(x = 0.01, y = pwr.t.test(d = 0.01 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.025, y = pwr.t.test(d = 0.025 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.05, y = pwr.t.test(d = 0.05 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.1, y = pwr.t.test(d = 0.1 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  scale_x_continuous(name = "Fitness Change", breaks = c(0.01, 0.025, 0.05, 0.1, 0.15, 0.2), labels = c("1%", "2.5%", "5%", "10%", "15%", "20%"))+
  labs(color = "n (replicates \n per timepoint)")+
  theme_classic()+
  ggtitle("power to detect fitness change in 500 generations with n entries per timepoint")
p

pp<-ggplot(mypower, aes(x=fitchange, y=power, group=n)) +
  geom_vline(xintercept = 0.01, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.025, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "gray")+
  geom_line(aes(color=n))+
  geom_point(aes(color=n))+
  geom_point(x = 0.01, y = pwr.t.test(d = 0.01 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.025, y = pwr.t.test(d = 0.025 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.05, y = pwr.t.test(d = 0.05 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  geom_point(x = 0.1, y = pwr.t.test(d = 0.1 / psd, n = 4, sig.level = 0.05)$power, pch = 1, size = 5, color = "gray")+
  ggtitle(NULL)+ xlab(NULL)+ ylab(NULL)+
  theme_classic()+
  theme(legend.position = "none")+
  scale_x_continuous(limits = c(0, 0.05), breaks = c(0.01, 0.025, 0.05), labels = c("1%", "2.5%", "5%"))+
  theme(plot.background = element_rect(colour = "black"))
pp

ppp <- p + annotation_custom(ggplotGrob(pp), xmin = 0.125, xmax = .225, ymin = 0.025, ymax = 0.5)
ppp
pdf(file = paste("000_FitChangeIncDec_PowerByRMSE_effectsizexpower.pdf"), width = mywidth, height = myheight); ppp; dev.off()


# plot n replicates x power -------------
mypower$n <- as.numeric(levels(mypower$n))[mypower$n]
mypower$fitchange <- factor(mypower$fitchange, levels = c(sort(unique(mypower$fitchange), decreasing = T)))
p<-ggplot(mypower, aes(x=n, y=power, group=fitchange)) +
  geom_line(aes(color=fitchange))+
  geom_point(aes(color=fitchange))+
  scale_x_continuous(name = "n (replicates per timepoint)", breaks = c(2, 3, 4), labels = c(2, 3, 4))+
  theme_classic()+
  ggtitle("power to detect fitness change in 500 generations with n entries per timepoint")+
  scale_color_discrete(name = "Fitness Change", labels = rev(c("0.25%", "0.5%", "1%", "1.5%", "2%", "2.5%", "3%", "3.5%",
                                                               "4%", "45%", "5%", "6%", "7%", "8%", "9%", "10%", "12%", 
                                                               "14%", "16%", "18%", "20%", "22%")))
p
pdf(file = paste("000_FitChangeIncDec_PowerByRMSE_nxpower.pdf"), width = mywidth, height = myheight); p; dev.off()

rm(mymod, mypower, p, pow, pp, ppp, x, i, myeffectsize, myheight, mypowersize, myrmse, mywidth, psd)
```


Fitness correlation test
```{r}
mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$mn_re_dw_0_80 <- rowMeans(cbind(mydata$mn_re_dw_0, mydata$mn_re_dw_80), na.rm = T)
mydata$mn_re_dw_0_80[is.nan(mydata$mn_re_dw_0_80)] <- NA

mydata$mn_re_dw_0_40 <- rowMeans(cbind(mydata$mn_re_dw_0, mydata$mn_re_dw_40), na.rm = T)
mydata$mn_re_dw_0_40[is.nan(mydata$mn_re_dw_0_40)] <- NA

mydata$mn_re_dw_40_80 <- rowMeans(cbind(mydata$mn_re_dw_40, mydata$mn_re_dw_80), na.rm = T)
mydata$mn_re_dw_40_80[is.nan(mydata$mn_re_dw_40_80)] <- NA

x <- c(); xx <- c();# xxx <- c(); xxxx <- c()
y <- c(); yy <- c();# yyy <- c(); yyyy <- c()
z <- c(); zz <- c();# zzz <- c(); zzzz <- c()


# all data together
mytemp <- cor.test(mydata$mn_dw_0, mydata$mn_dw_80) # overall correlation between envs. 0 and 80 isn egative (-0.29)
mytempw <- wtd.cor(mydata$mn_dw_0, mydata$mn_dw_80, weight = mydata$mn_re_dw_0_80) # (-0.35)

# constant lines
myg <- c("EH0", "EH40", "EH80")
mytemp <- cor.test(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg]) # -0.39
mytempw <- wtd.cor(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg], weight = mydata$mn_re_dw_0_80[mydata$treat %in% myg]) # -0.48

# flux lines
myg <- c("EH0_40", "EH20_60", "EH0_80", "EH40_80")
mytemp <- cor.test(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg]) # -0.12
mytempw <- wtd.cor(mydata$mn_dw_0[mydata$treat %in% myg], mydata$mn_dw_80[mydata$treat %in% myg], weight = mydata$mn_re_dw_0_80[mydata$treat %in% myg]) # -0.124

for (i in c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) {
  mytemp <- cor.test(mydata$mn_dw_0[mydata$treat == i], mydata$mn_dw_80[mydata$treat == i])
  mytempw <- wtd.cor(mydata$mn_dw_0[mydata$treat == i], mydata$mn_dw_80[mydata$treat == i], weight = mydata$mn_re_dw_0_80[mydata$treat == i])
  
  # mytemps0 <- mean(mydata$mn_dw_0[mydata$treat == i], na.rm = T)
  # mytemps80 <- mean(mydata$mn_dw_80[mydata$treat == i], na.rm = T)
  # if(mytemps0 >=0 & mytemps80 >=0){mytemps <- "+"
  # }else if(mytemps0 <0 & mytemps80 <0){mytemps <- "-"
  # } else {mytemps <- ""}
  
  # mytemps0w <- weighted.mean(mydata$mn_dw_0[mydata$treat == i],mydata$mn_re_dw_0[mydata$treat == i], na.rm = T)
  # mytemps80w <- weighted.mean(mydata$mn_dw_80[mydata$treat == i],mydata$mn_re_dw_80[mydata$treat == i], na.rm = T)
  # if(mytemps0w >=0 & mytemps80w >=0){mytempsw <- "+"
  # }else if(mytemps0w <0 & mytemps80w <0){mytempsw <- "-"
  # } else {mytempsw <- ""}
  
  x <- c(x, mytemp$estimate)
  xx <- c(xx, mytempw[1])
  # xxx <- c(xxx, mytemps)
  # xxxx <- c(xxxx, mytempsw)

  
  
  mytemp <- cor.test(mydata$mn_dw_0[mydata$treat == i], mydata$mn_dw_40[mydata$treat == i])
  mytempw <- wtd.cor(mydata$mn_dw_0[mydata$treat == i], mydata$mn_dw_40[mydata$treat == i], weight = mydata$mn_re_dw_0_40[mydata$treat == i])
  
  # mytemps0 <- mean(mydata$mn_dw_0[mydata$treat == i], na.rm = T)
  # mytemps40 <- mean(mydata$mn_dw_40[mydata$treat == i], na.rm = T)
  # if(mytemps0 >=0 & mytemps40 >=0){mytemps <- "+"
  # }else if(mytemps0 <0 & mytemps40 <0){mytemps <- "-"
  # } else {mytemps <- ""}
  
  # mytemps0w <- weighted.mean(mydata$mn_dw_0[mydata$treat == i],mydata$mn_re_dw_0[mydata$treat == i], na.rm = T)
  # mytemps40w <- weighted.mean(mydata$mn_dw_40[mydata$treat == i],mydata$mn_re_dw_40[mydata$treat == i], na.rm = T)
  # if(mytemps0w >=0 & mytemps40w >=0){mytempsw <- "+"
  # }else if(mytemps0w <0 & mytemps40w <0){mytempsw <- "-"
  # } else {mytempsw <- ""}
  
  y <- c(y, mytemp$estimate)
  yy <- c(yy, mytempw[1])
  # yyy <- c(yyy, mytemps)
  # yyyy <- c(yyyy, mytempsw)
  
  
  
  mytemp <- cor.test(mydata$mn_dw_40[mydata$treat == i], mydata$mn_dw_80[mydata$treat == i])
  mytempw <- wtd.cor(mydata$mn_dw_40[mydata$treat == i], mydata$mn_dw_80[mydata$treat == i], weight = mydata$mn_re_dw_40_80[mydata$treat == i])
    
  mytemps40 <- mean(mydata$mn_dw_40[mydata$treat == i], na.rm = T)
  # mytemps80 <- mean(mydata$mn_dw_80[mydata$treat == i], na.rm = T)
  # if(mytemps40 >=0 & mytemps80 >=0){mytemps <- "+"
  # }else if(mytemps40 <0 & mytemps80 <0){mytemps <- "-"
  # } else {mytemps <- ""}
  # 
  # mytemps40w <- weighted.mean(mydata$mn_dw_40[mydata$treat == i],mydata$mn_re_dw_40[mydata$treat == i], na.rm = T)
  # mytemps80w <- weighted.mean(mydata$mn_dw_80[mydata$treat == i],mydata$mn_re_dw_80[mydata$treat == i], na.rm = T)
  # if(mytemps40w >=0 & mytemps80w >=0){mytempsw <- "+"
  # }else if(mytemps40w <0 & mytemps80w <0){mytempsw <- "-"
  # } else {mytempsw <- ""}
  
  z <- c(z, mytemp$estimate)
  zz <- c(zz, mytempw[1])
  # zzz <- c(zzz, mytemps)
  # zzzz <- c(zzzz, mytempsw)
}

# not weighted by reads
xyz <- cbind(as.matrix(x), as.matrix(y), as.matrix(z))
colnames(xyz) <- c("CM (No Stress), \n 80% Stress", "CM (No Stress), \n 40% Stress", "40% Stress,\n 80% Stress")
rownames(xyz) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
xyz
xyz <- as.data.frame(xyz)
xyz$Treatment <- rownames(xyz)
xyz$Treatment <- factor(xyz$Treatment, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
write.csv(xyz, file = "cor.csv")
xyz <- melt(xyz)
colnames(xyz)[colnames(xyz) == "value"] <- "Correlation"
xyz$col <- 1

# mysign <- cbind(as.matrix(xxx), as.matrix(yyy), as.matrix(zzz))
# colnames(mysign) <- c("0,80", "0,40", "40,80")
# rownames(mysign) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
# mysign
# mysign <- as.data.frame(mysign)
# mysign$Treatment <- rownames(mysign)
# mysign <- melt(mysign, id.vars = "Treatment")
# mysign$sign <- mysign$value
# 
# xyz <- cbind(xyz, mysign$sign)
# colnames(xyz)[ncol(xyz)] <- "sign"
p <- ggplot(xyz, aes(col, Treatment, fill = Correlation))+
  geom_tile()+
  geom_text(aes(label=round(Correlation, 2)))+
  # geom_text(aes(label=xyz$sign),inherit.aes = T, nudge_x = 0.3, nudge_y = -0.3, size = 3.5)+
  coord_fixed(1/1.75)+
  scale_fill_viridis(discrete = F, limits = c(-1, 1))+
  theme_blank()+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank()) +
  xlab("Assay Environment")+
  facet_grid(~variable, switch = "x")
pdf(file = paste("000_SALT_Fitness_Cor_Heatmaps_uw.pdf"),height = 5.5, width = 5.5);
grid::grid.draw(p); dev.off()



# weighted by reads
xxyyzz <- cbind(as.matrix(xx), as.matrix(yy), as.matrix(zz))
colnames(xxyyzz) <- c("CM (No Stress), \n 80% Stress", "CM (No Stress), \n 40% Stress", "40% Stress,\n 80% Stress")
rownames(xxyyzz) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
xxyyzz
xxyyzz <- as.data.frame(xxyyzz)
xxyyzz$Treatment <- rownames(xxyyzz)
xxyyzz$Treatment <- factor(xxyyzz$Treatment, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
write.csv(xxyyzz, file = "corw.csv")
xxyyzz <- melt(xxyyzz)
colnames(xxyyzz)[colnames(xxyyzz) == "value"] <- "Correlation"
xxyyzz$col <- 1

# mysign <- cbind(as.matrix(xxxx), as.matrix(yyyy), as.matrix(zzzz))
# colnames(mysign) <- c("0,80", "0,40", "40,80")
# rownames(mysign) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
# mysign
# mysign <- as.data.frame(mysign)
# mysign$Treatment <- rownames(mysign)
# mysign <- melt(mysign, id.vars = "Treatment")
# mysign$sign <- mysign$value
# 
# xxxyyzzyz <- cbind(xxxyyzzyz, mysign$sign)
# colnames(xxxyyzzyz)[ncol(xxxyyzzyz)] <- "sign"
p <- ggplot(xxyyzz, aes(col, Treatment, fill = Correlation))+
  geom_tile()+
  geom_text(aes(label=round(Correlation, 2)))+
  # geom_text(aes(label=xxxyyzzyz$sign),inherit.aes = T, nudge_x = 0.3, nudge_y = -0.3, size = 3.5)+
  coord_fixed(1/1.75)+
  scale_fill_viridis(discrete = F, limits = c(-1, 1))+
  theme_blank()+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank()) +
  xlab("Assay Environment")+
  facet_grid(~variable, switch = "x")
pdf(file = paste("000_SALT_Fitness_Cor_Heatmaps_w.pdf"),height = 5.5, width = 5.5); grid::grid.draw(p); dev.off()

```


```{r}

mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0, mydata$mn_dw_80), na.rm = F)
mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


# modified from modi package
weighted.var <- function (x, w, na.rm = FALSE) 
{
  if (missing(w)) {
    w <- rep.int(1, length(x))
  }
  else if (length(w) != length(x)) {
    stop("x and w must have the same length")
  }
  # if (min(w) < 0) {
  #   stop("there are negative weights")
  # }
  
  if (is.integer(w)) {
    w <- as.numeric(w)
  }
  if (na.rm) {
    w <- w[obs.ind <- !is.na(x)]
    x <- x[obs.ind]
  }
  w <- w * length(w)/sum(w)
  return(sum(w * (x - weighted.mean(x, w))^2)/(sum(w) - 1))
}

mydata$var_dw_0_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), na.rm = F))
mydata$var_dw_0_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


# viz -- all 0_80-----------------------
# weighted -------------------
mypalette <- dichrompalette_br_cy
mydata$mn_dw_0_80s <- scale(mydata$mn_dw_0_80, center = F); mydata$var_dw_0_80s <- scale(mydata$var_dw_0_80, center = F)
p <- ggplot(mydata, aes(x=mn_dw_0_80s, y=var_dw_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3.5), color = "gray75", label = "1:1")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_A_TOSHARE_SALT_Fitness_Cor_Heatmaps_w.pdf"),height = 8.5, width = 11); grid::grid.draw(x); dev.off()


```


```{r}
mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

mydata$mn_dw_0_p1 <- mydata$mn_dw_0 + abs(min(mydata$mn_dw_0, na.rm = T)); mydata$mn_dw_80_p1 <- mydata$mn_dw_80 + abs(min(mydata$mn_dw_80, na.rm = T));
mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0_p1, mydata$mn_dw_80_p1), na.rm = F)
mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]),
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


mydata$mn_dw_0_80uwg <- apply(mydata, 1, function(x) psych::geometric.mean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]))) # I checked this math, its good.
mydata$mn_re_dw_0_geomean <- scale(mydata$mn_re_dw_0, center = F); mydata$mn_re_dw_80_geomean <- scale(mydata$mn_re_dw_80, center = F);
mydata$mn_dw_0_80g <- apply(mydata, 1, function(x) weighted.geomean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]),
                                                  w=as.numeric(x[c( "mn_re_dw_0_geomean", "mn_re_dw_80_geomean")]), na.rm = F))


weighted.var <- function (x, w, na.rm = FALSE) 
{
  if (missing(w)) {
    w <- rep.int(1, length(x))
  }
  else if (length(w) != length(x)) {
    stop("x and w must have the same length")
  }
  # if (min(w) < 0) {
  #   stop("there are negative weights")
  # }
  
  if (is.integer(w)) {
    w <- as.numeric(w)
  }
  if (na.rm) {
    w <- w[obs.ind <- !is.na(x)]
    x <- x[obs.ind]
  }
  w <- w * length(w)/sum(w)
  return(sum(w * (x - weighted.mean(x, w))^2)/(sum(w) - 1))
}

mydata$var_dw_0_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), na.rm = F))
mydata$var_dw_0_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


# viz -- all 0_80-----------------------
# weighted -------------------
mypalette <- dichrompalette_br_cy
mydata$mn_dw_0_80s <- scale(mydata$mn_dw_0_80, center = T); mydata$var_dw_0_80s <- scale(mydata$var_dw_0_80, center = T)
p <- ggplot(mydata, aes(x=mn_dw_0_80s, y=var_dw_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 4.790458/myrange, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3), color = "gray75", label = "1:1")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)

mypalette <- dichrompalette_br_cy
mydata$mn_dw_0_80gs <- scale(mydata$mn_dw_0_80g, center = F); mydata$var_dw_0_80s <- scale(mydata$var_dw_0_80, center = F)
p <- ggplot(mydata, aes(x=mn_dw_0_80gs, y=var_dw_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 4.790458/myrange, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3), color = "gray75", label = "1:1")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)
```



```{r}

mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

mydata$mn_dw_0_p1 <- mydata$mn_dw_0 + abs(min(mydata$mn_dw_0, na.rm = T)); mydata$mn_dw_80_p1 <- mydata$mn_dw_80 + abs(min(mydata$mn_dw_80, na.rm = T));

mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0_p1, mydata$mn_dw_80_p1), na.rm = F)
mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]),
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$mn_dw_0_80uwg <- apply(mydata, 1, function(x) psych::geometric.mean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]))) # I checked this math, its good.
mydata$mn_re_dw_0_geomean <- scale(mydata$mn_re_dw_0, center = F); mydata$mn_re_dw_80_geomean <- scale(mydata$mn_re_dw_80, center = F);
mydata$mn_dw_0_80g <- apply(mydata, 1, function(x) weighted.geomean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]),
                                                  w=as.numeric(x[c( "mn_re_dw_0_geomean", "mn_re_dw_80_geomean")]), na.rm = F))

# viz -- all 0_80-----------------------
# weighted -------------------
mypalette <- dichrompalette_br_cy
mydata$mn_dw_0_80s <- scale(mydata$mn_dw_0_80, center = T); mydata$mn_dw_0_80gs <- scale(mydata$mn_dw_0_80g, center = T)
p <- ggplot(mydata, aes(x=mn_dw_0_80s, y=mn_dw_0_80gs, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75")+
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=3,y=3), color = "gray75", label = "1:1")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)



mypalette <- dichrompalette_br_cy
myx <- mydata$Treatment
myy <- mydata$mn_dw_0_80s
myc <- mydata$Treatment
mytitle <- ""
myxlab <- "Treatment"
myylab <- "Arithmetic Mean Fitness in 00, 80"
myoutline <-  "grey20"
myfill <-  "grey90"
myptalpha <- 1
mymeanptsize <- 1
myptsize <- 0.1
myrugalpha <- 0.7
mywtmeanptcol <- "black"


p <- ggplot(mydata, aes(x=myx, y=myy, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "l" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = myptalpha) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))
p



myy <- mydata$mn_dw_0_80gs
myylab <- "Geometric Mean Fitness in 00, 80"

p <- ggplot(mydata, aes(x=myx, y=myy, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "l" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = myptalpha) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))
p


```


mean fitness vs. var fitness
```{r}


mydata <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
mydata$Treatment <- factor(mydata$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor

mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0, mydata$mn_dw_80), na.rm = F)
mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps
# mydata$mn_dw_0_p1 <- mydata$mn_dw_0 + 1; mydata$mn_dw_80_p1 <- mydata$mn_dw_80 + 1; 
# mydata$mn_dw_0_p1 <- mydata$mn_dw_0 + abs(min(mydata$mn_dw_0, na.rm = T)); mydata$mn_dw_80_p1 <- mydata$mn_dw_80 + abs(min(mydata$mn_dw_80, na.rm = T)); 
# 
# mydata$mn_dw_0_80uw <- rowMeans(cbind(mydata$mn_dw_0_p1, mydata$mn_dw_80_p1), na.rm = F)
# mydata$mn_dw_0_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]),
#                                                   w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps

# mydata$mn_dw_0_80uwg <- apply(mydata, 1, function(x) psych::geometric.mean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]))) # I checked this math, its good. 
# mydata$mn_re_dw_0_geomean <- scale(mydata$mn_re_dw_0, center = F); mydata$mn_re_dw_80_geomean <- scale(mydata$mn_re_dw_80, center = F);
# mydata$mn_dw_0_80g <- apply(mydata, 1, function(x) weighted.geomean(x=as.numeric(x[c( "mn_dw_0_p1", "mn_dw_80_p1")]),
#                                                   w=as.numeric(x[c( "mn_re_dw_0_geomean", "mn_re_dw_80_geomean")]), na.rm = F))
# 
# plot(mydata$mn_dw_0_80uw ~ mydata$mn_dw_0_80uwg)
# abline(a = 0, b = 1)
# 
# plot(mydata$mn_dw_0_80 , mydata$mn_dw_0_80g)
# abline(a = 0, b = 1)
# hist(mydata$mn_dw_0_80uw, col = rgb(1,0,0,0.5)); hist(mydata$mn_dw_0_80uwg, col = rgb(0,0,1,0.5), add = T)


mydata$mn_dw_0_40uw <- rowMeans(cbind(mydata$mn_dw_0, mydata$mn_dw_40), na.rm = F)
mydata$mn_dw_0_40 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_0", "mn_dw_40")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_40")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$mn_dw_40_80uw <- rowMeans(cbind(mydata$mn_dw_40, mydata$mn_dw_80), na.rm = F)
mydata$mn_dw_40_80 <- apply(mydata, 1, function(x) weighted.mean(x=as.numeric(x[c( "mn_dw_40", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_40", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps

# modified from modi package
weighted.var <- function (x, w, na.rm = FALSE) 
{
  if (missing(w)) {
    w <- rep.int(1, length(x))
  }
  else if (length(w) != length(x)) {
    stop("x and w must have the same length")
  }
  # if (min(w) < 0) {
  #   stop("there are negative weights")
  # }
  
  if (is.integer(w)) {
    w <- as.numeric(w)
  }
  if (na.rm) {
    w <- w[obs.ind <- !is.na(x)]
    x <- x[obs.ind]
  }
  w <- w * length(w)/sum(w)
  return(sum(w * (x - weighted.mean(x, w))^2)/(sum(w) - 1))
}

mydata$var_dw_0_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), na.rm = F))
mydata$var_dw_0_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$var_dw_0_40uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_40")]), na.rm = F))
mydata$var_dw_0_40 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_0", "mn_dw_40")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_0", "mn_re_dw_40")]), na.rm = F)) # calculate wtd.var dw across reps

mydata$var_dw_40_80uw <- apply(mydata, 1, function(x) var(x=as.numeric(x[c( "mn_dw_40", "mn_dw_80")]), na.rm = F))
mydata$var_dw_40_80 <- apply(mydata, 1, function(x) weighted.var(x=as.numeric(x[c( "mn_dw_40", "mn_dw_80")]), 
                                                  w=as.numeric(x[c( "mn_re_dw_40", "mn_re_dw_80")]), na.rm = F)) # calculate wtd.var dw across reps


# viz -- all 0_80-----------------------
# weighted -------------------
mypalette <- dichrompalette_br_cy
mydata$mn_dw_0_80s <- scale(mydata$mn_dw_0_80, center = F); mydata$var_dw_0_80s <- scale(mydata$var_dw_0_80, center = F)
p <- ggplot(mydata, aes(x=mn_dw_0_80s, y=var_dw_0_80s, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.175,y=0.007), color = "gray75", label = "1:16")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_SALT_MN_VS_VAR_00_80_ALLTREATw.pdf"),height = 8.5, width = 11); grid::grid.draw(x); dev.off()

# unweighted -----------------
mypalette <- dichrompalette_br_cy
p <- ggplot(mydata, aes(x=mn_dw_0_80uw, y=var_dw_0_80uw, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  geom_rug()
p1 <- p + facet_wrap(~treat, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.175,y=0.007), color = "gray75", label = "1:16")
x <- grid.arrange(p2, p1, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_SALT_MN_VS_VAR_00_80_ALLTREATuw.pdf"),height = 8.5, width = 11); grid::grid.draw(x); dev.off()



# viz -- target ----------------------------------
# weighted -------------------
mypalette <- dichrompalette_br_cy[c(1,5,7)]
p <- ggplot(mydata[mydata$Treatment %in% c("EH0", "EH0_80", "EH80"),], aes(x=mn_dw_0_80, y=var_dw_0_80, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  xlim( min(c(mydata$mn_dw_0_80, mydata$mn_dw_0_40, mydata$mn_dw_40_80), na.rm = T), max(c(mydata$mn_dw_0_80, mydata$mn_dw_0_40, mydata$mn_dw_40_80), na.rm = T))+
  ylim( min(c(mydata$var_dw_0_80, mydata$var_dw_0_40, mydata$var_dw_40_80), na.rm = T), max(c(mydata$var_dw_0_80, mydata$var_dw_0_40, mydata$var_dw_40_80), na.rm = T))+
  geom_rug()
p1 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.175,y=0.007), color = "gray75", label = "1:16")


mypalette <- dichrompalette_br_cy[1:3]
p <- ggplot(mydata[mydata$Treatment %in% c("EH0", "EH0_40", "EH40"),], aes(x=mn_dw_0_40, y=var_dw_0_40, color = Treatment, fill = Treatment)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 40% Stress")+
  ylab("Variance Fitness: CM (No Stress), 40% Stress")+
  xlim( min(c(mydata$mn_dw_0_80, mydata$mn_dw_0_40, mydata$mn_dw_40_80), na.rm = T), max(c(mydata$mn_dw_0_80, mydata$mn_dw_0_40, mydata$mn_dw_40_80), na.rm = T))+
  ylim( min(c(mydata$var_dw_0_80, mydata$var_dw_0_40, mydata$var_dw_40_80), na.rm = T), max(c(mydata$var_dw_0_80, mydata$var_dw_0_40, mydata$var_dw_40_80), na.rm = T))+
  geom_rug()
p3 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p4 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.175,y=0.007), color = "gray75", label = "1:16")


mypalette <- dichrompalette_br_cy[c(3,6,7)]
p <- ggplot(mydata[mydata$Treatment %in% c("EH40", "EH40_80", "EH80"),], aes(x=mn_dw_40_80, y=var_dw_40_80, color = Treatment, fill = Treatment)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: 40% Stress, 80% Stress")+
  ylab("Variance Fitness: 40% Stress, 80% Stress")+
  xlim( min(c(mydata$mn_dw_0_80, mydata$mn_dw_0_40, mydata$mn_dw_40_80), na.rm = T), max(c(mydata$mn_dw_0_80, mydata$mn_dw_0_40, mydata$mn_dw_40_80), na.rm = T))+
  ylim( min(c(mydata$var_dw_0_80, mydata$var_dw_0_40, mydata$var_dw_40_80), na.rm = T), max(c(mydata$var_dw_0_80, mydata$var_dw_0_40, mydata$var_dw_40_80), na.rm = T))+
  geom_rug()
p5 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p6 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.2,y=0.007), color = "gray75", label = "1:16")

x <- grid.arrange(p2, p1, p4, p3, p6, p5, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_SALT_MN_VS_VAR_TARTREATSw.pdf"),height = 18, width = 9); grid::grid.draw(x); dev.off()


# unweighted -----------------
mypalette <- dichrompalette_br_cy[c(1,5,7)]
p <- ggplot(mydata[mydata$Treatment %in% c("EH0", "EH0_80", "EH80"),], aes(x=mn_dw_0_80uw, y=var_dw_0_80uw, color = Treatment, fill = Treatment)) +   geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 80% Stress")+
  ylab("Variance Fitness: CM (No Stress), 80% Stress")+
  xlim( min(c(mydata$mn_dw_0_80uw, mydata$mn_dw_0_40uw, mydata$mn_dw_40_80uw), na.rm = T), max(c(mydata$mn_dw_0_80uw, mydata$mn_dw_0_40uw, mydata$mn_dw_40_80uw), na.rm = T))+
  ylim( min(c(mydata$var_dw_0_80uw, mydata$var_dw_0_40uw, mydata$var_dw_40_80uw), na.rm = T), max(c(mydata$var_dw_0_80uw, mydata$var_dw_0_40uw, mydata$var_dw_40_80uw), na.rm = T))+
  geom_rug()
p1 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.175,y=0.007), color = "gray75", label = "1:16")


mypalette <- dichrompalette_br_cy[1:3]
p <- ggplot(mydata[mydata$Treatment %in% c("EH0", "EH0_40", "EH40"),], aes(x=mn_dw_0_40uw, y=var_dw_0_40uw, color = Treatment, fill = Treatment)) +   geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: CM (No Stress), 40% Stress")+
  ylab("Variance Fitness: CM (No Stress), 40% Stress")+
  xlim( min(c(mydata$mn_dw_0_80uw, mydata$mn_dw_0_40uw, mydata$mn_dw_40_80uw), na.rm = T), max(c(mydata$mn_dw_0_80uw, mydata$mn_dw_0_40uw, mydata$mn_dw_40_80uw), na.rm = T))+
  ylim( min(c(mydata$var_dw_0_80uw, mydata$var_dw_0_40uw, mydata$var_dw_40_80uw), na.rm = T), max(c(mydata$var_dw_0_80uw, mydata$var_dw_0_40uw, mydata$var_dw_40_80uw), na.rm = T))+
  geom_rug()
p3 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p4 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.175,y=0.007), color = "gray75", label = "1:16")


mypalette <- dichrompalette_br_cy[c(3,6,7)]
p <- ggplot(mydata[mydata$Treatment %in% c("EH40", "EH40_80", "EH80"),], aes(x=mn_dw_40_80uw, y=var_dw_40_80uw, color = Treatment, fill = Treatment)) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 0.25, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_abline(slope = 1/16, intercept = 0, linetype = "dashed", color = "gray75") +
  geom_point(size = 2.5, alpha = 0.75) + 
  scale_color_manual(values = mypalette)+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Mean Fitness: 40% Stress, 80% Stress")+
  ylab("Variance Fitness: 40% Stress, 80% Stress")+
  xlim( min(c(mydata$mn_dw_0_80uw, mydata$mn_dw_0_40uw, mydata$mn_dw_40_80uw), na.rm = T), max(c(mydata$mn_dw_0_80uw, mydata$mn_dw_0_40uw, mydata$mn_dw_40_80uw), na.rm = T))+
  ylim( min(c(mydata$var_dw_0_80uw, mydata$var_dw_0_40uw, mydata$var_dw_40_80uw), na.rm = T), max(c(mydata$var_dw_0_80uw, mydata$var_dw_0_40uw, mydata$var_dw_40_80uw), na.rm = T))+
  geom_rug()
p5 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p6 <- p + theme(legend.position = "none") + 
  geom_text(aes(x=0.1,y=0.07), color = "gray75", label = "1:1") +
  geom_text(aes(x=0.175,y=0.0375), color = "gray75", label = "1:4") +
  geom_text(aes(x=0.2,y=0.007), color = "gray75", label = "1:16")

x <- grid.arrange(p2, p1, p4, p3, p6, p5, widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_SALT_MN_VS_VAR_TARTREATSuw.pdf"),height = 18, width = 9); grid::grid.draw(x); dev.off()

# create a summary table by treatment ----------------------
# weighted -------------------
x <- c(); u <- c()
y <- c(); v <- c()
z <- c(); w <- c()
for (i in c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) {
  mytemp <- mean(mydata$mn_dw_0_80[mydata$Treatment == i], na.rm = T)
  x <- c(x, mytemp)
  mytemp <- var(mydata$mn_dw_0_80[mydata$Treatment == i], na.rm = T)
  u <- c(u, mytemp)
  
  mytemp <- mean(mydata$mn_dw_0_40[mydata$Treatment == i], na.rm = T)
  y <- c(y, mytemp)
  mytemp <- var(mydata$mn_dw_0_40[mydata$Treatment == i], na.rm = T)
  v <- c(v, mytemp)
  
  mytemp <- mean(mydata$mn_dw_40_80[mydata$Treatment == i], na.rm = T)
  z <- c(z, mytemp)
  mytemp <- var(mydata$mn_dw_40_80[mydata$Treatment == i], na.rm = T)
  w <- c(w, mytemp)
}

xuyvzw <- cbind(as.matrix(x), as.matrix(u), as.matrix(y), as.matrix(v), as.matrix(z), as.matrix(w))
colnames(xuyvzw) <- c("mn 0,80", "var 0,80", "mn 0,40", "var 0,40", "mn 40,80", "var 40,80")
rownames(xuyvzw) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
# xuyvzw
write.csv(xuyvzw, file = "000_SALT_MN_VS_VAR_TARTREATSw_TABLE.csv")

# unweighted -----------------
x <- c(); u <- c()
y <- c(); v <- c()
z <- c(); w <- c()
for (i in c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) {
  mytemp <- mean(mydata$mn_dw_0_80uw[mydata$Treatment == i], na.rm = T)
  x <- c(x, mytemp)
  mytemp <- var(mydata$mn_dw_0_80uw[mydata$Treatment == i], na.rm = T)
  u <- c(u, mytemp)
  
  mytemp <- mean(mydata$mn_dw_0_40uw[mydata$Treatment == i], na.rm = T)
  y <- c(y, mytemp)
  mytemp <- var(mydata$mn_dw_0_40uw[mydata$Treatment == i], na.rm = T)
  v <- c(v, mytemp)
  
  mytemp <- mean(mydata$mn_dw_40_80uw[mydata$Treatment == i], na.rm = T)
  z <- c(z, mytemp)
  mytemp <- var(mydata$mn_dw_40_80uw[mydata$Treatment == i], na.rm = T)
  w <- c(w, mytemp)
}

xuyvzwuw <- cbind(as.matrix(x), as.matrix(u), as.matrix(y), as.matrix(v), as.matrix(z), as.matrix(w))
colnames(xuyvzwuw) <- c("mn 0,80", "var 0,80", "mn 0,40", "var 0,40", "mn 40,80", "var 40,80")
rownames(xuyvzwuw) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
# xuyvzwuw
write.csv(xuyvzwuw, file = "000_SALT_MN_VS_VAR_TARTREATSuw_TABLE.csv")
```


# Vector Fitness
```{r}
# for SALT  ---------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1)

# all treats together in 0 and 80 ------------------------------------------------------------------
my$Fitness_in_CM <- my$mn_dw_0
my$Fitness_in_High_Stress <- my$mn_dw_80
mypalette <- dichrompalette_br_cy
p <- ggplot(my, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my$Fitness_in_CM, yend=my$Fitness_in_High_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in CM (No Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  geom_rug()
p1 <- p + facet_wrap(~Treatment, nrow = 2) + theme(axis.text.x = element_text(size = 6, angle = 45, vjust = 0.5)) + ylab("")
p2 <- p + theme(legend.position = "none")

x <- grid.arrange(p2, p1,
             widths = c(1,2))
grid::grid.draw(x)
pdf(file = paste("000_SALT_VectorFitness_00_80_ALLTREAT.pdf"),height = 8.5, width = 11); grid::grid.draw(x); dev.off()


# target treats in target envs ------------------------------------------------------------------
my$Fitness_in_CM <- my$mn_dw_0
my$Fitness_in_High_Stress <- my$mn_dw_80
mypalette <- dichrompalette_br_cy[c(1,5,7)]
p <- ggplot(my[my$Treatment %in% c("EH0", "EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my[my$Treatment %in% c("EH0", "EH0_80", "EH80"),]$Fitness_in_CM, 
                             yend=my[my$Treatment %in% c("EH0", "EH0_80", "EH80"),]$Fitness_in_High_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in CM (No Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  xlim( min(c(my$mn_dw_0, my$mn_dw_40), na.rm = T), max(c(my$mn_dw_0, my$mn_dw_40), na.rm = T))+
  ylim( min(c(my$mn_dw_40, my$mn_dw_80), na.rm = T), max(c(my$mn_dw_40, my$mn_dw_80), na.rm = T))+
  geom_rug()
p
p1 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p2 <- p + theme(legend.position = "none")

my$Fitness_in_CM <- my$mn_dw_0
my$Fitness_in_Low_Stress <- my$mn_dw_40
mypalette <- dichrompalette_br_cy[c(1,2,3)]
p <- ggplot(my[my$Treatment %in% c("EH0", "EH0_40", "EH40"),], aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my[my$Treatment %in% c("EH0", "EH0_40", "EH40"),]$Fitness_in_CM, 
                             yend=my[my$Treatment %in% c("EH0", "EH0_40", "EH40"),]$Fitness_in_Low_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in CM (No Stress)")+
  ylab("Fitness in 40% Stress")+
  coord_equal()+
  xlim( min(c(my$mn_dw_0, my$mn_dw_40), na.rm = T), max(c(my$mn_dw_0, my$mn_dw_40), na.rm = T))+
  ylim( min(c(my$mn_dw_40, my$mn_dw_80), na.rm = T), max(c(my$mn_dw_40, my$mn_dw_80), na.rm = T))+
  geom_rug()
p3 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p4 <- p + theme(legend.position = "none")

my$Fitness_in_Low_Stress <- my$mn_dw_40
my$Fitness_in_High_Stress <- my$mn_dw_80
mypalette <- dichrompalette_br_cy[c(3,6,7)]
p <- ggplot(my[my$Treatment %in% c("EH40", "EH40_80", "EH80"),], aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress, color=Treatment, fill = Treatment)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  geom_point(size = 2.5, alpha = 0.5) +
  geom_segment(mapping = aes(x=0, y=0, xend=my[my$Treatment %in% c("EH40", "EH40_80", "EH80"),]$Fitness_in_Low_Stress, 
                             yend=my[my$Treatment %in% c("EH40", "EH40_80", "EH80"),]$Fitness_in_High_Stress, color = Treatment), size=2, inherit.aes=F, alpha = 0.5)+
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5)+
  scale_color_manual(values = mypalette)+
  theme_bw()+
  xlab("Fitness in 40% Stress")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  xlim( min(c(my$mn_dw_0, my$mn_dw_40), na.rm = T), max(c(my$mn_dw_0, my$mn_dw_40), na.rm = T))+
  ylim( min(c(my$mn_dw_40, my$mn_dw_80), na.rm = T), max(c(my$mn_dw_40, my$mn_dw_80), na.rm = T))+
  geom_rug()
p5 <- p + facet_wrap(~Treatment, nrow = 2) + ylab("")
p6 <- p + theme(legend.position = "none")

x <- grid.arrange(p2, p1, p4, p3, p6, p5, widths = c(1,2))
grid::grid.draw(x)

pdf(file = paste("000_SALT_VectorFitness_TARTREATs.pdf"),height = 18, width = 9); grid::grid.draw(x); dev.off()
```







# Kassen Plot
```{r}
# for SALT  ---------------------------------------------------------------------
#  0, 80 ------------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1) # assign bcids
myf <- my # save a frame for limits
my$Fitness_in_CM <- my$mn_dw_0 # store fitness in complete media
my$Fitness_in_High_Stress <- my$mn_dw_80 # store fitness in stress
my <- my[!is.na(my$Fitness_in_CM) & !is.na(my$Fitness_in_High_Stress) & my$Treatment %in% c("EH0", "EH0_80", "EH80"),] # remove NA entries
my$Treatment <- factor(my$Treatment, levels = c("EH0","EH0_80","EH80")) # reorder the treat factor

# create a dataset for the 0, 80 specialist fit line
myc <- my[my$Treatment %in% c("EH0", "EH80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my$remove <- F; my[my$id %in% myc$id,]$remove <- T
# viz
plot(my[my$treat %in% c("EH0", "EH80"),]$Fitness_in_High_Stress ~ my[my$treat %in% c("EH0", "EH80"),]$Fitness_in_CM)
points(myc$Fitness_in_High_Stress ~ myc$Fitness_in_CM, col = "red")

# remove multivariate outliers for the flux line too (need to do this as a separate step)
myc <- my[my$Treatment %in% c("EH0_80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my[my$id %in% myc$id,]$remove <- T
myp <- my
my <- my[my$remove ==F,]

# Calculate unweighted and weighted centroids dataframes --------
centroids <- aggregate(cbind(my$Fitness_in_CM, my$Fitness_in_High_Stress)~my$Treatment,my,mean)
colnames(centroids) <-  c("Treatment","Fitness_in_CM", "Fitness_in_High_Stress")
centroids_uw <- centroids

centroids$Fitness_in_CM[1] <- weighted.mean(my$Fitness_in_CM[my$Treatment == "EH0"],my$mn_re_dw_0[my$Treatment == "EH0"] )
centroids$Fitness_in_CM[2] <- weighted.mean(my$Fitness_in_CM[my$Treatment == "EH0_80"],my$mn_re_dw_0[my$Treatment == "EH0_80"] )
centroids$Fitness_in_CM[3] <- weighted.mean(my$Fitness_in_CM[my$Treatment == "EH80"],my$mn_re_dw_0[my$Treatment == "EH80"] )
centroids$Fitness_in_High_Stress[1] <- weighted.mean(my$Fitness_in_High_Stress[my$Treatment == "EH0"],my$mn_re_dw_80[my$Treatment == "EH0"] )
centroids$Fitness_in_High_Stress[2] <- weighted.mean(my$Fitness_in_High_Stress[my$Treatment == "EH0_80"],my$mn_re_dw_80[my$Treatment == "EH0_80"] )
centroids$Fitness_in_High_Stress[3] <- weighted.mean(my$Fitness_in_High_Stress[my$Treatment == "EH80"],my$mn_re_dw_80[my$Treatment == "EH80"] )

# calculate kernels -----------------
mydata<-my[,c("Treatment", "Fitness_in_CM", "Fitness_in_High_Stress")] # dataframe with PC1, PC2 (x and y axes) and continents (cont1)
mycols <- mypalette
myThreshold <- 95
myalpha <- 0.5
mykernel_low <- ks::kde(mydata[which(mydata$Treatment=="EH0"),c('Fitness_in_CM', 'Fitness_in_High_Stress')])
mykernel_low <- with(mykernel_low, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_low <- data.frame(mykernel_low)

mykernel_flux <- ks::kde(mydata[which(mydata$Treatment=="EH0_80"),c('Fitness_in_CM', 'Fitness_in_High_Stress')])
mykernel_flux <- with(mykernel_flux, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_flux <- data.frame(mykernel_flux)

mykernel_high <- ks::kde(mydata[which(mydata$Treatment=="EH80"),c('Fitness_in_CM', 'Fitness_in_High_Stress')])
mykernel_high <- with(mykernel_high, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_high <- data.frame(mykernel_high)


# plot scatter with centroids and lines ------
mypalette <- c("#66FFFF", "#B266FF", "#FF6666")
p1 <- ggplot()+
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  xlim( min(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T), max(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T))+
  ylim( min(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T), max(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T))+
  geom_point(data=centroids, color = "black", cex = 5, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment))+
  geom_segment(mapping = aes(x=centroids[1,2], y=centroids[1,3], xend=centroids[3,2], yend=centroids[3,3]), linetype="solid", size=2, inherit.aes=F)+
  geom_point(data=centroids_uw, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress), color = "gray50", cex = 5)+
  geom_segment(mapping = aes(x=centroids_uw[1,2], y=centroids_uw[1,3], xend=centroids_uw[3,2], yend=centroids_uw[3,3]), linetype="solid", size=2, inherit.aes=F, color ="gray50")+
  geom_point(data = myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment), size = 2.5, alpha = 0.5, show.legend = T) +
  geom_point(data = myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress), shape = 1, colour = "black", size = 2.5, alpha = 0.5, show.legend = F)+
  theme_bw()+
  xlab("Fitness in CM (0% Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  geom_path(data = mykernel_low, x=mykernel_low$x, y=mykernel_low$y, color = mypalette[1],inherit.aes = F, show.legend = F)+
  geom_path(data = mykernel_flux, x=mykernel_flux$x, y=mykernel_flux$y, color = mypalette[2],inherit.aes = F, show.legend = F)+
  geom_path(data = mykernel_high, x=mykernel_high$x, y=mykernel_high$y, color = mypalette[3],inherit.aes = F, show.legend = F)+
  geom_rug(data = myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment))+
  scale_color_manual(values = mypalette)
p1

# create and plot hist of resids for flux treat ---
# unweigthed
point1 <- c(centroids_uw[1,2], centroids_uw[1,3])
point2 <- c(centroids_uw[3,2], centroids_uw[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$y <- myp$Fitness_in_CM*myslope + myintercept

# weigthed
point1 <- c(centroids[1,2], centroids[1,3])
point2 <- c(centroids[3,2], centroids[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$yy <- myp$Fitness_in_CM*myslope + myintercept

# create plots for weighted and unweighted resids -----
# unweighted
p2 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (Black Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p2

# weighted
p3 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - yy))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Weighted Residuals \n (Gray Line)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p3

lay <- rbind(c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(2,2,NA,3,3,NA))
x <- grid.arrange(p1, p2, p3, layout_matrix = lay)
grid::grid.draw(x)
pdf(file = paste("000_SALT_KASSEN_0_80.pdf"),height = 11, width = 6); grid::grid.draw(x); dev.off()


#  0, 40 ------------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1) # assign bcids
myf <- my # save a frame for limits
my$Fitness_in_CM <- my$mn_dw_0 # store fitness in complete media
my$Fitness_in_Low_Stress <- my$mn_dw_40 # store fitness in stress
my <- my[!is.na(my$Fitness_in_CM) & !is.na(my$Fitness_in_Low_Stress) & my$Treatment %in% c("EH0", "EH0_40", "EH40"),] # remove NA entries
my$Treatment <- factor(my$Treatment, levels = c("EH0","EH0_40","EH40")) # reorder the treat factor

# create a dataset for the 0, 80 specialist fit line
myc <- my[my$Treatment %in% c("EH0", "EH40"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my$remove <- F; my[my$id %in% myc$id,]$remove <- T
# viz
plot(my[my$treat %in% c("EH0", "EH40"),]$Fitness_in_Low_Stress ~ my[my$treat %in% c("EH0", "EH40"),]$Fitness_in_CM)
points(myc$Fitness_in_Low_Stress ~ myc$Fitness_in_CM, col = "red")

# remove multivariate outliers for the flux line too (need to do this as a separate step)
myc <- my[my$Treatment %in% c("EH0_40"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_CM", "Fitness_in_Low_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my[my$id %in% myc$id,]$remove <- T
myp <- my
my <- my[my$remove ==F,]

# Calculate unweighted and weighted centroids dataframes --------
centroids <- aggregate(cbind(my$Fitness_in_CM, my$Fitness_in_Low_Stress)~my$Treatment,my,mean)
colnames(centroids) <-  c("Treatment","Fitness_in_CM", "Fitness_in_Low_Stress")
centroids_uw <- centroids

centroids$Fitness_in_CM[1] <- weighted.mean(my$Fitness_in_CM[my$Treatment == "EH0"],my$mn_re_dw_0[my$Treatment == "EH0"] )
centroids$Fitness_in_CM[2] <- weighted.mean(my$Fitness_in_CM[my$Treatment == "EH0_40"],my$mn_re_dw_0[my$Treatment == "EH0_40"] )
centroids$Fitness_in_CM[3] <- weighted.mean(my$Fitness_in_CM[my$Treatment == "EH40"],my$mn_re_dw_0[my$Treatment == "EH40"] )
centroids$Fitness_in_Low_Stress[1] <- weighted.mean(my$Fitness_in_Low_Stress[my$Treatment == "EH0"],my$mn_re_dw_40[my$Treatment == "EH0"] )
centroids$Fitness_in_Low_Stress[2] <- weighted.mean(my$Fitness_in_Low_Stress[my$Treatment == "EH0_40"],my$mn_re_dw_40[my$Treatment == "EH0_40"] )
centroids$Fitness_in_Low_Stress[3] <- weighted.mean(my$Fitness_in_Low_Stress[my$Treatment == "EH40"],my$mn_re_dw_40[my$Treatment == "EH40"] )

# calculate kernels -----------------
mydata<-my[,c("Treatment", "Fitness_in_CM", "Fitness_in_Low_Stress")] # dataframe with PC1, PC2 (x and y axes) and continents (cont1)
mycols <- mypalette
myThreshold <- 95
myalpha <- 0.5
mykernel_low <- ks::kde(mydata[which(mydata$Treatment=="EH0"),c('Fitness_in_CM', 'Fitness_in_Low_Stress')])
mykernel_low <- with(mykernel_low, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_low <- data.frame(mykernel_low)

mykernel_flux <- ks::kde(mydata[which(mydata$Treatment=="EH0_40"),c('Fitness_in_CM', 'Fitness_in_Low_Stress')])
mykernel_flux <- with(mykernel_flux, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_flux <- data.frame(mykernel_flux)

mykernel_high <- ks::kde(mydata[which(mydata$Treatment=="EH40"),c('Fitness_in_CM', 'Fitness_in_Low_Stress')])
mykernel_high <- with(mykernel_high, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_high <- data.frame(mykernel_high)


# plot scatter with centroids and lines ------
mypalette <- c("#66FFFF", "#B266FF", "#FF6666")
p1 <- ggplot()+
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  xlim( min(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T), max(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T))+
  ylim( min(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T), max(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T))+
  geom_point(data=centroids, color = "black", cex = 5, aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress, color = Treatment))+
  geom_segment(mapping = aes(x=centroids[1,2], y=centroids[1,3], xend=centroids[3,2], yend=centroids[3,3]), linetype="solid", size=2, inherit.aes=F)+
  geom_point(data=centroids_uw, aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress), color = "gray50", cex = 5)+
  geom_segment(mapping = aes(x=centroids_uw[1,2], y=centroids_uw[1,3], xend=centroids_uw[3,2], yend=centroids_uw[3,3]), linetype="solid", size=2, inherit.aes=F, color ="gray50")+
  geom_point(data = myp[myp$treat %in% c("EH0","EH0_40", "EH40"),], aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress, color = Treatment), size = 2.5, alpha = 0.5, show.legend = T) +
  geom_point(data = myp[myp$treat %in% c("EH0","EH0_40", "EH40"),], aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress), shape = 1, colour = "black", size = 2.5, alpha = 0.5, show.legend = F)+
  theme_bw()+
  xlab("Fitness in CM (0% Stress)")+
  ylab("Fitness in 40% Stress")+
  coord_equal()+
  geom_path(data = mykernel_low, x=mykernel_low$x, y=mykernel_low$y, color = mypalette[1],inherit.aes = F, show.legend = F)+
  geom_path(data = mykernel_flux, x=mykernel_flux$x, y=mykernel_flux$y, color = mypalette[2],inherit.aes = F, show.legend = F)+
  geom_path(data = mykernel_high, x=mykernel_high$x, y=mykernel_high$y, color = mypalette[3],inherit.aes = F, show.legend = F)+
  geom_rug(data = myp[myp$treat %in% c("EH0","EH0_40", "EH40"),], aes(x=Fitness_in_CM, y=Fitness_in_Low_Stress, color = Treatment))+
  scale_color_manual(values = mypalette)
p1

# create and plot hist of resids for flux treat ---
# unweigthed
point1 <- c(centroids_uw[1,2], centroids_uw[1,3])
point2 <- c(centroids_uw[3,2], centroids_uw[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$y <- myp$Fitness_in_CM*myslope + myintercept

# weigthed
point1 <- c(centroids[1,2], centroids[1,3])
point2 <- c(centroids[3,2], centroids[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$yy <- myp$Fitness_in_CM*myslope + myintercept

# create plots for weighted and unweighted resids -----
# unweighted
p2 <- ggplot(myp[myp$Treatment == "EH0_40",], aes(x=Fitness_in_Low_Stress - y))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (Black Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p2

# weighted
p3 <- ggplot(myp[myp$Treatment == "EH0_40",], aes(x=Fitness_in_Low_Stress - yy))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Weighted Residuals \n (Gray Line)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p3

lay <- rbind(c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(2,2,NA,3,3,NA))
x <- grid.arrange(p1, p2, p3, layout_matrix = lay)
grid::grid.draw(x)
pdf(file = paste("000_SALT_KASSEN_0_40.pdf"),height = 11, width = 6); grid::grid.draw(x); dev.off()




#  40, 80 ------------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1) # assign bcids
myf <- my # save a frame for limits
my$Fitness_in_Low_Stress <- my$mn_dw_40 # store fitness in complete media
my$Fitness_in_High_Stress <- my$mn_dw_80 # store fitness in stress
my <- my[!is.na(my$Fitness_in_Low_Stress) & !is.na(my$Fitness_in_High_Stress) & my$Treatment %in% c("EH40", "EH40_80", "EH80"),] # remove NA entries
my$Treatment <- factor(my$Treatment, levels = c("EH40","EH40_80","EH80")) # reorder the treat factor

# create a dataset for the 0, 80 specialist fit line
myc <- my[my$Treatment %in% c("EH40", "EH80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my$remove <- F; my[my$id %in% myc$id,]$remove <- T
# viz
plot(my[my$treat %in% c("EH40", "EH80"),]$Fitness_in_High_Stress ~ my[my$treat %in% c("EH40", "EH80"),]$Fitness_in_Low_Stress)
points(myc$Fitness_in_High_Stress ~ myc$Fitness_in_Low_Stress, col = "red")

# remove multivariate outliers for the flux line too (need to do this as a separate step)
myc <- my[my$Treatment %in% c("EH40_80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_Low_Stress", "Fitness_in_High_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my[my$id %in% myc$id,]$remove <- T
myp <- my
my <- my[my$remove ==F,]

# Calculate unweighted and weighted centroids dataframes --------
centroids <- aggregate(cbind(my$Fitness_in_Low_Stress, my$Fitness_in_High_Stress)~my$Treatment,my,mean)
colnames(centroids) <-  c("Treatment","Fitness_in_Low_Stress", "Fitness_in_High_Stress")
centroids_uw <- centroids

centroids$Fitness_in_Low_Stress[1] <- weighted.mean(my$Fitness_in_Low_Stress[my$Treatment == "EH40"],my$mn_re_dw_40[my$Treatment == "EH40"] )
centroids$Fitness_in_Low_Stress[2] <- weighted.mean(my$Fitness_in_Low_Stress[my$Treatment == "EH40_80"],my$mn_re_dw_40[my$Treatment == "EH40_80"] )
centroids$Fitness_in_Low_Stress[3] <- weighted.mean(my$Fitness_in_Low_Stress[my$Treatment == "EH80"],my$mn_re_dw_40[my$Treatment == "EH80"] )
centroids$Fitness_in_High_Stress[1] <- weighted.mean(my$Fitness_in_High_Stress[my$Treatment == "EH40"],my$mn_re_dw_80[my$Treatment == "EH40"] )
centroids$Fitness_in_High_Stress[2] <- weighted.mean(my$Fitness_in_High_Stress[my$Treatment == "EH40_80"],my$mn_re_dw_80[my$Treatment == "EH40_80"] )
centroids$Fitness_in_High_Stress[3] <- weighted.mean(my$Fitness_in_High_Stress[my$Treatment == "EH80"],my$mn_re_dw_80[my$Treatment == "EH80"] )

# calculate kernels -----------------
mydata<-my[,c("Treatment", "Fitness_in_Low_Stress", "Fitness_in_High_Stress")] # dataframe with PC1, PC2 (x and y axes) and continents (cont1)
mycols <- mypalette
myThreshold <- 95
myalpha <- 0.5
mykernel_low <- ks::kde(mydata[which(mydata$Treatment=="EH40"),c('Fitness_in_Low_Stress', 'Fitness_in_High_Stress')])
mykernel_low <- with(mykernel_low, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_low <- data.frame(mykernel_low)

mykernel_flux <- ks::kde(mydata[which(mydata$Treatment=="EH40_80"),c('Fitness_in_Low_Stress', 'Fitness_in_High_Stress')])
mykernel_flux <- with(mykernel_flux, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_flux <- data.frame(mykernel_flux)

mykernel_high <- ks::kde(mydata[which(mydata$Treatment=="EH80"),c('Fitness_in_Low_Stress', 'Fitness_in_High_Stress')])
mykernel_high <- with(mykernel_high, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mykernel_high <- data.frame(mykernel_high)


# plot scatter with centroids and lines ------
mypalette <- c("#66FFFF", "#B266FF", "#FF6666")
p1 <- ggplot()+
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.5, color ="darkgray")+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.5, color ="darkgray")+
  xlim( min(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T), max(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T))+
  ylim( min(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T), max(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T))+
  geom_point(data=centroids, color = "black", cex = 5, aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress, color = Treatment))+
  geom_segment(mapping = aes(x=centroids[1,2], y=centroids[1,3], xend=centroids[3,2], yend=centroids[3,3]), linetype="solid", size=2, inherit.aes=F)+
  geom_point(data=centroids_uw, aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress), color = "gray50", cex = 5)+
  geom_segment(mapping = aes(x=centroids_uw[1,2], y=centroids_uw[1,3], xend=centroids_uw[3,2], yend=centroids_uw[3,3]), linetype="solid", size=2, inherit.aes=F, color ="gray50")+
  geom_point(data = myp[myp$treat %in% c("EH40","EH40_80", "EH80"),], aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress, color = Treatment), size = 2.5, alpha = 0.5, show.legend = T) +
  geom_point(data = myp[myp$treat %in% c("EH40","EH40_80", "EH80"),], aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress), shape = 1, colour = "black", size = 2.5, alpha = 0.5, show.legend = F)+
  theme_bw()+
  xlab("Fitness in 40% Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+
  geom_path(data = mykernel_low, x=mykernel_low$x, y=mykernel_low$y, color = mypalette[1],inherit.aes = F, show.legend = F)+
  geom_path(data = mykernel_flux, x=mykernel_flux$x, y=mykernel_flux$y, color = mypalette[2],inherit.aes = F, show.legend = F)+
  geom_path(data = mykernel_high, x=mykernel_high$x, y=mykernel_high$y, color = mypalette[3],inherit.aes = F, show.legend = F)+
  geom_rug(data = myp[myp$treat %in% c("EH40","EH40_80", "EH80"),], aes(x=Fitness_in_Low_Stress, y=Fitness_in_High_Stress, color = Treatment))+
  scale_color_manual(values = mypalette)
p1

# create and plot hist of resids for flux treat ---
# unweigthed
point1 <- c(centroids_uw[1,2], centroids_uw[1,3])
point2 <- c(centroids_uw[3,2], centroids_uw[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$y <- myp$Fitness_in_Low_Stress*myslope + myintercept

# weigthed
point1 <- c(centroids[1,2], centroids[1,3])
point2 <- c(centroids[3,2], centroids[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$yy <- myp$Fitness_in_Low_Stress*myslope + myintercept

# create plots for weighted and unweighted resids -----
# unweighted
p2 <- ggplot(myp[myp$Treatment == "EH40_80",], aes(x=Fitness_in_High_Stress - y))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (Black Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p2

# weighted
p3 <- ggplot(myp[myp$Treatment == "EH40_80",], aes(x=Fitness_in_High_Stress - yy))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Weighted Residuals \n (Gray Line)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p3

lay <- rbind(c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(2,2,NA,3,3,NA))
x <- grid.arrange(p1, p2, p3, layout_matrix = lay)
grid::grid.draw(x)
pdf(file = paste("000_SALT_KASSEN_40_80.pdf"),height = 11, width = 6); grid::grid.draw(x); dev.off()

```



# Kassen Plot
```{r}
# for SALT  ---------------------------------------------------------------------
#  0, 80 ------------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1) # assign bcids
myf <- my # save a frame for limits
my$Fitness_in_CM <- my$mn_dw_0 # store fitness in complete media
my$Fitness_in_High_Stress <- my$mn_dw_80 # store fitness in stress
my <- my[!is.na(my$Fitness_in_CM) & !is.na(my$Fitness_in_High_Stress) & my$Treatment %in% c("EH0", "EH0_80", "EH80"),] # remove NA entries
my$Treatment <- factor(my$Treatment, levels = c("EH0","EH0_80","EH80")) # reorder the treat factor

myp <- my
myp$cutoff <- NA
myp$md <- NA
for (i in c("EH0", "EH0_80","EH80")) {
  myt <- myp[myp$Treatment == i,]
  md <- mahalanobis(x = myt[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myt[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myt[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
  myp[myp$Treatment == i,]$md <- md
  alpha <- 0.10
  cutoff <- (qchisq(p = 1 - alpha, df = ncol(myp[myp$Treatment == i,][, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
  myp[myp$Treatment == i,]$cutoff <- cutoff
}

# viz
plot(myp$Fitness_in_High_Stress ~ myp$Fitness_in_CM)
points(myp[myp$md >= myp$cutoff,]$Fitness_in_High_Stress ~ myp[myp$md >= myp$cutoff,]$Fitness_in_CM, col = "red")

# Calculate unweighted and weighted centroids dataframes --------
mypc <- myp[myp$md < myp$cutoff,]
centroids <- aggregate(cbind(mypc$Fitness_in_CM, mypc$Fitness_in_High_Stress)~mypc$Treatment,mypc,mean)
colnames(centroids) <-  c("Treatment","Fitness_in_CM", "Fitness_in_High_Stress")
centroids_uw <- centroids

centroids$Fitness_in_CM[1] <- weighted.mean(mypc$Fitness_in_CM[mypc$Treatment == "EH0"],mypc$mn_re_dw_0[mypc$Treatment == "EH0"] )
centroids$Fitness_in_CM[2] <- weighted.mean(mypc$Fitness_in_CM[mypc$Treatment == "EH0_80"],mypc$mn_re_dw_0[mypc$Treatment == "EH0_80"] )
centroids$Fitness_in_CM[3] <- weighted.mean(mypc$Fitness_in_CM[mypc$Treatment == "EH80"],mypc$mn_re_dw_0[mypc$Treatment == "EH80"] )
centroids$Fitness_in_High_Stress[1] <- weighted.mean(mypc$Fitness_in_High_Stress[mypc$Treatment == "EH0"],mypc$mn_re_dw_80[mypc$Treatment == "EH0"] )
centroids$Fitness_in_High_Stress[2] <- weighted.mean(mypc$Fitness_in_High_Stress[mypc$Treatment == "EH0_80"],mypc$mn_re_dw_80[mypc$Treatment == "EH0_80"] )
centroids$Fitness_in_High_Stress[3] <- weighted.mean(mypc$Fitness_in_High_Stress[mypc$Treatment == "EH80"],mypc$mn_re_dw_80[mypc$Treatment == "EH80"] )

# calculate kernels -----------------
mypcdata<-myp[,c("Treatment", "Fitness_in_CM", "Fitness_in_High_Stress")] # dataframe with PC1, PC2 (x and y axes) and continents (cont1)


mypckernel_low <- ks::kde(mypcdata[which(mypcdata$Treatment=="EH0"),c('Fitness_in_CM', 'Fitness_in_High_Stress')])
mypckernel_low <- with(mypckernel_low, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mypckernel_low <- data.frame(mypckernel_low)

mypckernel_flux <- ks::kde(mypcdata[which(mypcdata$Treatment=="EH0_80"),c('Fitness_in_CM', 'Fitness_in_High_Stress')])
mypckernel_flux <- with(mypckernel_flux, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mypckernel_flux <- data.frame(mypckernel_flux)

mypckernel_high <- ks::kde(mypcdata[which(mypcdata$Treatment=="EH80"),c('Fitness_in_CM', 'Fitness_in_High_Stress')])
mypckernel_high <- with(mypckernel_high, contourLines(x=eval.points[[1]], y = eval.points[[2]],z=estimate,levels=cont["25%"])[[1]])
mypckernel_high <- data.frame(mypckernel_high)

# run the model ---------------------
# unweighted

mypclf <- mypc[mypc$Treatment %in% c("EH0", "EH80"),]
mymod_uw <- glm(mypclf$Fitness_in_High_Stress ~ mypclf$Fitness_in_CM + I(mypclf$Fitness_in_CM^2))
mypclf$predlm_uw <- predict(mymod_uw)
summary(mymod_uw)

mymod_w <- glm(mypclf$Fitness_in_High_Stress ~ mypclf$Fitness_in_CM + I(mypclf$Fitness_in_CM^2), weights = rowMeans(cbind(mypclf$mn_re_dw_0, mypclf$mn_dw_80), na.rm = T))
mypclf$predlm_w <- predict(mymod_w)
summary(mymod_w)

mymod_uwl <- glm(mypclf$Fitness_in_High_Stress ~ mypclf$Fitness_in_CM)
mypclf$predlm_uwl <- predict(mymod_uwl)
summary(mymod_uwl)

mymod_wl <- glm(mypclf$Fitness_in_High_Stress ~ mypclf$Fitness_in_CM, weights = rowMeans(cbind(mypclf$mn_re_dw_0, mypclf$mn_dw_80), na.rm = T))
mypclf$predlm_wl <- predict(mymod_wl)
summary(mymod_wl)


# plot scatter with centroids and lines ------
mypalette <- c("#66FFFF", "#B266FF", "#FF6666")
p1 <- ggplot()+
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", size = 0.25, color ="darkgray", alpha = 0.9)+  
  geom_abline(intercept = 0, slope = -1, linetype = "dashed", size = 0.25, color ="darkgray")+
  xlim( min(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T), max(c(myf$mn_dw_0, myf$mn_dw_40), na.rm = T))+
  ylim( min(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T), max(c(myf$mn_dw_40, myf$mn_dw_80), na.rm = T))+
   geom_point(data=centroids, color = "black", cex = 5, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment))+
  geom_segment(mapping = aes(x=centroids[1,2], y=centroids[1,3], xend=centroids[3,2], yend=centroids[3,3]), linetype="solid", size=2, inherit.aes=F)+
  geom_point(data=centroids_uw, aes(x=Fitness_in_CM, y=Fitness_in_High_Stress), color = "gray50", cex = 5)+
  geom_segment(mapping = aes(x=centroids_uw[1,2], y=centroids_uw[1,3], xend=centroids_uw[3,2], yend=centroids_uw[3,3]), linetype="solid", size=2, inherit.aes=F, color ="gray50")+
   geom_path(data = mypckernel_low, x=mypckernel_low$x, y=mypckernel_low$y, color = mypalette[1],inherit.aes = F, show.legend = F)+
  geom_path(data = mypckernel_flux, x=mypckernel_flux$x, y=mypckernel_flux$y, color = mypalette[2],inherit.aes = F, show.legend = F)+
  geom_path(data = mypckernel_high, x=mypckernel_high$x, y=mypckernel_high$y, color = mypalette[3],inherit.aes = F, show.legend = F)+
  geom_point(data = myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment), size = 2.5, alpha = 0.5, show.legend = T) +
  geom_point(data = myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress), shape = 1, colour = "black", size = 2.5, alpha = 0.5, show.legend = F)+
  geom_line(aes(x = mypclf$Fitness_in_CM, y=mypclf$predlm_uw), color = "Blue")+
  geom_line(aes(x = mypclf$Fitness_in_CM, y=mypclf$predlm_w), color = "Red")+
  geom_line(aes(x = mypclf$Fitness_in_CM, y=mypclf$predlm_uwl), color = "black")+
  geom_line(aes(x = mypclf$Fitness_in_CM, y=mypclf$predlm_wl), color = "darkgray")+

  theme_bw()+
  xlab("Fitness in CM (0% Stress)")+
  ylab("Fitness in 80% Stress")+
  coord_equal()+

  geom_rug(data = myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment))+
  scale_color_manual(values = mypalette)
p1

# create and plot hist of resids for flux treat ---
# unweigthed
point1 <- c(centroids_uw[1,2], centroids_uw[1,3])
point2 <- c(centroids_uw[3,2], centroids_uw[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$y <- myp$Fitness_in_CM*myslope + myintercept

# weigthed
point1 <- c(centroids[1,2], centroids[1,3])
point2 <- c(centroids[3,2], centroids[3,3])
myslope <- (point2[2] - point1[2]) / (point2[1] - point1[1])
myintercept <- point2[2] - (myslope*point2[1])
myp$yy <- myp$Fitness_in_CM*myslope + myintercept

myp$yyy <- mymod_uwl$coefficients[1] + myp$Fitness_in_CM*mymod_uwl$coefficients[2]
myp$yyyy <- mymod_wl$coefficients[1] + myp$Fitness_in_CM*mymod_wl$coefficients[2]


# create plots for weighted and unweighted resids -----
# unweighted
p2 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (Black Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p2

# weighted
p3 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - yy))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Weighted Residuals \n (Gray Line)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p3

# unweighted linear
p4 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - yyy))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (Black Linear Model)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p4

# unweighted linear
p5 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - yyyy))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Weighted Residuals \n (Gray Linear Model)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p5

lay <- rbind(c(1,1,1,1,1,1,1,1),
             c(1,1,1,1,1,1,1,1),
             c(1,1,1,1,1,1,1,1),
             c(1,1,1,1,1,1,1,1),
             c(2,2,3,3,4,4,5,5))
x <- grid.arrange(p1, p2, p3, p4,p5, layout_matrix = lay)
grid::grid.draw(x)
pdf(file = paste("000_SALT_KASSEN_0_80.pdf"),height = 11, width = 11); grid::grid.draw(x); dev.off()

```





# Kassen Plot
```{r}
# for SALT  ---------------------------------------------------------------------
#  0, 80 ------------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1) # assign bcids
myf <- my # save a frame for limits
my$Fitness_in_CM <- my$mn_dw_0 # store fitness in complete media
my$Fitness_in_High_Stress <- my$mn_dw_80 # store fitness in stress
my <- my[!is.na(my$Fitness_in_CM) & !is.na(my$Fitness_in_High_Stress) & my$Treatment %in% c("EH0", "EH0_80", "EH80"),] # remove NA entries
my$Treatment <- factor(my$Treatment, levels = c("EH0","EH0_80","EH80")) # reorder the treat factor

# create a dataset for the 0, 80 specialist fit line
myc <- my[my$Treatment %in% c("EH0", "EH80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my$remove <- F; my[my$id %in% myc$id,]$remove <- T
# viz
plot(my[my$treat %in% c("EH0", "EH80"),]$Fitness_in_High_Stress ~ my[my$treat %in% c("EH0", "EH80"),]$Fitness_in_CM)
points(myc$Fitness_in_High_Stress ~ myc$Fitness_in_CM, col = "red")

# remove multivariate outliers for the flux line too (need to do this as a separate step)
myc2 <- my[my$Treatment %in% c("EH0_80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
myc2$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
myc2 <- myc2[myc2$md > cutoff,]
myc2$id
my[my$id %in% myc2$id,]$remove <- T
myp <- my
my <- my[my$remove ==F,]

# run the model ---------------------
# unweighted
mymod_uw <- glm(my$Fitness_in_High_Stress ~ my$Fitness_in_CM + I(my$Fitness_in_CM^2))
my$predlm_uw <- NA
my[my$Treatment %in% c("EH0","EH0_80", "EH80"),]$predlm_uw <- predict(mymod_uw)

# weighted
mymod <- glm(my$Fitness_in_High_Stress ~ my$Fitness_in_CM + I(my$Fitness_in_CM^2), weights = rowMeans(cbind(my$mn_re_dw_0, my$mn_re_dw_80)))
my$predlm <- NA
my[my$Treatment %in% c("EH0","EH0_80", "EH80"),]$predlm <- predict(mymod)



# visualize
mypalette <- c("#66FFFF", "#B266FF", "#FF6666")
p1 <- ggplot(myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment, weight = mn_re_dw_80)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_point(size = 2.5, alpha = 0.5, show.legend = T) +
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5, show.legend = F)+
  scale_color_manual(values = mypalette)+
  geom_line(data = my, aes(y=predlm_uw), color = "black")+
  geom_line(data = my, aes(y=predlm), color = "gray50")+
  theme_bw()+
  coord_equal()+
  geom_rug()
p1


myp$y_uw <- NA
myp$y_uw <- myp$Fitness_in_CM*mymod_uw$coefficients["my$Fitness_in_CM"] + myp$Fitness_in_CM^2*mymod_uw$coefficients["I(my$Fitness_in_CM^2)"] + mymod_uw$coefficients["(Intercept)"]

myp$y <- NA
myp$y <- myp$Fitness_in_CM*mymod$coefficients["my$Fitness_in_CM"] + myp$Fitness_in_CM^2*mymod$coefficients["I(my$Fitness_in_CM^2)"] + mymod$coefficients["(Intercept)"]


# create plots for weighted and unweighted resids -----
# unweighted
p2 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y_uw))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (Black Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p2

# weighted
p3 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Weighted Residuals \n (Gray Line)")+
  xlab("Fitness Residuals")+
  ylab("")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p3

lay <- rbind(c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(2,2,NA,3,3,NA))
x <- grid.arrange(p1, p2, p3, layout_matrix = lay)
grid::grid.draw(x)
pdf(file = paste("000_SALT_KASSEN_0_80_poly2_weights_explore.pdf"),height = 11, width = 6); grid::grid.draw(x); dev.off()
```




# Kassen Plot
```{r}
# for SALT  ---------------------------------------------------------------------
#  0, 80 ------------------------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$Treatment <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # reorder the treat factor
my$id <- paste0(my$epo, my$bc1) # assign bcids
myf <- my # save a frame for limits
my$Fitness_in_CM <- my$mn_dw_0 # store fitness in complete media
my$Fitness_in_High_Stress <- my$mn_dw_80 # store fitness in stress
my <- my[!is.na(my$Fitness_in_CM) & !is.na(my$Fitness_in_High_Stress) & my$Treatment %in% c("EH0", "EH0_80", "EH80"),] # remove NA entries
my$Treatment <- factor(my$Treatment, levels = c("EH0","EH0_80","EH80")) # reorder the treat factor

# create a dataset for the 0, 80 specialist fit line
myc <- my[my$Treatment %in% c("EH0", "EH80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
myc$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc[, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
myc <- myc[myc$md > cutoff,]
myc$id
my$remove <- F; my[my$id %in% myc$id,]$remove <- T
# viz
plot(my[my$treat %in% c("EH0", "EH80"),]$Fitness_in_High_Stress ~ my[my$treat %in% c("EH0", "EH80"),]$Fitness_in_CM)
points(myc$Fitness_in_High_Stress ~ myc$Fitness_in_CM, col = "red")

# remove multivariate outliers for the flux line too (need to do this as a separate step)
myc2 <- my[my$Treatment %in% c("EH0_80"),]
# find outliers by Mahalanobis distance ----------
md <- mahalanobis(x = myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")], 
                  center = colMeans(myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")]), 
                  cov = cov(myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")]))
myc2$md <- md
alpha <- 0.05
cutoff <- (qchisq(p = 1 - alpha, df = ncol(myc2[, c("Fitness_in_CM", "Fitness_in_High_Stress")])))
myc2 <- myc2[myc2$md > cutoff,]
myc2$id
my[my$id %in% myc2$id,]$remove <- T
myp <- my
my <- my[my$remove ==F,]

# run the model ---------------------
# unweighted
mymod_uw <- glm(my$Fitness_in_High_Stress ~ my$Fitness_in_CM)
mymod_uw2 <- glm(my$Fitness_in_High_Stress ~ my$Fitness_in_CM + I(my$Fitness_in_CM^2))
mymod_uw3 <- glm(my$Fitness_in_High_Stress ~ my$Fitness_in_CM + I(my$Fitness_in_CM^2) + I(my$Fitness_in_CM^3))
mymod_uw4 <- glm(my$Fitness_in_High_Stress ~ my$Fitness_in_CM + I(my$Fitness_in_CM^2) + I(my$Fitness_in_CM^3) + I(my$Fitness_in_CM^4))
myAIC <- AIC(mymod_uw, mymod_uw2, mymod_uw3, mymod_uw4)

my$predlm_uw <- NA
my$predlm_uw2 <- NA
my$predlm_uw3 <- NA
my$predlm_uw4 <- NA
my[my$Treatment %in% c("EH0","EH0_80", "EH80"),]$predlm_uw <- predict(mymod_uw)
my[my$Treatment %in% c("EH0","EH0_80", "EH80"),]$predlm_uw2 <- predict(mymod_uw2)
my[my$Treatment %in% c("EH0","EH0_80", "EH80"),]$predlm_uw3 <- predict(mymod_uw3)
my[my$Treatment %in% c("EH0","EH0_80", "EH80"),]$predlm_uw4 <- predict(mymod_uw4)

# visualize
mypalette <- c("#66FFFF", "#B266FF", "#FF6666")
p1 <- ggplot(myp[myp$treat %in% c("EH0","EH0_80", "EH80"),], aes(x=Fitness_in_CM, y=Fitness_in_High_Stress, color = Treatment, weight = mn_re_dw_80)) +
  geom_vline(xintercept=0, color = "darkgray")+
  geom_hline(yintercept = 0, color = "darkgray")+
  geom_point(size = 2.5, alpha = 0.5, show.legend = T) +
  geom_point(shape = 1, colour = "black", size = 2.5, alpha = 0.5, show.legend = F)+
  scale_color_manual(values = mypalette)+
  geom_line(data =my, aes(y=predlm_uw), color = "black")+
  geom_line(data =my, aes(y=predlm_uw2), color = "darkgray")+
  geom_line(data =my, aes(y=predlm_uw3), color = "darkgreen")+
  geom_line(data =my, aes(y=predlm_uw4), color = "darkorange")+
  theme_bw()+
  coord_equal()+
  geom_rug()
p1


myp$y_uw <- NA
myp$y_uw2 <- NA
myp$y_uw3 <- NA
myp$y_uw4 <- NA

myp$y_uw <- myp$Fitness_in_CM*mymod_uw$coefficients["my$Fitness_in_CM"] + mymod_uw$coefficients["(Intercept)"]

myp$y_uw2 <- myp$Fitness_in_CM*mymod_uw2$coefficients["my$Fitness_in_CM"] + myp$Fitness_in_CM^2*mymod_uw2$coefficients["I(my$Fitness_in_CM^2)"] + mymod_uw$coefficients["(Intercept)"]

myp$y_uw3 <- myp$Fitness_in_CM*mymod_uw3$coefficients["my$Fitness_in_CM"] + myp$Fitness_in_CM^2*mymod_uw3$coefficients["I(my$Fitness_in_CM^2)"] + myp$Fitness_in_CM^3*mymod_uw3$coefficients["I(my$Fitness_in_CM^3)"]+ mymod_uw$coefficients["(Intercept)"]

myp$y_uw4 <- myp$Fitness_in_CM*mymod_uw4$coefficients["my$Fitness_in_CM"] + myp$Fitness_in_CM^2*mymod_uw4$coefficients["I(my$Fitness_in_CM^2)"] + myp$Fitness_in_CM^3*mymod_uw4$coefficients["I(my$Fitness_in_CM^3)"] + myp$Fitness_in_CM^4*mymod_uw4$coefficients["I(my$Fitness_in_CM^4)"]+ mymod_uw$coefficients["(Intercept)"]

# create plots for  resids -----
# linear
p2 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y_uw))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (n = Black Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p2

# n2
p3 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y_uw2))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (n+n^2 = Gray Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p3

# n3
p4 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y_uw3))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (n+n^2+n^3 = Green Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p4

# n4
p5 <- ggplot(myp[myp$Treatment == "EH0_80",], aes(x=Fitness_in_High_Stress - y_uw4))+
  geom_histogram(fill = "#B266FF", color = "white")+
  geom_vline(xintercept = 0, lty = "dashed")+
  ggtitle("Unweighted Residuals \n (n+n^2+n^3+n^4 = Green Line)")+
  xlab("Fitness Residuals")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p5


lay <- rbind(c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(1,1,1,1,1,1),
             c(2,2,NA,3,3,NA),
             c(4,4,NA,5,5,NA))
x <- grid.arrange(p1, p2, p3, p4, p5, layout_matrix = lay)
grid::grid.draw(x)
pdf(file = paste("000_SALT_KASSEN_0_80_multipoly_explore.pdf"),height = 11, width = 6); grid::grid.draw(x); dev.off()
```





# SALT data...
# Set universal guides for SALT plotting
```{r}
my <- mydwc[!is.na(mydwc$dw),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]

mylowlim <- round(min(my$dw, na.rm = T)*1.10, 2)
myhighlim <- round(max(my$dw, na.rm = T)*1.10, 2)
mytitle <- NULL
myylab <- "Fitness change"
myxlab <- "Treatment"
myoutline <-  "grey20"
myfill <-  "grey90"
myptalpha <- 0.5
myrugalpha <- 0.7
mypalette <- dichrompalette_br_cy
mytextsize <- 8
myheight <- 3.5
mywidth <- 7
mymeanptsize <- 1
mywtmeanpttype <- 1
mywtmeanptcol <- "black"

# ------------------
rm(my)
```
<br/><br/>

# Calculate covariates for SALT (MOVE THIS BLOCK TO THE PREP FRAME EVENTUALLY)
```{r}
my <- myd

# calculate median counts for each bc. 
my$mncount0i <- NA
my$mncount0f <- NA
for(i in 1:nrow(my)){
  my$mncount0i[i] <- weighted.mean(my[i,c("bc1cts_r1i_a", "bc1cts_r2i_a", "bc1cts_r3i_a", "bc1cts_r4i_a", "bc1cts_r5i_a")],
                                    my[i,c("re_r1i_a", "re_r2i_a", "re_r3i_a", "re_r4i_a", "re_r5i_a")], na.rm = T)
  my$mncount0f[i] <- weighted.mean(my[i,c("bc1cts_f_r1a", "bc1cts_f_r2a", "bc1cts_f_r3a", "bc1cts_f_r4a")],
                                    my[i,c("re_f_r1a", "re_f_r2a", "re_f_r3a", "re_f_r4a")], na.rm = T)
}
my$medcount <- apply(cbind(my$mncount0i, my$mncount0f, my$bc1cts_i_e, my$bc1cts_f_e),
                  1, median, na.rm = T)

# calcualte median proportion
my$prop_i_0r1 <- my$bc1cts_r1i_a / (my$bc1cts_r1i_a + my$bc2cts_r1i_a)
my$prop_i_0r2 <- my$bc1cts_r2i_a / (my$bc1cts_r2i_a + my$bc2cts_r2i_a)
my$prop_i_0r3 <- my$bc1cts_r3i_a / (my$bc1cts_r3i_a + my$bc2cts_r3i_a)
my$prop_i_0r4 <- my$bc1cts_r4i_a / (my$bc1cts_r4i_a + my$bc2cts_r4i_a)
my$prop_i_0r5 <- my$bc1cts_r5i_a / (my$bc1cts_r5i_a + my$bc2cts_r5i_a)

my$prop_f_0r1 <- my$bc1cts_f_r1a / (my$bc1cts_f_r1a + my$bc2cts_f_r1a)
my$prop_f_0r2 <- my$bc1cts_f_r2a / (my$bc1cts_f_r2a + my$bc2cts_f_r2a)
my$prop_f_0r3 <- my$bc1cts_f_r3a / (my$bc1cts_f_r3a + my$bc2cts_f_r3a)
my$prop_f_0r4 <- my$bc1cts_f_r4a / (my$bc1cts_f_r4a + my$bc2cts_f_r4a)

my$prop_i_500r1 <- my$bc1cts_r1i_e / (my$bc1cts_r1i_e + my$bc2cts_r1i_e)
my$prop_i_500r2 <- my$bc1cts_r2i_e / (my$bc1cts_r2i_e + my$bc2cts_r2i_e)
my$prop_i_500r3 <- my$bc1cts_r3i_e / (my$bc1cts_r3i_e + my$bc2cts_r3i_e)
my$prop_i_500r4 <- my$bc1cts_r4i_e / (my$bc1cts_r4i_e + my$bc2cts_r4i_e)
my$prop_i_500r5 <- my$bc1cts_r5i_e / (my$bc1cts_r5i_e + my$bc2cts_r5i_e)

my$prop_f_500 <- my$bc1cts_f_e / (my$bc1cts_f_e + my$bc2cts_f_e)

my$mnprop0i <- NA
my$mnprop0f <- NA
for(i in 1:nrow(my)){
  my$mnprop0i[i] <- weighted.mean(my[i,c("prop_i_0r1", "prop_i_0r2", "prop_i_0r3", "prop_i_0r4", "prop_i_0r5")],
                                    my[i,c("re_r1i_a", "re_r2i_a", "re_r3i_a", "re_r4i_a", "re_r5i_a")], na.rm = T)
  my$mnprop0f[i] <- weighted.mean(my[i,c("prop_f_0r1", "prop_f_0r2", "prop_f_0r3", "prop_f_0r4")],
                                    my[i,c("re_f_r1a", "re_f_r2a", "re_f_r3a", "re_f_r4a")], na.rm = T)
  my$mnprop500i[i] <- weighted.mean(my[i,c("prop_i_500r1", "prop_i_500r2", "prop_i_500r3", "prop_i_500r4", "prop_i_500r5")],
                                    my[i,c("re_r5i_e", "re_r2i_e", "re_r3i_e", "re_r4i_e", "re_r5i_e")], na.rm = T)
}
my$medprop <- apply(cbind(my$mnprop0i, my$mnprop0f, my$mnprop500i, my$prop_f_500),
                  1, median, na.rm = T)
my2 <- my



# create the frame, omitting most cols not necessary for these upcoming plots and tests.
my <- my2
my <- my[,c(1:7, 83:88, 112, 123, 126:148)] # reatain only interst columns
my1 <- my[my$mpar == 1,] # r1
my2 <- my[my$mpar == 2,]; colnames(my2) <- paste0(colnames(my2), "_2") # r2
my3 <- my[my$mpar == 3,]; colnames(my3) <- paste0(colnames(my3), "_3") # r3
my4 <- my[my$mpar == 4,]; colnames(my4) <- paste0(colnames(my4), "_4") # r4
my <- cbind(my1, my2$re_dw_2, my2$dw_2, my3$re_dw_3, my3$dw_3, my4$re_dw_4, my4$dw_4) # zip
colnames(my)[c((ncol(my)-5)):ncol(my)] <- c("re_dw_2", "dw_2", "re_dw_3", "dw_3", "re_dw_4", "dw_4") # name fix
mn_dw <- apply(my, 1, function(x) weighted.mean(as.numeric(x[c( "dw", "dw_2", "dw_3", "dw_4")]), 
                                                  as.numeric(x[c( "re_dw","re_dw_2","re_dw_3","re_dw_4")]), na.rm = T)) # calculate wtd.mean dw across reps
my$mn_dw <- mn_dw; my$mn_dw[is.nan(my$mn_dw)] <- NA # fix nans
my$omit <- F; my$omit[is.na(my$mn_dw)] <- T # update omit field
mn_re_dw <- apply(my, 1, function(x) mean(as.numeric(x[c( "re_dw", "re_dw_2", "re_dw_3", "re_dw_4")]), na.rm =T)) # calculate reads for mn_dw
my$mn_re_dw <- mn_re_dw # assign
my$mn_re_dw[is.nan(my$mn_re_dw)] <- NA
my$se_dw <- apply(my[,c("dw", "dw_2", "dw_3", "dw_4")], 1, sjstats::se)
mydwc_se <- my # name frame


mymod <- lm(I(scale(mydwc_se$se_dw)) ~ I(scale(mydwc_se$mn_dw)) + I(scale(mydwc_se$medcount)) +  I(scale(mydwc_se$medprop)) + mydwc_se$treat, weights = mydwc_se$mn_re_dw); summary(mymod); anova(mymod)


rm(my, i)
```

# SALT evolved in CM -- STATISTICAL TEST
```{r}
# Test - SALT DATA IN CM --------------------------------------------------------
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```

# SALT Evolved in CM -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("SALT_A", "SALT_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp
# figure output ---------------------------------------------------------------
pdf(file = "000_SALTinCM.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc)
```
<br/><br/>



# SALT evolved in CM+40% NaCl -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "SALT" & my$mpasp == 0.4 & my$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>

# SALT evolved in CM+40% NaCl -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "SALT" & my$mpasp == 0.4 & my$epo %in% c("SALT_A", "SALT_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_SALTinSALT40.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
```
<br/><br/>



# SALT evolved in CM+80% NaCl -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "SALT" & my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>

# SALT evolved in CM+80% NaCl -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "SALT" & my$mpasp == 0.8 & my$epo %in% c("SALT_A", "SALT_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_SALTinSALT80.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
```
<br/><br/>



# SALT evolved in CM+120% NaCl -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "SALT" & my$mpasp == 1.2 & my$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>

# SALT evolved in CM+120% NaCl -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "SALT" & my$mpasp == 1.2 & my$epo %in% c("SALT_A", "SALT_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
#m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
#m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.25, ymax = 0.5)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_SALTinSALT120.pdf", width = mywidth, height = myheight); pppp; dev.off()


rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
rm(mylowlim, myhighlim, mytitle, myylab, myxlab, myoutline, myfill, myptalpha, myrugalpha, mypalette, mytextsize,
   myheight, mywidth, mymeanptsize, mywtmeanptcol, mywtmeanpttype, myp)
```
<br/><br/>













# COPR next....
# lets set some universal guides for COPR plotting
```{r}
my <- mydwc[!is.na(mydwc$dw),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]

mylowlim <- round(min(my$dw, na.rm = T)*1.10, 2)
myhighlim <- round(max(my$dw, na.rm = T)*1.10, 2)
mytitle <- NULL
myylab <- "Fitness change"
myxlab <- "Treatment"
myoutline <-  "grey20"
myfill <-  "grey90"
myptalpha <- 0.5
myrugalpha <- 0.7
mypalette <- dichrompalette_br_cy
mytextsize <- 8
myheight <- 3.5
mywidth <- 7
mymeanptsize <- 1
mywtmeanpttype <- 1
mywtmeanptcol <- "black"

# ------------------
rm(my)
```
<br/><br/>


# COPR Evolved in CM -- STATISTICAL TEST
```{r}
# Test - COPR DATA IN CM --------------------------------------------------------
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>


# COPR Evolved in CM -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "CM" & my$mpasp == 0.0 & my$epo %in% c("COPR_A", "COPR_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = .6, ymax = 1)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.6, ymax = 1)
pppp
# figure output ---------------------------------------------------------------
pdf(file = "000_COPRinCM.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc)
```
<br/><br/>


# COPR evolved in CM+40% COPR -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "COPR" & my$mpasp == 0.4 & my$epo %in% c("COPR_A", "COPR_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>


# COPR evolved in CM+40% COPR -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "COPR" & my$mpasp == 0.4 & my$epo %in% c("COPR_A", "COPR_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = .6, ymax = 1)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.6, ymax = 1)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_COPRinCOPR40.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
```
<br/><br/>


# COPR evolved in CM+80% COPR -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "COPR" & my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>


# COPR evolved in CM+80% COPR -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "COPR" & my$mpasp == 0.8 & my$epo %in% c("COPR_A", "COPR_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
# m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
# m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = .6, ymax = 1)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.6, ymax = 1)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_COPRinCOPR80.pdf", width = mywidth, height = myheight); pppp; dev.off()

rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
```
<br/><br/>


# COPR evolved in CM+120% COPR -- STATISTICAL TEST
```{r}
my <- my2[!is.na(my2$dw),] 
my <- my[my$mpamt == "COPR" & my$mpasp == 1.2 & my$epo %in% c("COPR_A", "COPR_B"),]
my$treat <- relevel(my$treat, ref = "EH0")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
AIC(mymod)

mysumm <- summary(mymod)$coefficients
myres <- matrix(nrow = 7, ncol=7)
rownames(myres) <- c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")
colnames(myres) <- rownames(myres)
myres_p <- myres; myres_est <- myres
for(i in c("my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0",i] <- mysumm[i, "Pr(>|t|)"]
}

my$treat <- relevel(my$treat, ref = "EH0_40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH40",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH20_60")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH0_80","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH20_60",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH20_60",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH0_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH40_80","my$treatEH80")){
  myres_est["my$treatEH0_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH0_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH40_80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH80")){
  myres_est["my$treatEH40_80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH40_80",i] <- mysumm[i, "Pr(>|t|)"]
}
my$treat <- relevel(my$treat, ref = "EH80")
mymod <- lmer(my$dw ~ my$treat + (1|my$bcpID), weights = my$re_dw, control=lmerControl(optimizer ="bobyqa",optCtrl=list(maxfun=2e4)), na.action = "na.fail"); summary(mymod)
mysumm <- summary(mymod)$coefficients
for(i in c("my$treatEH0","my$treatEH0_40","my$treatEH40","my$treatEH20_60","my$treatEH0_80","my$treatEH40_80")){
  myres_est["my$treatEH80",i] <- mysumm[i, "Estimate"]
  myres_p["my$treatEH80",i] <- mysumm[i, "Pr(>|t|)"]
}
```
<br/><br/>


# COPR evolved in CM+120% COPR -- VIZ (Violin w/ heatmap)
```{r}
# data -------------------------------------------------------------------------
my <- mydwc[!is.na(mydwc$mn_dw),]
my <- my[my$mpamt == "COPR" & my$mpasp == 1.2 & my$epo %in% c("COPR_A", "COPR_B"),]

# Visualize -------------------------------------------------------------------
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
myx <- my$treat
myy <- my$mn_dw
myr <- my$mn_re_dw
myc <- my$treat
myptsize <- ((((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))) - min(((myr/max(myr))*10)*((myheight*mywidth)/(3.5*7*3))))+0.5

p <- ggplot(my, aes(x=myx, y=myy, weight = myr, color = myc)) +
  geom_violin(color = myoutline, fill = myfill, draw_quantiles = NULL, inherit.aes = F, aes( x=myx, y=myy), trim = T) + 
  geom_jitter(width =0.15, height = 0, alpha = myptalpha, size = myptsize) +
  geom_rug(sides = "b" , position = position_nudge(x=-0.75), alpha = myrugalpha)+
  geom_point(stat="summary", fun.y="mean", color = mywtmeanptcol, cex = mymeanptsize) + 
  geom_errorbar(stat="summary", fun.data = "mean_se",color = mywtmeanptcol, width = 0.0, lwd =0.5)+
  geom_point(x=7,y = weighted.mean(myy[myx == "EH80"], myr[myx == "EH80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=6,y = weighted.mean(myy[myx == "EH40_80"], myr[myx == "EH40_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=5,y = weighted.mean(myy[myx == "EH0_80"], myr[myx == "EH0_80"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=4,y = weighted.mean(myy[myx == "EH20_60"], myr[myx == "EH20_60"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=3,y = weighted.mean(myy[myx == "EH40"], myr[myx == "EH40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=2,y = weighted.mean(myy[myx == "EH0_40"], myr[myx == "EH0_40"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  geom_point(x=1,y = weighted.mean(myy[myx == "EH0"], myr[myx == "EH0"], na.rm = T), color = mywtmeanptcol, pch = mywtmeanpttype, size = mymeanptsize) +
  scale_color_manual(values =mypalette) + 
  geom_hline(yintercept = 0, lty = "dotted") + 
  coord_flip() +
  theme_classic()+
  theme(legend.position="none") +
  ggtitle(mytitle) + ylab(myylab) + xlab(myxlab)+
  scale_x_discrete(labels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) +
  scale_y_continuous(breaks = seq(mylowlim, myhighlim,by=.05),
                     limits = c(mylowlim, myhighlim),
                     labels = scales::number_format(accuracy = 0.01))+
  theme(axis.title.y = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.title.x = element_text(size = 8, face = "bold", margin = margin(0,0,0,0, "pt")))+
  theme(axis.text.y = element_text(size = 8, angle = 0))+
  theme(axis.text.x = element_text(size = 8, angle = 0))

myp <- 0.05
myres_est[myres_p >= myp] <- NA
m <- round(myres_est, 2)
colnames(m) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")
rownames(m) <- colnames(m)
#m <- get_lower_tri(m) # uncomment for just lower triangle
melt_m <- reshape::melt(m)
melt_m$X1 <- factor(melt_m$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m$X2 <- factor(melt_m$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

pp <- ggplot(melt_m, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "black", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
  theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

m2 <- m; m2[1:length(m2)] <- 0
#m2 <- get_lower_tri(m2) # uncomment for just lower triangle
melt_m2 <- reshape::melt(m2)
melt_m2$X1 <- factor(melt_m2$X1, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
melt_m2$X2 <- factor(melt_m2$X2, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))

ppp <- ggplot(melt_m2, aes(x = X1, y = X2, fill = value)) + 
  geom_tile(show.legend = F)+
  geom_text(aes(X1, X2, label = value), color = "gray", size = 2, angle = 0) +
  theme_tufte(base_family="Helvetica")+
  scale_y_discrete(position = "right")+
 theme(axis.ticks = element_blank(),
        plot.title = element_text(face = "bold"),
        panel.background = element_rect(colour = NA, fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.title = element_blank(),
        axis.text = element_text(size = 6, colour = "white"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t=-2.5, b = -2.5)),
        axis.text.y.left = element_text(angle = 0, hjust = 0, vjust = 0.5, margin = margin(l=-2.5, r = -2.5), debug = T))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "gray", 
                       midpoint = 0, limit = c(min(melt_m$value),max(melt_m$value)), space = "Lab", 
                       name="Estimate", na.value = "transparent")

pppp <- p + annotation_custom(ggplotGrob(ppp), xmin = 0.5, xmax = 4, ymin = .6, ymax = 1)
pppp <- pppp + annotation_custom(ggplotGrob(pp), xmin = 0.5, xmax = 4, ymin = 0.6, ymax = 1)
pppp

# figure output ---------------------------------------------------------------
pdf(file = "000_COPRinCOPR120.pdf", width = mywidth, height = myheight); pppp; dev.off()


rm(m, m2, melt_m, melt_m2, my, mymod, mymod1, myres, myres_est, myres_p, mysumm,
   p, pp, ppp, pppp, i, myptsize, myx, myr, myy, myc, avgmod.delta4)
rm(mylowlim, myhighlim, mytitle, myylab, myxlab, myoutline, myfill, myptalpha, myrugalpha, mypalette, mytextsize,
   myheight, mywidth, mymeanptsize, mywtmeanptcol, mywtmeanpttype, myp)
```
<br/><br/>








It is important to look at these data a few different ways, lets zoom in on the rug plot from the treatment effect violin plots above...
PLOT(S): SALT dw rank by barcode in 0.0, 0.4, 0.8, 1.2
```{r}
# Set controls for all plots ---------------------------------------------------
mywidth <- 7
myheight <- 7

# SALT in CM -------------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 0.0 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),] # subset
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # fix treat levels
my <- my[!is.na(my$mn_dw),] # rm NAs
my <- my[order(my$mn_dw),] # sort so the plot looks good
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity") # plot
p # view plot
pdf(file = "000_rank_SALTinCM.pdf", width = mywidth, height = myheight); p; dev.off() # output plot



# SALT in SALT 040 -------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 0.4 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my <- my[!is.na(my$mn_dw),]
my <- my[order(my$mn_dw),]
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity")
p
pdf(file = "000_rank_SALTinSALT040.pdf", width = mywidth, height = myheight); p; dev.off()



# SALT in SALT 080 -------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 0.8 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my <- my[!is.na(my$mn_dw),]
my <- my[order(my$mn_dw),]
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity")
p
pdf(file = "000_rank_SALTinSALT080.pdf", width = mywidth, height = myheight); p; dev.off()



# SALT in SALT 120 -------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("SALT_A", "SALT_B") & mydwc$mpasp == 1.2 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my <- my[!is.na(my$mn_dw),]
my <- my[order(my$mn_dw),]
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity")
p
pdf(file = "000_rank_SALTinSALT120.pdf", width = mywidth, height = myheight); p; dev.off()
```
<br/><br/>



PLOT(S): COPR dw rank by barcode in 0.0, 0.4, 0.8, 1.2
```{r}
# Set controls for all plots ---------------------------------------------------
mywidth <- 7
myheight <- 7

# COPR in CM -------------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 0.0 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),] # subset
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")) # fix treat levels
my <- my[!is.na(my$mn_dw),] # rm NAs
my <- my[order(my$mn_dw),] # sort so the plot looks good
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity") # plot
p # view plot
pdf(file = "000_rank_COPRinCM.pdf", width = mywidth, height = myheight); p; dev.off() # output plot



# COPR in COPR 040 -------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 0.4 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my <- my[!is.na(my$mn_dw),]
my <- my[order(my$mn_dw),]
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity")
p
pdf(file = "000_rank_COPRinCOPR040.pdf", width = mywidth, height = myheight); p; dev.off()



# COPR in COPR 080 -------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 0.8 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my <- my[!is.na(my$mn_dw),]
my <- my[order(my$mn_dw),]
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity")
p
pdf(file = "000_rank_COPRinCOPR080.pdf", width = mywidth, height = myheight); p; dev.off()



# COPR in COPR 120 -------------------------------------------------------------
my <- mydwc[mydwc$epo %in% c("COPR_A", "COPR_B") & mydwc$mpasp == 1.2 & mydwc$treat %in% c("EH0","EH0_40","EH40","EH20_60","EH0_80", "EH40_80", "EH80"),]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my <- my[!is.na(my$mn_dw),]
my <- my[order(my$mn_dw),]
p<-ggplot(data=my, aes(x=reorder(bcpID, -mn_dw), y=mn_dw, fill = treat)) +
  geom_bar (stat="identity")
p
pdf(file = "000_rank_COPRinCOPR120.pdf", width = mywidth, height = myheight); p; dev.off()

# ----------------------------
rm(myheight, mywidth, my, p)
```
<br/><br/>



This is still a lot to take in at one time, maybe looking at some targeted sets will help with interpretation....
SALT data first...
PLOT(S): pairs plots for targetted sets of 3 (and one set with all treats together for context!) 
```{R}
# Set controls for all plots ---------------------------------------------------
mywidth <- 8
myheight <- mywidth

# ALL ------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "ALL")
pdf(file = "000_pairs_SALT_ALL_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()

# specialist vs. generalists: low stress end ---------------
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH0_40"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_40")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: low stress end")
pdf(file = "000_pairs_SALT_EH0_EH40_EH0-40_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()

# specialist vs. generalists: full spectrum ----------------
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH80", "EH0_80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: full spectrum")
pdf(file = "000_pairs_SALT_EH0_EH80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH40", "EH80", "EH40_80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_40", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: high stress end")
pdf(file = "000_pairs_SALT_EH40_EH80_EH40-80_in_040_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialists with different means compared")
pdf(file = "000_pairs_SALT_EH0_EH40_EH80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH0_40", "EH20_60", "EH40_80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "generalists with same flux degree, different means compared")
pdf(file = "000_pairs_SALT_EH0-40_EH20-60_EH40-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH0_80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared minimum with variable degree of flux up")
pdf(file = "000_pairs_SALT_EH0_EH0-40_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH80", "EH40_80", "EH0_80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared maximum with variable degree of flux down")
pdf(file = "000_pairs_SALT_EH80_EH40-80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH40", "EH20_60", "EH0_80"),]
my <- my[my$epo %in% c("SALT_A", "SALT_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared mean with variable degree of flux around mean")
pdf(file = "000_pairs_SALT_EH40_EH20_60_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

# rm -------------------------
rm(myheight, mywidth, my, p)
```
<br/><br/>



COPR data next...
PLOT(S): pairs plots for targetted sets of 3 (and one set with all treats together for context!) 
```{R}
# Set controls for all plots ---------------------------------------------------
mywidth <- 8
myheight <- mywidth

# ALL ------------------------------------------------------
my <- mydwcw[mydwcw$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "ALL")
pdf(file = "000_pairs_COPR_ALL_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()

# specialist vs. generalists: low stress end ---------------
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH0_40"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_40")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: low stress end")
pdf(file = "000_pairs_COPR_EH0_EH40_EH0-40_in_000_&_040.pdf", width = mywidth, height = myheight); p; dev.off()

# specialist vs. generalists: full spectrum ----------------
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH80", "EH0_80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: full spectrum")
pdf(file = "000_pairs_COPR_EH0_EH80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH40", "EH80", "EH40_80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_40", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialist vs. generalists: high stress end")
pdf(file = "000_pairs_COPR_EH40_EH80_EH40-80_in_040_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "specialists with different means compared")
pdf(file = "000_pairs_COPR_EH0_EH40_EH80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH0_40", "EH20_60", "EH40_80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "generalists with same flux degree, different means compared")
pdf(file = "000_pairs_COPR_EH0-40_EH20-60_EH40-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH0_80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared minimum with variable degree of flux up")
pdf(file = "000_pairs_COPR_EH0_EH0-40_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH80", "EH40_80", "EH0_80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared maximum with variable degree of flux down")
pdf(file = "000_pairs_COPR_EH80_EH40-80_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

my <- mydwcw[mydwcw$treat %in% c("EH40", "EH20_60", "EH0_80"),]
my <- my[my$epo %in% c("COPR_A", "COPR_B"),]
my <- my[,c("treat", "mn_dw_0", "mn_dw_80")]
p <- ggpairs(my,aes(color = treat, alpha = 0.7), title = "shared mean with variable degree of flux around mean")
pdf(file = "000_pairs_COPR_EH40_EH20_60_EH0-80_in_000_&_080.pdf", width = mywidth, height = myheight); p; dev.off()

# rm -------------------------
rm(myheight, mywidth, my, p)
```
<br/><br/>



It is possible that a 3-dimensional plot (0.0 vs. 0.4 vs. 0.8 env) will reveal even more interpretable structure...*
      * these blocks are commented because the plots have already been generated, but also because they are not very helpful and will not be used moving forward.
SALT first...
PLOT(S): 3d plots for targetted sets of 3 (and one set with all treats together for context!) 
```{R}
# library(plotly)
# Sys.setenv("plotly_username"="vincefasanello")
# Sys.setenv("plotly_api_key"="oLHyGo5FrZP6CQ96OZM4")
# 
# # all treats -----------------------------------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="All Treatments"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_AllTreats_000_040_080");chart_link
# 
# # specialists vs. generalists ------------------------------
# # eh0, eh0_40, eh40 --------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH0", "EH0_40", "EH40"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialist vs. generalists: low stress end"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH0_EH0-40_EH40_in_000_040_080");chart_link
# 
# # eh40, eh40_80, eh80 ------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH40", "EH40_80", "EH80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialist vs. generalists: high stress end"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH40_EH40-80_EH80_in_000_040_080");chart_link
# 
# # eh0, eh0_80, eh80 --------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),]  
# my <- my[my$treat %in% c("EH0", "EH0_80", "EH80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialist vs. generalists: full spectrum"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH0_EH0-80_EH80_in_000_040_080");chart_link
# 
# 
# # Shared mean, variable flux -------------------------------
# # eh0_40, eh20_60, eh40_80 -------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH40", "EH20_60", "EH0_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="shared mean with variable degree of flux around mean"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH40_EH20-60_EH0-80_in_000_040_080");chart_link
# 
# # Shared min, variable flux -------------------------------
# # eh0, eh0_40, eh0_80 ------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH0", "EH0_40", "EH0_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="shared minimum with variable degree of flux up"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH0_EH0-40_EH0-80_in_000_040_080");chart_link
# 
# # # Shared max, variable flux -------------------------------
# # eh80, e40_80, eh0_80 -----------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH80", "EH40_80", "EH0_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="shared maximum with variable degree of flux down"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH80_EH40-80_EH0-80_in_000_040_080");chart_link
# 
# # variable mean (min, max), shared flux --------------------
# # eh0, eh40, eh80 ----------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH0", "EH40", "EH80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialists with different means compared"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH0_EH40_EH80_in_000_040_080");chart_link
# 
# # eh0_40, eh20_60, eh40_80 -------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("SALT_A", "SALT_B"),] 
# my <- my[my$treat %in% c("EH0_40", "EH20_60", "EH40_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="generalists with same flux degree, different means compared"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_SALT_EH0_40_EH20_60_EH40_80_in_000_040_080");chart_link
# 
# # ----------------------------
# rm(my, p)
```
<br/><br/>



COPR next...
PLOT(S): 3d plots for targetted sets of 3 (and one set with all treats together for context!) 
```{R}
# library(plotly)
# Sys.setenv("plotly_username"="vincefasanello")
# Sys.setenv("plotly_api_key"="oLHyGo5FrZP6CQ96OZM4")
# 
# # all treats -----------------------------------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="All Treatments"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_AllTreats_000_040_080");chart_link
# 
# # specialists vs. generalists ------------------------------
# # eh0, eh0_40, eh40 --------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH0", "EH0_40", "EH40"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialist vs. generalists: low stress end"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH0_EH0-40_EH40_in_000_040_080");chart_link
# 
# # eh40, eh40_80, eh80 ------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH40", "EH40_80", "EH80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialist vs. generalists: high stress end"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH40_EH40-80_EH80_in_000_040_080");chart_link
# 
# # eh0, eh0_80, eh80 --------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),]  
# my <- my[my$treat %in% c("EH0", "EH0_80", "EH80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialist vs. generalists: full spectrum"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH0_EH0-80_EH80_in_000_040_080");chart_link
# 
# 
# # Shared mean, variable flux -------------------------------
# # eh0_40, eh20_60, eh40_80 -------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH40", "EH20_60", "EH0_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="shared mean with variable degree of flux around mean"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH40_EH20-60_EH0-80_in_000_040_080");chart_link
# 
# # Shared min, variable flux -------------------------------
# # eh0, eh0_40, eh0_80 ------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH0", "EH0_40", "EH0_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="shared minimum with variable degree of flux up"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH0_EH0-40_EH0-80_in_000_040_080");chart_link
# 
# # # Shared max, variable flux -------------------------------
# # eh80, e40_80, eh0_80 -----------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH80", "EH40_80", "EH0_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="shared maximum with variable degree of flux down"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH80_EH40-80_EH0-80_in_000_040_080");chart_link
# 
# # variable mean (min, max), shared flux --------------------
# # eh0, eh40, eh80 ----------------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH0", "EH40", "EH80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="specialists with different means compared"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH0_EH40_EH80_in_000_040_080");chart_link
# 
# # eh0_40, eh20_60, eh40_80 -------------
# my <-  mydwcw[!is.na(mydwcw$mn_dw_0) &!is.na(mydwcw$mn_dw_40) &!is.na(mydwcw$mn_dw_80) & mydwcw$epo %in% c("COPR_A", "COPR_B"),] 
# my <- my[my$treat %in% c("EH0_40", "EH20_60", "EH40_80"),]
# p <- plot_ly(my, x = ~mn_dw_0, y = ~mn_dw_40, z = ~mn_dw_80, color = ~treat, colors = dichrompalette_br_cy, type = "scatter3d", mode = "markers") %>%
#   layout(title ="generalists with same flux degree, different means compared"); p
# chart_link = api_create(p, filename="000_FS_scatter3d_COPR_EH0_40_EH20_60_EH40_80_in_000_040_080");chart_link
# 
# # ----------------------------
# rm(my, p)
```
<br/><br/>



ASSESS: FITNESS INCREASE & DECREASE IN 500 GENERATIONS OF EVOLUTION ACROSS 7 TREATMENTS IN 4 ENVIRONMENTS AND 2 CHEMICAL STRESSORS 
Test for fitness increase/decrease for SALT evolved lines in 0.0, 0.4, 0.8, and 1.2 SALT envs. - generate results frames
```{r}
# BLOCK NOTES ------------------------------------------------------------------
#  - Fitness increase data: analyze by groups externally & use in later blocks
#  - Fitness decrease data: analyze by groups externally & use in later blocks
#  - nleft data: use in later blocks
#  - env specific data frames: use in later blocks
# ------------------------------------------------------------------------------

mysig <- 0.05

# SALT RESULTS OUTPUT TABLES ---------------------------------------------------

mySALTin <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant increase
mySALTdec <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant decrease
mySALTno <- matrix(nrow = 7, ncol = 4) # number of barcodes non-extinct
mySALTtot <- matrix(nrow = 7, ncol = 4) # number of barcodes included in the treatment
rownames(mySALTin) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mySALTdec) <- rownames(mySALTin)
rownames(mySALTno) <- rownames(mySALTin)
rownames(mySALTtot) <- rownames(mySALTin)
colnames(mySALTin) <- c(0.0, 0.4, 0.8, 1.2)
colnames(mySALTdec) <- colnames(mySALTin)
colnames(mySALTno) <- colnames(mySALTin)
colnames(mySALTtot) <- colnames(mySALTin)



# SALT in CM -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 0.0,]
x <- table(my$treat)/4; mySALTtot[,c(1:4)] <- x[c(1, 5, 7, 2, 4, 3, 6)]
my <- my[!is.na(my$dw),]

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_000.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_000 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,1] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,1] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,1] <- nrow(tmp)



 # SALT in 40 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),]
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 0.4 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_040.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_040 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,2] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,2] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,2] <- nrow(tmp)



# SALT in 80 -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 0.8 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_080.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_080 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,3] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,3] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,3] <- nrow(tmp)



# SALT in 120 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("SALT_A", "SALT_B") & my$mpasp == 1.2 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "salt_inc_120.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_SALT_120 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];mySALTdec[1,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[1,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[1,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];mySALTdec[2,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[2,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[2,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];mySALTdec[3,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[3,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[3,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];mySALTdec[4,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[4,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[4,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];mySALTdec[5,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[5,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[5,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];mySALTdec[6,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[6,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[6,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];mySALTdec[7,4] <- sum(tmp$p1s_l.adj <= mysig); mySALTin[7,4] <- sum(tmp$p1s_h.adj <= mysig); mySALTno[7,4] <- nrow(tmp)


# ----------------------------
mySALTnleft <- mySALTno; rm(mySALTno)  # give a clearer name. 
mySALText <- mySALTtot - mySALTnleft; rm(mySALTnleft) # now subtract from tot to get n extinct in each treat
mySALTunc <- mySALTtot - (mySALTdec + mySALTin + mySALText)

# ----------------------------
# rm(inc_SALT_000, inc_SALT_040, inc_SALT_080, inc_SALT_120) # uncomment if you want to retain these results. 
rm(my, mymod, myres, tmp, i, mysig)
```
<br/><br/>



Test for fitness increase/decrease for COPR evolved lines in 0.0, 0.4, 0.8, and 1.2 COPR envs. - generate results frames
```{r}
# BLOCK NOTES ------------------------------------------------------------------
#  - Fitness increase data: analyze by groups externally & use in later blocks
#  - Fitness decrease data: analyze by groups externally & use in later blocks
#  - nleft data: use in later blocks
#  - env specific data frames: use in later blocks
# ------------------------------------------------------------------------------

mysig <- 0.05

# COPR RESULTS OUTPUT TABLES ---------------------------------------------------

myCOPRin <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant increase
myCOPRdec <- matrix(nrow = 7, ncol = 4) # number of barcodes with significant decrease
myCOPRno <- matrix(nrow = 7, ncol = 4) # number of barcodes non-extinct
myCOPRtot <- matrix(nrow = 7, ncol = 4) # number of barcodes included in the treatment
rownames(myCOPRin) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(myCOPRdec) <- rownames(myCOPRin)
rownames(myCOPRno) <- rownames(myCOPRin)
rownames(myCOPRtot) <- rownames(myCOPRin)
colnames(myCOPRin) <- c(0.0, 0.4, 0.8, 1.2)
colnames(myCOPRdec) <- colnames(myCOPRin)
colnames(myCOPRno) <- colnames(myCOPRin)
colnames(myCOPRtot) <- colnames(myCOPRin)



# COPR in CM -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.0,]
x <- table(my$treat)/4
x["EH0"] <- 16; x["EH40"] <- 16;  x["EH80"] <- 15
myCOPRtot[,c(1:4)] <- x[c(1, 5, 7, 2, 4, 3, 6)]
my <- my[!is.na(my$dw),]

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_000.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_000 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,1] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,1] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,1] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,1] <- nrow(tmp)



 # COPR in 40 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),]
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.4 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_040.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_040 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,2] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,2] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,2] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,2] <- nrow(tmp)



# COPR in 80 -------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 0.8 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_080.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_080 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,3] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,3] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,3] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,3] <- nrow(tmp)



# COPR in 120 ------------------------------------------------------------------
my <- myd[order(myd$bcpID),] 
my <- my[my$epo %in% c("COPR_A", "COPR_B") & my$mpasp == 1.2 & !is.na(my$dw),] 

# model & diagnostic plots ---------------------------------
mymod <- lm(my$dw ~ my$bcpID + 0, weights = my$re_dw); # summary(mymod)
# hist(residuals(mymod), breaks = 100); hist(expand_residuals(mymod, my$re_dw), breaks = 100); plot(mymod)

# model output ---------------------------------------------
# tab_model(mymod, digits = 5, digits.p = 8, show.stat = T, wrap.labels = 100, file = "copr_inc_120.html") # table does not have corrected p-values. 

# create results dataframe ---------------------------------
myres <- as.data.frame(coef(summary(mymod)), stringsAsFactors = F)
myres$p1s_l <- pt(coef(summary(mymod))[, 3], mymod$df, lower = T) # one-sided test p-values for lower
myres$p1s_h <- pt(coef(summary(mymod))[, 3], mymod$df, lower = F) # one-sided test p-values for higher
myres$p1s_l.adj <- p.adjust(myres$p1s_l, method = "fdr") # fdr adjusted p value (for 1-sided lower)
myres$p1s_h.adj <- p.adjust(myres$p1s_h, method = "fdr") # fdr adjusted p value (for 1-sided higher)
myres$bcid <-  gsub("^.*?D","",rownames(myres)) # fix barcode id names
myres$treat <- NA
for (i in 1:length(myres$treat)) {
  myres$treat[i] <- as.character(my$treat)[my$bcpID == myres$bcid[i]][1]
}
inc_COPR_120 <- myres

# populate mats --------------------------------------------
tmp <- myres[myres$treat == "EH0",];myCOPRdec[1,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[1,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[1,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40",];myCOPRdec[2,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[2,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[2,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH80",];myCOPRdec[3,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[3,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[3,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_40",];myCOPRdec[4,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[4,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[4,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH20_60",];myCOPRdec[5,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[5,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[5,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH0_80",];myCOPRdec[6,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[6,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[6,4] <- nrow(tmp)
tmp <- myres[myres$treat == "EH40_80",];myCOPRdec[7,4] <- sum(tmp$p1s_l.adj <= mysig); myCOPRin[7,4] <- sum(tmp$p1s_h.adj <= mysig); myCOPRno[7,4] <- nrow(tmp)


# ----------------------------
myCOPRnleft <- myCOPRno; rm(myCOPRno)  # give a clearer name. 
myCOPRext <- myCOPRtot - myCOPRnleft; rm(myCOPRnleft) # now subtract from tot to get n extinct in each treat
myCOPRunc <- myCOPRtot - (myCOPRdec + myCOPRin + myCOPRext)

# ----------------------------
# rm(inc_COPR_000, inc_COPR_040, inc_COPR_080, inc_COPR_120) # uncomment if you want to retain these results. 
rm(my, mymod, myres, tmp, i, mysig)
```
<br/><br/>


Create a dataframe that will utilize all of the increase / decrease p-values 
```{R}
my <- mydwcw
my$in0 <- NA
my$in40 <- NA
my$in80 <- NA
my$in120 <- NA
my$dec0 <- NA
my$dec40 <- NA
my$dec80 <- NA
my$dec120 <- NA

for (i in 1:nrow(my)) {
  # SALT data first
  if(my[i, "epo"] %in% c("SALT_A", "SALT_B")){
    # store values
    # increase by env
    x <- inc_SALT_000$p1s_h[inc_SALT_000$bcid == my[i, "bcpID"]]
    y <- inc_SALT_040$p1s_h[inc_SALT_040$bcid == my[i, "bcpID"]]
    z <- inc_SALT_080$p1s_h[inc_SALT_080$bcid == my[i, "bcpID"]]
    a <- inc_SALT_120$p1s_h[inc_SALT_120$bcid == my[i, "bcpID"]]
    
    # decrease by env
    b <- inc_SALT_000$p1s_l[inc_SALT_000$bcid == my[i, "bcpID"]]
    c <- inc_SALT_040$p1s_l[inc_SALT_040$bcid == my[i, "bcpID"]]
    d <- inc_SALT_080$p1s_l[inc_SALT_080$bcid == my[i, "bcpID"]]
    e <- inc_SALT_120$p1s_l[inc_SALT_120$bcid == my[i, "bcpID"]]    
    
    #assignment
    # increase by env
    if(length(x) > 0){my[i, "in0"] <- x}
    if(length(y) > 0){my[i, "in40"] <- y}
    if(length(z) > 0){my[i, "in80"] <- z}
    if(length(a) > 0){my[i, "in120"] <- a}
    
    # decrease by env
    if(length(b) > 0){my[i, "dec0"] <- b}
    if(length(c) > 0){my[i, "dec40"] <- c}
    if(length(d) > 0){my[i, "dec80"] <- d}
    if(length(e) > 0){my[i, "dec120"] <- e}
  }
  
  # repeat for COPR data
  if(my[i, "epo"] %in% c("COPR_A", "COPR_B")){
    x <- inc_COPR_000$p1s_h[inc_COPR_000$bcid == my[i, "bcpID"]]
    y <- inc_COPR_040$p1s_h[inc_COPR_040$bcid == my[i, "bcpID"]]
    z <- inc_COPR_080$p1s_h[inc_COPR_080$bcid == my[i, "bcpID"]]
    a <- inc_COPR_120$p1s_h[inc_COPR_120$bcid == my[i, "bcpID"]]
    
    b <- inc_COPR_000$p1s_l[inc_COPR_000$bcid == my[i, "bcpID"]]
    c <- inc_COPR_040$p1s_l[inc_COPR_040$bcid == my[i, "bcpID"]]
    d <- inc_COPR_080$p1s_l[inc_COPR_080$bcid == my[i, "bcpID"]]
    e <- inc_COPR_120$p1s_l[inc_COPR_120$bcid == my[i, "bcpID"]]    
    
    
    if(length(x) > 0){my[i, "in0"] <- x}
    if(length(y) > 0){my[i, "in40"] <- y}
    if(length(z) > 0){my[i, "in80"] <- z}
    if(length(a) > 0){my[i, "in120"] <- a}
    
    if(length(b) > 0){my[i, "dec0"] <- b}
    if(length(c) > 0){my[i, "dec40"] <- c}
    if(length(d) > 0){my[i, "dec80"] <- d}
    if(length(e) > 0){my[i, "dec120"] <- e}
  }
}
mydwcw <- my
```
<br/><br/>

Code blocks below in order: Inc calc & table, Inc fig, Dec calc & table, Dec fig. COPR blocks follow SALT blocks. 

SALT ---------------------------------------------------------------------------
Create summary tables:
Set 1: 0, 0_40, 40
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH40") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40),]
my <- my[!is.na(my$in0) & !is.na(my$in40),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
             nrow(mynot[mynot$treat == "EH0_40",]),
             nrow(mynot[mynot$treat == "EH40",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
             mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
             mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",])); names(div_ext) <- c("EH0", "EH0_40", "EH40")
div_tot <- mySALTtot[c("EH0", "EH0_40", "EH40"),1]


# how many increase in both environments
x <- my[my$in0 <= 0.05 & my$in40 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH0_40", "EH40")]

# how many increase in the .00 but not .80 env
x <- my[my$in0 <= 0.05 & my$in40 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH0_40", "EH40")]

# how many increase in the .80 but not .00 env
x <- my[my$in0 > 0.05 & my$in40 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH0_40", "EH40")]

# how many increase in neither the .80 nor .00 env
x <- my[my$in0 > 0.05 & my$in40 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH0_40", "EH40")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH0_40", "EH40")
rownames(mymat) <- c("in_both", "in_0", "in_40", "in_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table2_SALT_s_g_ls_inc_raw.csv")
write.csv(mymat2, file = "table2_SALT_s_g_ls_inc_divtot.csv")
write.csv(mymat3, file = "table2_SALT_s_g_ls_inc_divext.csv")
```

```{R}
mywidth <- 7
myheight <- 7

my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05] <- "Both"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05] <- "Low Only"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05] <- "High Only"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_lowset_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))

```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH40") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
             nrow(mynot[mynot$treat == "EH0_40",]),
             nrow(mynot[mynot$treat == "EH40",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
             mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
             mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",])); names(div_ext) <- c("EH0", "EH0_40", "EH40")
div_tot <- mySALTtot[c("EH0", "EH0_40", "EH40"),1]


# how many increase in both environments
x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH0_40", "EH40")]

# how many increase in the .00 but not .80 env
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH0_40", "EH40")]

# how many increase in the .80 but not .00 env
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH0_40", "EH40")]

# how many increase in neither the .80 nor .00 env
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH0_40", "EH40")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH0_40", "EH40")
rownames(mymat) <- c("dec_both", "dec_0", "dec_40", "dec_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table2_SALT_s_g_ls_dec_raw.csv")
write.csv(mymat2, file = "table2_SALT_s_g_ls_dec_divtot.csv")
write.csv(mymat3, file = "table2_SALT_s_g_ls_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05] <- "Both"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05] <- "Low Only"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05] <- "High Only"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_lowset_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



Set 2: 40, 40_80, 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH40", "EH40_80", "EH80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in40) | is.na(my$in80),]
my <- my[!is.na(my$in40) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH40",]),
             nrow(mynot[mynot$treat == "EH40_80",]),
             nrow(mynot[mynot$treat == "EH80",]))
div_ext <- cbind(mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
             mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",]),
             mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",])); names(div_ext) <- c("EH40", "EH40_80", "EH80")
div_tot <- mySALTtot[c("EH40", "EH40_80", "EH80"),1]


# how many increase in both environments
x <- my[my$in40 <= 0.05 & my$in80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH40", "EH40_80", "EH80")]

# how many increase in the .40 but not .80 env
x <- my[my$in40 <= 0.05 & my$in80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH40", "EH40_80", "EH80")]

# how many increase in the .80 but not .40 env
x <- my[my$in40 > 0.05 & my$in80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH40", "EH40_80", "EH80")]

# how many increase in neither the .80 nor .40 env
x <- my[my$in40 > 0.05 & my$in80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH40", "EH40_80", "EH80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH40", "EH40_80", "EH80")
rownames(mymat) <- c("in_both", "in_40", "in_80", "in_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table3_SALT_s_g_hs_inc_raw.csv")
write.csv(mymat2, file = "table3_SALT_s_g_hs_inc_divtot.csv")
write.csv(mymat3, file = "table3_SALT_s_g_hs_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in40 <= 0.05 & my$in80 <= 0.05] <- "Both"
my$Environment[my$in40 <= 0.05 & my$in80 > 0.05] <- "Low Only"
my$Environment[my$in40 > 0.05 & my$in80 <= 0.05] <- "High Only"
my$Environment[my$in40 > 0.05 & my$in80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_highset_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH40", "EH40_80", "EH80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec40) | is.na(my$dec80),]
my <- my[!is.na(my$dec40) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH40",]),
             nrow(mynot[mynot$treat == "EH40_80",]),
             nrow(mynot[mynot$treat == "EH80",]))
div_ext <- cbind(mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
             mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",]),
             mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",])); names(div_ext) <- c("EH40", "EH40_80", "EH80")
div_tot <- mySALTtot[c("EH40", "EH40_80", "EH80"),1]


# how many increase in both environments
x <- my[my$dec40 <= 0.05 & my$dec80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH40", "EH40_80", "EH80")]

# how many increase in the .40 but not .80 env
x <- my[my$dec40 <= 0.05 & my$dec80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH40", "EH40_80", "EH80")]

# how many increase in the .80 but not .40 env
x <- my[my$dec40 > 0.05 & my$dec80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH40", "EH40_80", "EH80")]

# how many increase in neither the .80 nor .40 env
x <- my[my$dec40 > 0.05 & my$dec80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH40", "EH40_80", "EH80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH40", "EH40_80", "EH80")
rownames(mymat) <- c("dec_both", "dec_40", "dec_80", "dec_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table3_SALT_s_g_hs_dec_raw.csv")
write.csv(mymat2, file = "table3_SALT_s_g_hs_dec_divtot.csv")
write.csv(mymat3, file = "table3_SALT_s_g_hs_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "Both"
my$Environment[my$dec40 <= 0.05 & my$dec80 > 0.05] <- "Low Only"
my$Environment[my$dec40 > 0.05 & my$dec80 <= 0.05] <- "High Only"
my$Environment[my$dec40 > 0.05 & my$dec80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_highset_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- all treatments in 00 and 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$in0 <= 0.05 & my$in80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$in0 <= 0.05 & my$in80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$in0 > 0.05 & my$in80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$in0 > 0.05 & my$in80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("in_both", "in_0", "in_80", "in_neither", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_SALT_at_00s80s_inc_raw.csv")
write.csv(mymat2, file = "table4_SALT_at_00s80s_inc_divtot.csv")
write.csv(mymat3, file = "table4_SALT_at_00s80s_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in0 <= 0.05 & my$in80 <= 0.05] <- "Both"
my$Environment[my$in0 <= 0.05 & my$in80 > 0.05] <- "No Stress Only"
my$Environment[my$in0 > 0.05 & my$in80 <= 0.05] <- "High Stress Only"
my$Environment[my$in0 > 0.05 & my$in80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Stress Only", "No Stress Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
mypal <- c(rgb(212/255, 175/255, 55/255, 1), rgb(139/255, 0/255, 0/255, 0.85), rgb(235/255, 150/255, 5/255, 0.85), "gray")
pdf(file = "000_stackedbar_SALT_alltreat_00_80_inc.pdf", width = mywidth, height = myheight)
p <- ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_manual(values = mypal, drop = F)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
p
rm(p)
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$dec0 <= 0.05 & my$dec80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$dec0 <= 0.05 & my$dec80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$dec0 > 0.05 & my$dec80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$dec0 > 0.05 & my$dec80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("dec_both", "dec_0", "dec_80", "dec_none", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_SALT_at_00s80s_dec_raw.csv")
write.csv(mymat2, file = "table4_SALT_at_00s80s_dec_divtot.csv")
write.csv(mymat3, file = "table4_SALT_at_00s80s_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec0 <= 0.05 & my$dec80 <= 0.05] <- "Both"
my$Environment[my$dec0 <= 0.05 & my$dec80 > 0.05] <- "No Stress Only"
my$Environment[my$dec0 > 0.05 & my$dec80 <= 0.05] <- "High Stress Only"
my$Environment[my$dec0 > 0.05 & my$dec80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Stress Only", "No Stress Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
mypal <- c(rgb(127/255, 255/255, 212/255, 1), rgb(2/255, 16/255, 146/255, 0.65), rgb(112/255, 130/255, 56/255, 0.85), "gray")
pdf(file = "000_stackedbar_SALT_alltreat_00_80_dec.pdf", width = mywidth, height = myheight)
p <- ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_manual(values = mypal, drop = F)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
p
rm(p)
```
<br/><br/>



ALL -- All treatments in 00, 40, 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_SALT_at_004080_inc_raw.csv")
write.csv(mymat2, file = "table6_SALT_at_004080_inc_divtot.csv")
write.csv(mymat3, file = "table6_SALT_at_004080_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "000"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "100"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "010"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "001"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "110"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "101"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "011"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_SALT_at_004080_dec_raw.csv")
write.csv(mymat2, file = "table6_SALT_at_004080_dec_divtot.csv")
write.csv(mymat3, file = "table6_SALT_at_004080_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "000"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "100"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "010"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "001"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "110"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "101"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "011"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- All treatments in all four environments
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80) | is.na(my$in120),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80) & !is.na(my$in120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_SALT_at_allenv_inc_raw.csv")
write.csv(mymat2, file = "table5_SALT_at_allenv_inc_divtot.csv")
write.csv(mymat3, file = "table5_SALT_at_allenv_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_120_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("SALT_A", "SALT_B"),]
my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80) | is.na(my$dec120),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80) & !is.na(my$dec120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(mySALTtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 mySALTtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 mySALTtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 mySALTtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 mySALTtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 mySALTtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 mySALTtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- mySALTtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_SALT_at_allenv_dec_raw.csv")
write.csv(mymat2, file = "table5_SALT_at_allenv_dec_divtot.csv")
write.csv(mymat3, file = "table5_SALT_at_allenv_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_SALT_alltreat_00_40_80_120_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>






COPR ---------------------------------------------------------------------------
Create summary tables:
Set 1: 0, 0_40, 40
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH40") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40),]
my <- my[!is.na(my$in0) & !is.na(my$in40),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
             nrow(mynot[mynot$treat == "EH0_40",]),
             nrow(mynot[mynot$treat == "EH40",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
             myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
             myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",])); names(div_ext) <- c("EH0", "EH0_40", "EH40")
div_tot <- myCOPRtot[c("EH0", "EH0_40", "EH40"),1]


# how many increase in both environments
x <- my[my$in0 <= 0.05 & my$in40 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH0_40", "EH40")]

# how many increase in the .00 but not .80 env
x <- my[my$in0 <= 0.05 & my$in40 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH0_40", "EH40")]

# how many increase in the .80 but not .00 env
x <- my[my$in0 > 0.05 & my$in40 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH0_40", "EH40")]

# how many increase in neither the .80 nor .00 env
x <- my[my$in0 > 0.05 & my$in40 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH0_40", "EH40")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH0_40", "EH40")
rownames(mymat) <- c("in_both", "in_0", "in_40", "in_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table2_COPR_s_g_ls_inc_raw.csv")
write.csv(mymat2, file = "table2_COPR_s_g_ls_inc_divtot.csv")
write.csv(mymat3, file = "table2_COPR_s_g_ls_inc_divext.csv")
```

```{R}
mywidth <- 7
myheight <- 7

my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05] <- "Both"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05] <- "Low Only"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05] <- "High Only"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_lowset_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))

```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH0_40", "EH40") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
             nrow(mynot[mynot$treat == "EH0_40",]),
             nrow(mynot[mynot$treat == "EH40",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
             myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
             myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",])); names(div_ext) <- c("EH0", "EH0_40", "EH40")
div_tot <- myCOPRtot[c("EH0", "EH0_40", "EH40"),1]


# how many increase in both environments
x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH0_40", "EH40")]

# how many increase in the .00 but not .80 env
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH0_40", "EH40")]

# how many increase in the .80 but not .00 env
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH0_40", "EH40")]

# how many increase in neither the .80 nor .00 env
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH0_40", "EH40")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH0_40", "EH40")
rownames(mymat) <- c("dec_both", "dec_0", "dec_40", "dec_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table2_COPR_s_g_ls_dec_raw.csv")
write.csv(mymat2, file = "table2_COPR_s_g_ls_dec_divtot.csv")
write.csv(mymat3, file = "table2_COPR_s_g_ls_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05] <- "Both"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05] <- "Low Only"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05] <- "High Only"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_lowset_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



Set 2: 40, 40_80, 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH40", "EH40_80", "EH80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in40) | is.na(my$in80),]
my <- my[!is.na(my$in40) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH40",]),
             nrow(mynot[mynot$treat == "EH40_80",]),
             nrow(mynot[mynot$treat == "EH80",]))
div_ext <- cbind(myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
             myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",]),
             myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",])); names(div_ext) <- c("EH40", "EH40_80", "EH80")
div_tot <- myCOPRtot[c("EH40", "EH40_80", "EH80"),1]


# how many increase in both environments
x <- my[my$in40 <= 0.05 & my$in80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH40", "EH40_80", "EH80")]

# how many increase in the .40 but not .80 env
x <- my[my$in40 <= 0.05 & my$in80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH40", "EH40_80", "EH80")]

# how many increase in the .80 but not .40 env
x <- my[my$in40 > 0.05 & my$in80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH40", "EH40_80", "EH80")]

# how many increase in neither the .80 nor .40 env
x <- my[my$in40 > 0.05 & my$in80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH40", "EH40_80", "EH80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH40", "EH40_80", "EH80")
rownames(mymat) <- c("in_both", "in_40", "in_80", "in_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table3_COPR_s_g_hs_inc_raw.csv")
write.csv(mymat2, file = "table3_COPR_s_g_hs_inc_divtot.csv")
write.csv(mymat3, file = "table3_COPR_s_g_hs_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in40 <= 0.05 & my$in80 <= 0.05] <- "Both"
my$Environment[my$in40 <= 0.05 & my$in80 > 0.05] <- "Low Only"
my$Environment[my$in40 > 0.05 & my$in80 <= 0.05] <- "High Only"
my$Environment[my$in40 > 0.05 & my$in80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_highset_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH40", "EH40_80", "EH80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec40) | is.na(my$dec80),]
my <- my[!is.na(my$dec40) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH40",]),
             nrow(mynot[mynot$treat == "EH40_80",]),
             nrow(mynot[mynot$treat == "EH80",]))
div_ext <- cbind(myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
             myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",]),
             myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",])); names(div_ext) <- c("EH40", "EH40_80", "EH80")
div_tot <- myCOPRtot[c("EH40", "EH40_80", "EH80"),1]


# how many increase in both environments
x <- my[my$dec40 <= 0.05 & my$dec80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH40", "EH40_80", "EH80")]

# how many increase in the .40 but not .80 env
x <- my[my$dec40 <= 0.05 & my$dec80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH40", "EH40_80", "EH80")]

# how many increase in the .80 but not .40 env
x <- my[my$dec40 > 0.05 & my$dec80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH40", "EH40_80", "EH80")]

# how many increase in neither the .80 nor .40 env
x <- my[my$dec40 > 0.05 & my$dec80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH40", "EH40_80", "EH80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH40", "EH40_80", "EH80")
rownames(mymat) <- c("dec_both", "dec_40", "dec_80", "dec_neither", "n_extinct", "n_tot")
mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); mymat3

write.csv(mymat,  file = "table3_COPR_s_g_hs_dec_raw.csv")
write.csv(mymat2, file = "table3_COPR_s_g_hs_dec_divtot.csv")
write.csv(mymat3, file = "table3_COPR_s_g_hs_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "Both"
my$Environment[my$dec40 <= 0.05 & my$dec80 > 0.05] <- "Low Only"
my$Environment[my$dec40 > 0.05 & my$dec80 <= 0.05] <- "High Only"
my$Environment[my$dec40 > 0.05 & my$dec80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_highset_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- all treatments in 00 and 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$in0 <= 0.05 & my$in80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$in0 <= 0.05 & my$in80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$in0 > 0.05 & my$in80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$in0 > 0.05 & my$in80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("in_both", "in_0", "in_80", "in_neither", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_COPR_at_00s80s_inc_raw.csv")
write.csv(mymat2, file = "table4_COPR_at_00s80s_inc_divtot.csv")
write.csv(mymat3, file = "table4_COPR_at_00s80s_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$in0 <= 0.05 & my$in80 <= 0.05] <- "Both"
my$Environment[my$in0 <= 0.05 & my$in80 > 0.05] <- "Low Only"
my$Environment[my$in0 > 0.05 & my$in80 <= 0.05] <- "High Only"
my$Environment[my$in0 > 0.05 & my$in80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_80_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]


# how many increase in both environments
x <- my[my$dec0 <= 0.05 & my$dec80 <= 0.05,]
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .0 but not .80 env
x <- my[my$dec0 <= 0.05 & my$dec80 > 0.05,]
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in the .80 but not .0 env
x <- my[my$dec0 > 0.05 & my$dec80 <= 0.05,]
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

# how many increase in neither the .80 nor .0 env
x <- my[my$dec0 > 0.05 & my$dec80 > 0.05,]
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("dec_both", "dec_0", "dec_80", "dec_none", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table4_COPR_at_00s80s_dec_raw.csv")
write.csv(mymat2, file = "table4_COPR_at_00s80s_dec_divtot.csv")
write.csv(mymat3, file = "table4_COPR_at_00s80s_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "neither"
my$Environment[my$dec0 <= 0.05 & my$dec80 <= 0.05] <- "Both"
my$Environment[my$dec0 <= 0.05 & my$dec80 > 0.05] <- "Low Only"
my$Environment[my$dec0 > 0.05 & my$dec80 <= 0.05] <- "High Only"
my$Environment[my$dec0 > 0.05 & my$dec80 > 0.05] <- "Neither"
my$Environment <-  factor(my$Environment, levels = c("Both", "High Only", "Low Only", "Neither"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_80_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- All treatments in 00, 40, 80
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_COPR_at_004080_inc_raw.csv")
write.csv(mymat2, file = "table6_COPR_at_004080_inc_divtot.csv")
write.csv(mymat3, file = "table6_COPR_at_004080_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "000"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05] <- "100"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "010"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "001"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05] <- "110"
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05] <- "101"
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "011"
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 000
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05,] # 100
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 010
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 001
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05,] # 110
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05,] # 101
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 011
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05,] # 111
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("000","100","010","001","110","101","011","111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table6_COPR_at_004080_dec_raw.csv")
write.csv(mymat2, file = "table6_COPR_at_004080_dec_divtot.csv")
write.csv(mymat3, file = "table6_COPR_at_004080_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "000"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05] <- "100"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "010"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "001"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05] <- "110"
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05] <- "101"
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "011"
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05] <- "111"
my$Environment <-  factor(my$Environment, levels = c("111", "011", "101", "110", "001", "010", "100", "000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>



ALL -- All treatments in all four environments
```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$in0) | is.na(my$in40) | is.na(my$in80) | is.na(my$in120),]
my <- my[!is.na(my$in0) & !is.na(my$in40) & !is.na(my$in80) & !is.na(my$in120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_COPR_at_allenv_inc_raw.csv")
write.csv(mymat2, file = "table5_COPR_at_allenv_inc_divtot.csv")
write.csv(mymat3, file = "table5_COPR_at_allenv_inc_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$in0 > 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 > 0.05 & my$in120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$in0 <= 0.05 & my$in40 > 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$in0 > 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$in0 <= 0.05 & my$in40 <= 0.05 & my$in80 <= 0.05 & my$in120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_120_inc.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```

```{R}
my <- mydwcw[mydwcw$treat %in% c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80") & mydwcw$epo %in% c("COPR_A", "COPR_B"),]

my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]

my$treat <- drop.levels(my$treat)
mynot <- my[is.na(my$dec0) | is.na(my$dec40) | is.na(my$dec80) | is.na(my$dec120),]
my <- my[!is.na(my$dec0) & !is.na(my$dec40) & !is.na(my$dec80) & !is.na(my$dec120),]
ext <- c(nrow(mynot[mynot$treat == "EH0",]),
         nrow(mynot[mynot$treat == "EH40",]),
         nrow(mynot[mynot$treat == "EH80",]),
         nrow(mynot[mynot$treat == "EH0_40",]),
         nrow(mynot[mynot$treat == "EH20_60",]),
         nrow(mynot[mynot$treat == "EH0_80",]),
         nrow(mynot[mynot$treat == "EH40_80",]))
div_ext <- cbind(myCOPRtot["EH0",1] - nrow(mynot[mynot$treat == "EH0",]),
                 myCOPRtot["EH40",1] - nrow(mynot[mynot$treat == "EH40",]),
                 myCOPRtot["EH80",1] - nrow(mynot[mynot$treat == "EH80",]),
                 myCOPRtot["EH0_40",1] - nrow(mynot[mynot$treat == "EH0_40",]),
                 myCOPRtot["EH20_60",1] - nrow(mynot[mynot$treat == "EH20_60",]),
                 myCOPRtot["EH0_80",1] - nrow(mynot[mynot$treat == "EH0_80",]),
                 myCOPRtot["EH40_80",1] - nrow(mynot[mynot$treat == "EH40_80",])); names(div_ext) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
div_tot <- myCOPRtot[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80"),1]

x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0000 # in none
r1 <- round(summary(x$treat), digits = 3); r1 <- r1[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
 
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1000 # in 0 only
r2 <- round(summary(x$treat), digits = 3); r2 <- r2[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 0100 # in 40 only
r3 <- round(summary(x$treat), digits = 3); r3 <- r3[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0010 # in 80 only
r4 <- round(summary(x$treat), digits = 3); r4 <- r4[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0001 # in 120 only
r5 <- round(summary(x$treat), digits = 3); r5 <- r5[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05,] # 1100 # 0 and 40
r6 <- round(summary(x$treat), digits = 3); r6 <- r6[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1010 # 0 and 80
r7 <- round(summary(x$treat), digits = 3); r7 <- r7[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1001 # 0 and 120
r8 <- round(summary(x$treat), digits = 3); r8 <- r8[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 0101 # 40 and 120
r9 <- round(summary(x$treat), digits = 3); r9 <- r9[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 0110 # 40 and 80
r10 <- round(summary(x$treat), digits = 3); r10 <- r10[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0011 # 80 and 120
r11 <- round(summary(x$treat), digits = 3); r11 <- r11[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05,] # 1110 # 0, 40, 80
r12 <- round(summary(x$treat), digits = 3); r12 <- r12[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05,] # 1101 # 0, 40, 120
r13 <- round(summary(x$treat), digits = 3); r13 <- r13[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1011 # 0, 80, 120
r14 <- round(summary(x$treat), digits = 3); r14 <- r14[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]
x <- my[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 0111 # 40, 80, 120
r15 <- round(summary(x$treat), digits = 3); r15 <- r15[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]

x <- my[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05,] # 1111 # all
r16 <- round(summary(x$treat), digits = 3); r16 <- r16[c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")]


mymat <- rbind(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, ext, div_tot)
colnames(mymat) <- c("EH0", "EH40", "EH80", "EH0_40", "EH20_60", "EH0_80", "EH40_80")
rownames(mymat) <- c("0000", "1000", "0100", "0010", "0001", "1100", "1010", "1001", "0101", "0110", "0011", "1110", "1101", "1011", "0111", "1111", "n_extinct", "n_tot")
# mymat

mymat2 <- mymat
mymat2[1,] <- mymat2[1,] / div_tot; mymat2[2,] <- mymat2[2,] / div_tot; mymat2[3,] <- mymat2[3,] / div_tot; mymat2[4,] <- mymat2[4,] / div_tot; mymat2[5,] <- mymat2[5,] / div_tot
mymat2[6,] <- mymat2[6,] / div_tot; mymat2[7,] <- mymat2[7,] / div_tot; mymat2[8,] <- mymat2[8,] / div_tot; mymat2[9,] <- mymat2[9,] / div_tot; mymat2[10,] <- mymat2[10,] / div_tot;
mymat2[11,] <- mymat2[11,] / div_tot; mymat2[12,] <- mymat2[12,] / div_tot; mymat2[13,] <- mymat2[13,] / div_tot; mymat2[14,] <- mymat2[14,] / div_tot; mymat2[15,] <- mymat2[15,] / div_tot; mymat2[16,] <- mymat2[16,] / div_tot; mymat2[17,] <- mymat2[17,] / div_tot;
mymat2 <- round(mymat2, 3); # mymat2

mymat3 <- mymat
mymat3[1,] <- mymat3[1,] / div_ext; mymat3[2,] <- mymat3[2,] / div_ext; mymat3[3,] <- mymat3[3,] / div_ext; mymat3[4,] <- mymat3[4,] / div_ext; mymat3[5,] <- mymat3[5,] / div_ext
mymat3[6,] <- mymat3[6,] / div_ext; mymat3[7,] <- mymat3[7,] / div_ext; mymat3[8,] <- mymat3[8,] / div_ext; mymat3[9,] <- mymat3[9,] / div_ext; mymat3[10,] <- mymat3[10,] / div_ext;
mymat3[11,] <- mymat3[11,] / div_ext; mymat3[12,] <- mymat3[12,] / div_ext; mymat3[13,] <- mymat3[13,] / div_ext; mymat3[14,] <- mymat3[14,] / div_ext; mymat3[15,] <- mymat3[15,] / div_ext; mymat3[16,] <- mymat3[16,] / div_ext;
mymat3 <- round(mymat3, 3); # mymat3


mymat <- mymat[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat
mymat2 <- mymat2[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat2
mymat3 <- mymat3[,c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80")];mymat3

write.csv(mymat,  file = "table5_COPR_at_allenv_dec_raw.csv")
write.csv(mymat2, file = "table5_COPR_at_allenv_dec_divtot.csv")
write.csv(mymat3, file = "table5_COPR_at_allenv_dec_divext.csv")
```

```{R}
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
my$Environment <- "None"
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0000" # 0000 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1000" # 1000 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "0100" # 0100 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0010" # 0010 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0001" # 0001 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 > 0.05] <- "1100" # 1100 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1010" # 1010 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1001" # 1001 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "0101" # 0101 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "0110" # 0110 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0011" # 0011 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 > 0.05] <- "1110" # 1110 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 > 0.05 & my$dec120 <= 0.05] <- "1101" # 1101 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 > 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1011" # 1011 # in none
my$Environment[my$dec0 > 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "0111" # 0111 # in none
my$Environment[my$dec0 <= 0.05 & my$dec40 <= 0.05 & my$dec80 <= 0.05 & my$dec120 <= 0.05] <- "1111" # 1111 # in none
my$Environment <-  factor(my$Environment, levels = c("1111", "0111", "1011", "1101", "1110", "0011", "0110", "0101",
                                                     "1001", "1010", "1100", "0001", "0010", "0100", "1000", "0000"))

# code modified from: https://stackoverflow.com/questions/37817809/r-ggplot-stacked-bar-chart-with-counts-on-y-axis-but-percentage-as-label
pdf(file = "000_stackedbar_COPR_alltreat_00_40_80_120_dec.pdf", width = mywidth, height = myheight)
ggplot(my %>% group_by(treat) %>% count(treat, Environment) %>% mutate(pct=n/sum(n)),
       aes(treat, n, fill=Environment)) +
  geom_bar(stat="identity") +
  ylab("Count")+ xlab("Treatment")+  scale_y_continuous(breaks = seq(0, 32, by = 2), limits = c(0, 32))+
  scale_fill_discrete(drop=FALSE)+
  theme_classic()+
  geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5))
```
<br/><br/>




Explore the welldata dataset
```{R}
my <- welldata
my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE; my$omit[my$bc1 == ""]
my <- my[my$omit == FALSE,]
my$treat <- factor(my$treat, levels = c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"))
tapply(my$ps, my$treat, summary)


# SALT -------------------------------------------------------------------------
# 00 -----------------------------------
my <- welldata[welldata$epo %in% c("SALT_A", "SALT_B") & welldata$mpasp == 0.0,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_SALT_00.csv")

# 40 -----------------------------------
my <- welldata[welldata$epo %in% c("SALT_A", "SALT_B") & welldata$mpasp == 0.4,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_SALT_40.csv")

# 80 -----------------------------------
my <- welldata[welldata$epo %in% c("SALT_A", "SALT_B") & welldata$mpasp == 0.8,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_SALT_80.csv")

# 120 -----------------------------------
my <- welldata[welldata$epo %in% c("SALT_A", "SALT_B") & welldata$mpasp == 1.2,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_SALT_120.csv")



# COPR -------------------------------------------------------------------------
# 00 -----------------------------------
my <- welldata[welldata$epo %in% c("COPR_A", "COPR_B") & welldata$mpasp == 0.0,]
my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_COPR_00.csv")

# 40 -----------------------------------
my <- welldata[welldata$epo %in% c("COPR_A", "COPR_B") & welldata$mpasp == 0.4,]
my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_COPR_40.csv")

# 80 -----------------------------------
my <- welldata[welldata$epo %in% c("COPR_A", "COPR_B") & welldata$mpasp == 0.8,]
my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_COPR_80.csv")

# 120 -----------------------------------
my <- welldata[welldata$epo %in% c("COPR_A", "COPR_B") & welldata$mpasp == 1.2,]
my$omit <- FALSE
my$omit[my$epo == "COPR_B" & my$treat %in% c("EH0", "EH40", "EH80")] <- TRUE
my <- my[my$omit == FALSE,]
x <- tapply(my$ps, my$treat, summary)
y <- matrix(nrow = 7, ncol = 6); rownames(y) <- c("EH0", "EH0_40", "EH40", "EH20_60", "EH0_80", "EH40_80", "EH80"); colnames(y) <- c("II","ID","DD","IX","DX","XX")
y[1,] <- x$EH0; y[2,] <- x$EH0_40; y[3,] <- x$EH40; y[4,] <- x$EH20_60; y[5,] <- x$EH0_80; y[6,] <- x$EH40_80; y[7,] <- x$EH80; y
write.csv(y, file = "000_welldata_COPR_120.csv")

rm(my, x, y)
```
<br/><br/>


















































# Take a look at extinction across environments without any stats tests.*, **
      * We will look at this in more depth in the longitudinal data (either as extinciton or fixation)
      ** slight variation in n bcs extinct in the different environments comes from the fact that some bcs (that already have v.low counts) are extirpated during the fit assay in some environments but not in others. 
```{R}
# # SALT first -------------------------------------------------------------------
# my <- mySALText
# myres <- matrix(nrow = 7, ncol = 3); rownames(myres) <- rownames(my) # create res dataframe 
# colnames(myres) <- c("mean", "se", "mean.prop")
# myres[,1] <- apply(my, 1, mean) # calculate treat means
# myres[,2] <- apply(my, 1, sjstats::se) # calculate treatment ses
# myres[,3] <- myres[,1] / mySALTtot[,1] # report treatment means as proportions as well
# SALT_ext_res_summary <- myres # store in informative frame.
# 
# # COPR -------------------------------------------------------------------------
# my <- mySALText
# myres <- matrix(nrow = 7, ncol = 3); rownames(myres) <- rownames(my)
# colnames(myres) <- c("mean", "se", "mean.prop")
# myres[,1] <- apply(my, 1, mean)
# myres[,2] <- apply(my, 1, sjstats::se)
# myres[,3] <- myres[,1] / mySALTtot[,1]
# SALT_ext_res_summary <- myres
```
<br/><br/>


Create an increase table that is increasers out of the number remaining rather than out of total. 
```{R}
# # SALT first -------------------------------------------------------------------
# mySALTin_prop <- mySALTin/mySALTtot; mySALTin_prop <- round(mySALTin_prop, digits = 2)
# mySALTin_prop_le <- mySALTin / (mySALTtot - mySALText);  mySALTin_prop_le <- round(mySALTin_prop_le, digits = 2)
# 
# myCOPRin_prop <- myCOPRin/myCOPRtot; myCOPRin_prop <- round(myCOPRin_prop, digits = 2)
# myCOPRin_prop_le <- myCOPRin / (myCOPRtot - myCOPRext);  myCOPRin_prop_le <- round(myCOPRin_prop_le, digits = 2)
# 
# mySALTdec_prop <- mySALTdec/mySALTtot; mySALTdec_prop <- round(mySALTdec_prop, digits = 2)
# mySALTdec_prop_le <- mySALTdec / (mySALTtot - mySALText);  mySALTdec_prop_le <- round(mySALTdec_prop_le, digits = 2)
# 
# myCOPRdec_prop <- myCOPRdec/myCOPRtot; myCOPRdec_prop <- round(myCOPRdec_prop, digits = 2)
# myCOPRdec_prop_le <- myCOPRdec / (myCOPRtot - myCOPRext);  myCOPRdec_prop_le <- round(myCOPRdec_prop_le, digits = 2)
```
